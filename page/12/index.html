<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"louis-me.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":true,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="一个正经的测试工程师">
<meta property="og:type" content="website">
<meta property="og:title" content="施坤的博客">
<meta property="og:url" content="https://louis-me.github.io/page/12/index.html">
<meta property="og:site_name" content="施坤的博客">
<meta property="og:description" content="一个正经的测试工程师">
<meta property="og:locale" content="zh_CN">
<meta property="article:tag" content="自动化测试,安全测试,性能测试,渗透测试,大数据测试,python,jmeter,airtest,appium,monkey">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://louis-me.github.io/page/12/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>施坤的博客 </title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">施坤的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-简历">

    <a href="/resume/" rel="section"><i class="fa fa-address-card fa-fw"></i>简历</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
  
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://louis-me.github.io/aposts/5a751e2b/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="一个正经的测试工程师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="施坤的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/aposts/5a751e2b/" class="post-title-link" itemprop="url">airtest多机并行设计解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-21 11:38:57" itemprop="dateCreated datePublished" datetime="2022-01-21T11:38:57+08:00">2022-01-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-25 11:20:56" itemprop="dateModified" datetime="2022-02-25T11:20:56+08:00">2022-02-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/" itemprop="url" rel="index"><span itemprop="name">自动化测试</span></a>
                </span>
            </span>

          
            <span id="/aposts/5a751e2b/" class="post-meta-item leancloud_visitors" data-flag-title="airtest多机并行设计解析" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/aposts/5a751e2b/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/aposts/5a751e2b/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>前文介绍了<a target="_blank" rel="noopener" href="https://moon-full.gitee.io/2022/01/18/aritest%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1/">aritest自动化测试框架设计</a>，这次分析下如何设计多机并行，本次测试是安卓手机，雷电模拟器和真机，谷歌浏览器</p>
<h2 id="多机安卓"><a href="#多机安卓" class="headerlink" title="多机安卓"></a>多机安卓</h2><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><ul>
<li><p>setting.yml</p>
</li>
<li><p>和前文配置差不多，加了个<code>boot=multi</code></p>
<ul>
<li><p>只要设置此指，就会读取下面的值，里面给不同设备指定了不同模块</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">multi</span>]</span><br><span class="line"><span class="string">test_case</span> <span class="string">=</span> [&#123;<span class="string">&quot;dev&quot;</span><span class="string">:&quot;ZL9LC685V86DNNMN&quot;</span>,<span class="attr">&quot;test_module&quot;:</span> [<span class="string">&quot;我的&quot;</span>],<span class="string">&quot;phone&quot;</span><span class="string">:&quot;真机1&quot;</span>&#125;, &#123;<span class="string">&quot;dev&quot;</span><span class="string">:&quot;emulator-5554&quot;</span>,<span class="string">&quot;test_module&quot;</span><span class="string">:</span>[<span class="string">&quot;他的&quot;</span>],<span class="string">&quot;phone&quot;</span><span class="string">:&quot;雷电&quot;</span>&#125;]</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">default</span>]</span><br><span class="line"><span class="comment"># 包名</span></span><br><span class="line"><span class="string">pkg</span> <span class="string">=</span> <span class="string">com.jianshu.haruki</span></span><br><span class="line"><span class="comment"># 手机名字</span></span><br><span class="line"><span class="string">phone=雷电模拟器</span></span><br><span class="line"><span class="comment"># 设备连接名字</span></span><br><span class="line"><span class="string">dev_connect=Android://127.0.0.1:5037/</span></span><br><span class="line"><span class="comment"># 设备id,adb devices 获取，如果启动多设备，这里无效</span></span><br><span class="line"><span class="string">dev=emulator-5554</span></span><br><span class="line"><span class="comment"># 用例目录</span></span><br><span class="line"><span class="string">root_path=E:\proj\airtest_auto\air_case\android</span></span><br><span class="line"> <span class="comment"># test_plan=1 表示调试用例需要配合test_module使用，0表示全部用例;如果启动多设备,test_plan默认为0,设置1也无效</span></span><br><span class="line"><span class="string">test_plan=1</span></span><br><span class="line"><span class="string">test_module=[&quot;他的&quot;]</span></span><br><span class="line"><span class="comment"># false|true 表示是否运行用例之前，删除log文件夹，删除后会影响查看历史报告</span></span><br><span class="line"><span class="string">remove_log=true</span></span><br><span class="line"><span class="comment"># false|true 是否开启录屏,若传true就会自动录屏，但是在模拟器上录屏失败，只使用于真机</span></span><br><span class="line"><span class="string">recording=false</span></span><br><span class="line"><span class="comment"># android|ios|web，当填如web时，需要填写驱动文件位置</span></span><br><span class="line"><span class="string">platform</span> <span class="string">=android</span></span><br><span class="line"><span class="comment"># driver_path=E:\proj\airtest_auto\exe\chromedriver.exe</span></span><br><span class="line"><span class="string">driver_path=</span></span><br><span class="line"><span class="comment"># 服务器信的信息，比如本地的ip，用来展示报告</span></span><br><span class="line"><span class="string">report_host=172.31.105.196</span></span><br><span class="line"><span class="comment"># 本地服务器路径，我把源代码中的report也放在里面了</span></span><br><span class="line"><span class="string">local_host_path=E:\proj\aritest</span></span><br><span class="line"><span class="comment"># 本地服务器端口</span></span><br><span class="line"><span class="string">local_host_port=8000</span></span><br><span class="line"><span class="comment"># 启动什么模式，单机和多机</span></span><br><span class="line"><span class="comment"># 如果指定multi就是多机并行，读取multi的配置，否则就为单机模式</span></span><br><span class="line"><span class="string">boot=multi</span></span><br><span class="line">[<span class="string">multi</span>]</span><br><span class="line"><span class="comment"># 给不同的设备分配测试模块,dev中的设备id一定要填对</span></span><br><span class="line"><span class="string">test_case</span> <span class="string">=</span> [&#123;<span class="string">&quot;dev&quot;</span><span class="string">:&quot;ZL9LC685V86DNNMN&quot;</span>,<span class="attr">&quot;test_module&quot;:</span> [<span class="string">&quot;我的&quot;</span>],<span class="string">&quot;phone&quot;</span><span class="string">:&quot;真机1&quot;</span>&#125;, &#123;<span class="string">&quot;dev&quot;</span><span class="string">:&quot;emulator-5554&quot;</span>,<span class="string">&quot;test_module&quot;</span><span class="string">:</span>[<span class="string">&quot;他的&quot;</span>],<span class="string">&quot;phone&quot;</span><span class="string">:&quot;雷电&quot;</span>&#125;]</span><br><span class="line"><span class="comment">#test_case = [&#123;&quot;dev&quot;:&quot;emulator-5554&quot;,&quot;test_module&quot;:[&quot;他的&quot;],&quot;phone&quot;:&quot;雷电&quot;&#125;]</span></span><br></pre></td></tr></table></figure>

<h3 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h3><p>使用 <code>pool = Pool() pool.map(self.run_case1, data[&quot;test_case&quot;])</code>达到多进程并行设备</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## runner3.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动入口代码，和之前单机一样，读取配置文件</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_case</span>(<span class="params">data</span>):</span><br><span class="line">  	...</span><br><span class="line">    test = CustomAirtestCase(data[<span class="string">&quot;root_path&quot;</span>], data[<span class="string">&quot;dev_connect&quot;</span>])</span><br><span class="line">    test.run_air(data)</span><br><span class="line"></span><br><span class="line"> <span class="keyword">def</span> <span class="title function_">run_air</span>(<span class="params">self, data</span>):</span><br><span class="line">        self.recording = data[<span class="string">&quot;recording&quot;</span>]</span><br><span class="line">        self.report_host = <span class="string">&quot;http://&quot;</span> + data[<span class="string">&quot;report_host&quot;</span>] + <span class="string">&quot;:&quot;</span> + data[<span class="string">&quot;local_host_port&quot;</span>]</span><br><span class="line">        <span class="comment"># 开启本地http服务器</span></span><br><span class="line">        threading.Thread(target=HttpServer.start, args=(),</span><br><span class="line">                         kwargs=&#123;<span class="string">&quot;local_host_path&quot;</span>: data[<span class="string">&quot;local_host_path&quot;</span>], <span class="string">&quot;report_host&quot;</span>: data[<span class="string">&quot;report_host&quot;</span>],<span class="string">&quot;port&quot;</span>: data[<span class="string">&quot;local_host_port&quot;</span>]&#125;).start()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 整个用例开始执行时间</span></span><br><span class="line">        start_time = datetime.now().strftime(<span class="string">&quot;%H:%M:%S&quot;</span>)</span><br><span class="line">        pool = Pool()</span><br><span class="line">        pool.<span class="built_in">map</span>(self.run_case1, data[<span class="string">&quot;test_case&quot;</span>])</span><br><span class="line">      	...</span><br><span class="line">        <span class="comment"># 记录数据采用放到json文件中</span></span><br><span class="line">        test_modules_dev = Runner3Common.get_case_module_dev(PATH(<span class="string">&quot;config/case_data.json&quot;</span>))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;==设备=%s&quot;</span> % test_modules_dev)</span><br><span class="line">        Runner3Common.set_result_summary_json(&#123;<span class="string">&quot;total_time&quot;</span>: total_time, <span class="string">&quot;phone&quot;</span>: test_modules_dev[<span class="string">&quot;test_dev&quot;</span>], <span class="string">&quot;modules&quot;</span>: test_modules_dev[<span class="string">&quot;test_modules&quot;</span>]&#125;)</span><br><span class="line">      </span><br><span class="line"><span class="comment"># 不同的手机执行不同模块用例</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_case1</span>(<span class="params">self, data_item</span>):</span><br><span class="line">    _dev = data_item[<span class="string">&quot;dev&quot;</span>]</span><br><span class="line">    <span class="comment"># 记录测试设备</span></span><br><span class="line">    Runner3Common.set_case_module_dev(&#123;<span class="string">&quot;test_dev&quot;</span>: _dev&#125;)</span><br><span class="line">    <span class="comment"># 记录测试模块</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> data_item[<span class="string">&quot;test_module&quot;</span>]:</span><br><span class="line">        <span class="comment"># 获取到用例列表</span></span><br><span class="line">        get_case_data = Runner3Common.get_cases(data_item, _dev, self.root_path)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> get_case_data:</span><br><span class="line">            air_device = [self.dev_connect + _dev]  <span class="comment"># 取设备</span></span><br><span class="line">            <span class="comment"># 执行用例</span></span><br><span class="line">            run(root_dir=self.root_path, test_case=i, device=air_device, local_host_path=self.local_host_path,log_date=self.log_date,</span><br><span class="line">                recording=self.recording, report_host=self.report_host, phone=data_item[<span class="string">&quot;phone&quot;</span>])</span><br><span class="line">     </span><br><span class="line"><span class="comment"># 执行用例这里代码和单机的代码相差不多，把 rpt = report.LogToHtml这里生成日志文件代码写在了这里</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">root_dir, test_case, device, local_host_path, log_date, recording, report_host, phone</span>):</span><br><span class="line">    script = os.path.join(root_dir, test_case[<span class="string">&quot;module&quot;</span>], test_case[<span class="string">&quot;case&quot;</span>])</span><br><span class="line">    log_host_path = os.path.join(test_case[<span class="string">&quot;module&quot;</span>], test_case[<span class="string">&quot;case&quot;</span>].replace(<span class="string">&#x27;.air&#x27;</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">    log = os.path.join(local_host_path, log_host_path)</span><br><span class="line">    os.makedirs(log)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">str</span>(log) + <span class="string">&#x27; 创建日志文件成功&#x27;</span>)</span><br><span class="line">    output_file = os.path.join(log, <span class="string">&#x27;log.html&#x27;</span>)</span><br><span class="line">    args = Namespace(device=device, log=log, compress=<span class="literal">None</span>, recording=recording, script=script, no_image=<span class="literal">None</span>)</span><br><span class="line">    <span class="comment"># 用例开始执行日期</span></span><br><span class="line">    st_date = datetime.now().strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)</span><br><span class="line">    <span class="comment"># 用例开始执行时间</span></span><br><span class="line">    s_time = datetime.now().strftime(<span class="string">&quot;%H:%M:%S&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        run_script(args, AirtestCase)</span><br><span class="line">        is_success = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        is_success = <span class="literal">False</span></span><br><span class="line">    end_date = datetime.now().strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)</span><br><span class="line">    <span class="comment"># 用例结束执行时间</span></span><br><span class="line">    e_time = datetime.now().strftime(<span class="string">&quot;%H:%M:%S&quot;</span>)</span><br><span class="line">    <span class="comment"># 用例耗时时间</span></span><br><span class="line">    sum_time = get_case_total_time(s_time, e_time)</span><br><span class="line">    <span class="comment"># 生成测试用例的详情报告</span></span><br><span class="line">    rpt = report.LogToHtml(script, log, report_host + <span class="string">&quot;/report&quot;</span>,</span><br><span class="line">                           log_host=report_host + <span class="string">&quot;/log/&quot;</span> + log_date + <span class="string">&quot;/&quot;</span> + log_host_path)</span><br><span class="line"></span><br><span class="line">    rpt.report(<span class="string">&quot;log_template.html&quot;</span>, output_file=output_file)</span><br></pre></td></tr></table></figure>

<h3 id="测试结果"><a href="#测试结果" class="headerlink" title="测试结果"></a>测试结果</h3><p><img src="/aposts/5a751e2b/image-20220121115858698.png" alt="image-20220121115858698"></p>
<ul>
<li>测试结果的列表页面，优化了下页面</li>
</ul>
<p><img src="/aposts/5a751e2b/image-20220124111600060.png" alt="image-20220124111600060"></p>
<p><img src="/aposts/5a751e2b/image-20220121120048939.png" alt="image-20220121120048939"></p>
<h3 id="关键字驱动"><a href="#关键字驱动" class="headerlink" title="关键字驱动"></a>关键字驱动</h3><ul>
<li>airtest中也能实现关键字驱动？当然也可以</li>
<li>用例调用逻辑</li>
</ul>
<p><img src="/aposts/5a751e2b/image-20220124112127781.png" alt="image-20220124112127781"></p>
<ul>
<li>yml中的用例格式</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">poco(text=&quot;取消&quot;).click()</span> <span class="string">if</span> <span class="string">poco(text=&quot;取消&quot;).exists()</span> <span class="string">else</span> <span class="string">print(&quot;&quot;)</span></span><br><span class="line"><span class="comment"># 点击我的关注</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">poco(&quot;com.jianshu.haruki:id/tv_guanzhu&quot;).click()</span></span><br><span class="line"><span class="comment"># 点击动态下最近更新的作者第一条数据</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">poco(&quot;com.jianshu.haruki:id/userIcon&quot;).click()</span></span><br></pre></td></tr></table></figure>

<ul>
<li>解析yml中的用例，知道此逻辑后，可以定义任意关键字</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">operate_test_case</span>(<span class="params">poco, yml</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    读取yml用例文件,执行用例</span></span><br><span class="line"><span class="string">    :param poco:</span></span><br><span class="line"><span class="string">    :param yml:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    handing_error(poco)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(yml, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        d = yaml.safe_load(f)</span><br><span class="line">    <span class="comment"># 启动应用后的容错</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> d:</span><br><span class="line">        <span class="comment"># 寻找关键字click</span></span><br><span class="line">        event_click = i.split(<span class="string">&quot;.click()&quot;</span>)</span><br><span class="line">        <span class="comment"># 寻找关键字if</span></span><br><span class="line">        event_if = i.split(<span class="string">&quot;if&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;元素为：%s&quot;</span> % i)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;操作元素开始时间：%s&quot;</span> % datetime.now().strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>))</span><br><span class="line">        <span class="comment"># 非if语句的click事件</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(event_click) &gt; <span class="number">1</span> <span class="keyword">and</span> <span class="built_in">len</span>(event_if) == <span class="number">1</span>:</span><br><span class="line">            <span class="comment"># 利用eval把字符串转换为函数,每次点击之前智能等待</span></span><br><span class="line">            <span class="built_in">eval</span>(event_click[<span class="number">0</span>] + <span class="string">&quot;.wait_for_appearance(5)&quot;</span>)</span><br><span class="line">            <span class="comment"># 执行用例</span></span><br><span class="line">            <span class="built_in">eval</span>(i)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 其他的poco事件</span></span><br><span class="line">            sleep(<span class="number">2</span>)</span><br><span class="line">            <span class="built_in">eval</span>(i)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;操作元素结束时间：%s&quot;</span> % datetime.now().strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 操作元素后的容错</span></span><br><span class="line">        handing_error(poco)</span><br></pre></td></tr></table></figure>

<ul>
<li>如果有写逻辑比较复杂，不适合写到yml中，可以混合使用，比如下面这样写用例：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">operate</span>():</span><br><span class="line">    poco = AndroidUiautomationPoco(use_airtest_input=<span class="literal">True</span>, screenshot_each_action=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 初始化用例</span></span><br><span class="line">        init_app()</span><br><span class="line">        poco(text=<span class="string">&quot;取消&quot;</span>).click() <span class="keyword">if</span> poco(text=<span class="string">&quot;取消&quot;</span>).exists() <span class="keyword">else</span> <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">         </span><br><span class="line">        </span><br><span class="line">        case_path = os.path.join(path, <span class="string">&quot;yml&quot;</span>, <span class="string">&quot;xxx&quot;</span>)</span><br><span class="line">        operate_test_case(poco, case_path)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 点击我的</span></span><br><span class="line">        poco(<span class="string">&quot;com.jianshu.haruki:id/tv_more_menu&quot;</span>).wait(<span class="number">5</span>).click()</span><br><span class="line">        <span class="comment"># 点击我的文章</span></span><br><span class="line">        poco(text=<span class="string">&quot;我的文章&quot;</span>).wait(<span class="number">5</span>).click()</span><br><span class="line">        <span class="comment"># 向上滑动</span></span><br><span class="line">        poco(<span class="string">&quot;com.jianshu.haruki:id/refresh_view&quot;</span>).focus([<span class="number">0.5</span>, <span class="number">0.5</span>]).swipe([<span class="number">0.5</span>, -<span class="number">0.5</span>])</span><br><span class="line">        </span><br><span class="line">        case_path = os.path.join(path, <span class="string">&quot;yml&quot;</span>, <span class="string">&quot;oooo&quot;</span>)</span><br><span class="line">        operate_test_case(poco, case_path)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        snapshot(msg=<span class="string">&quot;报错后截图&quot;</span>)</span><br><span class="line">        <span class="keyword">raise</span> e</span><br></pre></td></tr></table></figure>

<h2 id="多机web"><a href="#多机web" class="headerlink" title="多机web"></a>多机web</h2><ul>
<li>代码逻辑几乎一样，只是把Namespace方法中的devicec传为None</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">if</span> device == <span class="string">&quot;web&quot;</span>:</span><br><span class="line">       air_device = <span class="literal">None</span></span><br><span class="line">   <span class="keyword">else</span>:</span><br><span class="line">       air_device = [dev_connect + device] </span><br><span class="line">...</span><br><span class="line">   args = Namespace(device=air_device, log=log, compress=<span class="literal">None</span>, recording=recording, script=script, no_image=<span class="literal">None</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>配置文件略有不同</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># setting1.yaml</span><br><span class="line">[default]</span><br><span class="line"># 手机名字</span><br><span class="line">phone=谷歌浏览器</span><br><span class="line"></span><br><span class="line"># android|ios|web，当填如web时，需要填写驱动文件位置</span><br><span class="line">platform =web</span><br><span class="line">driver_path=E:\proj\airtest_auto\util\chromedriver.exe</span><br><span class="line"></span><br><span class="line">[multi]</span><br><span class="line"># 如果是web测试，dev一定要填web</span><br><span class="line">test_case = [&#123;&quot;dev&quot;:&quot;web&quot;,&quot;test_module&quot;: [&quot;home&quot;],&quot;phone&quot;:&quot;谷歌浏览器1&quot;&#125;, &#123;&quot;dev&quot;:&quot;web&quot;,&quot;test_module&quot;:[&quot;home2&quot;],&quot;phone&quot;:&quot;谷歌浏览器2&quot;&#125;]</span><br></pre></td></tr></table></figure>

<ul>
<li>用例编写</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- encoding=utf8 -*-</span></span><br><span class="line"><span class="keyword">from</span> airtest.core.api <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="comment"># pip3 install pynput</span></span><br><span class="line"><span class="comment"># pip3 install airtest-selenium</span></span><br><span class="line"><span class="comment"># 得到绝对路径</span></span><br><span class="line"></span><br><span class="line">abs_path = os.path.abspath(os.path.dirname(__file__))</span><br><span class="line"><span class="comment"># 得到公共用例目录</span></span><br><span class="line">common_path = os.path.join(abs_path.split(<span class="string">&quot;airtest_auto&quot;</span>)[<span class="number">0</span>], <span class="string">&quot;airtest_auto&quot;</span>, <span class="string">&quot;web_util&quot;</span>)</span><br><span class="line">sys.path.append(common_path)</span><br><span class="line"><span class="keyword">from</span> web_util <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">driver = get_driver()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    driver.get(<span class="string">&quot;http://www.baidu.com&quot;</span>)</span><br><span class="line">    driver.find_element_by_id(<span class="string">&quot;kw&quot;</span>).send_keys(<span class="string">&quot;test&quot;</span>)</span><br><span class="line">    driver.find_element_by_id(<span class="string">&quot;su&quot;</span>).click()</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    snapshot(msg=<span class="string">&quot;报错后截图&quot;</span>)</span><br><span class="line">    <span class="keyword">raise</span> e</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    driver.close()</span><br></pre></td></tr></table></figure>

<ul>
<li>测试结果</li>
</ul>
<p><img src="/aposts/5a751e2b/image-20220124173817575.png" alt="image-20220124173817575"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>还有一种最优方案是，后台有个监控任务，不停的读取用例队列，每台手机运行20条用例（可设置）多台并行，手机(设备)不够就等待，手机有空闲后，分配用例队列中的用例，直到用例全部分配完毕。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://louis-me.github.io/aposts/6e64669e/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="一个正经的测试工程师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="施坤的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/aposts/6e64669e/" class="post-title-link" itemprop="url">aritest自动化测试框架设计</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-18 15:16:03" itemprop="dateCreated datePublished" datetime="2022-01-18T15:16:03+08:00">2022-01-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-25 11:20:56" itemprop="dateModified" datetime="2022-02-25T11:20:56+08:00">2022-02-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/" itemprop="url" rel="index"><span itemprop="name">自动化测试</span></a>
                </span>
            </span>

          
            <span id="/aposts/6e64669e/" class="post-meta-item leancloud_visitors" data-flag-title="aritest自动化测试框架设计" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/aposts/6e64669e/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/aposts/6e64669e/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><ul>
<li>基于Airtest设计的自动化测试框架</li>
</ul>
<h2 id="环境设置"><a href="#环境设置" class="headerlink" title="环境设置"></a>环境设置</h2><ul>
<li>AirtestIDE-win-1.2.13 请自行安装，用来调试用例</li>
<li>此次装的python版本为 3.7.9</li>
<li>本地电脑的adb设置为AirtestIDE中的路径</li>
</ul>
<p><img src="/aposts/6e64669e/image-20220118152720452.png" alt="image-20220118152720452"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Admin&gt;adb</span><br><span class="line">Android Debug Bridge version 1.0.40</span><br><span class="line">Version 4986621</span><br><span class="line">Installed as E:\exe\AirtestIDE\airtest\core\android\static\adb\windows\adb.exe</span><br></pre></td></tr></table></figure>

<ul>
<li>安装依赖文件</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install -U airtest</span><br><span class="line">pip install -U pocoui</span><br></pre></td></tr></table></figure>

<ul>
<li>本次测试机器使用雷电模拟器，真机也可以</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Admin&gt;adb devices</span><br><span class="line">List of devices attached</span><br><span class="line">emulator-5554   device</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>安装测试apk文件</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;adb install -g -r C:\Users\Admin\Downloads\com.jianshu.haruki_6.4.4_liqucn.com.apk</span><br></pre></td></tr></table></figure>

<ul>
<li>在模拟器中打开手动登录</li>
<li>复制python环境中的Lib目录的airtest下的report文件到新建文件夹下面（E:\proj\aritest）<ul>
<li>放生成的测试报告和日志文件，默认放到项目中，对项目管理非常不友好</li>
</ul>
</li>
</ul>
<p><img src="/aposts/6e64669e/image-20220118164513042.png" alt="image-20220118164513042"></p>
<ul>
<li>然后新建一个log文件，用来放测试用例报告的</li>
</ul>
<p><img src="/aposts/6e64669e/image-20220118164740800.png" alt="image-20220118164740800"></p>
<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><h3 id="启动器"><a href="#启动器" class="headerlink" title="启动器"></a>启动器</h3><ul>
<li><p>启动器代码做到和用例文件分离，现在启动器支撑ios(待测试)，android（已测试），web（待测试），理论上airtest支持的都支持</p>
</li>
<li><p>启动器需要取配置文件进行，配置文件如下</p>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">default</span>]</span><br><span class="line"><span class="comment"># 包名</span></span><br><span class="line"><span class="string">pkg</span> <span class="string">=</span> <span class="string">com.jianshu.haruki</span></span><br><span class="line"><span class="comment"># 手机名字</span></span><br><span class="line"><span class="string">phone=雷电模拟器</span></span><br><span class="line"><span class="comment"># 设备连接名字</span></span><br><span class="line"><span class="string">dev_connect=Android://127.0.0.1:5037/emulator-5554</span></span><br><span class="line"><span class="comment">#dev_connect=Android://127.0.0.1:5037/ZL9LC685V86DNNMN</span></span><br><span class="line"><span class="comment"># 用例目录</span></span><br><span class="line"><span class="string">root_path=E:\proj\airtest_auto\air_case\android</span></span><br><span class="line"> <span class="comment"># test_plan=1 表示调试用例需要配合test_module使用，0表示全部用例</span></span><br><span class="line"><span class="string">test_plan=1</span></span><br><span class="line"><span class="string">test_module=[&quot;我的&quot;]</span></span><br><span class="line"><span class="comment"># false|true 表示是否运行用例之前，删除log文件夹，删除后会影响查看历史报告</span></span><br><span class="line"><span class="string">remove_log=true</span></span><br><span class="line"><span class="comment"># false|true 是否开启录屏,若传true就会自动录屏，但是在模拟器上录屏失败，只使用于真机</span></span><br><span class="line"><span class="string">recording=false</span></span><br><span class="line"><span class="comment"># android|ios|web，当填如web时，需要填写驱动文件位置</span></span><br><span class="line"><span class="string">platform</span> <span class="string">=android</span></span><br><span class="line"><span class="comment"># driver_path=E:\proj\airtest_auto\exe\chromedriver.exe</span></span><br><span class="line"><span class="string">driver_path=</span></span><br><span class="line"><span class="comment"># 服务器信的信息，比如本地的http服务器，用来展示报告</span></span><br><span class="line"><span class="string">report_host=http://172.31.105.196:8000</span></span><br><span class="line"><span class="comment"># 本地服务器路径，我把源代码中的report也放在里面了</span></span><br><span class="line"><span class="string">local_host_path=E:\proj\aritest</span></span><br><span class="line"><span class="comment"># 本地服务器端口</span></span><br><span class="line"><span class="string">local_host_port=8000</span></span><br><span class="line">[<span class="string">mail</span>]</span><br><span class="line"><span class="comment"># 是否启动发送邮件,传false|true</span></span><br><span class="line"><span class="string">enable</span> <span class="string">=false</span></span><br><span class="line"><span class="comment"># 收件人</span></span><br><span class="line"><span class="string">recipient</span> <span class="string">=[&quot;284772894@qq.com&quot;,&quot;284772895@qq.com&quot;]</span></span><br><span class="line"><span class="comment"># 发件人smtp</span></span><br><span class="line"><span class="string">mail_host</span> <span class="string">=</span> <span class="string">smtp.126.com</span></span><br><span class="line"><span class="comment"># 发件人</span></span><br><span class="line"><span class="string">mail_user</span> <span class="string">=</span> <span class="string">ashikun@126.com</span></span><br><span class="line"><span class="comment"># 授权码</span></span><br><span class="line"><span class="string">mail_pass</span> <span class="string">=</span> <span class="string">XXXXX</span></span><br><span class="line"><span class="string">port</span> <span class="string">=</span> <span class="number">465</span></span><br></pre></td></tr></table></figure>

<ul>
<li>启动器代码分析</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 读取配置文件，进行运行函数</span></span><br><span class="line">PATH = <span class="keyword">lambda</span> p: os.path.abspath(</span><br><span class="line">    os.path.join(os.path.dirname(__file__), p)</span><br><span class="line">)</span><br><span class="line">path = PATH(<span class="string">&quot;config/setting1.ini&quot;</span>)</span><br><span class="line">data = ReadIni(path).get_ini_list()</span><br><span class="line">run_case(data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_case</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="comment"># 当平台为安卓时，检查是否连接成功</span></span><br><span class="line">    <span class="keyword">if</span> data.get(<span class="string">&quot;platform&quot;</span>, <span class="string">&quot;1&quot;</span>) == <span class="string">&quot;android&quot;</span>:</span><br><span class="line">        devices = attached_devices()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> devices:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;无可用设备&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">elif</span> data.get(<span class="string">&quot;platform&quot;</span>, <span class="string">&quot;1&quot;</span>) == <span class="string">&quot;ios&quot;</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">elif</span> data.get(<span class="string">&quot;platform&quot;</span>, <span class="string">&quot;1&quot;</span>) == <span class="string">&quot;web&quot;</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    test = CustomAirtestCase(data[<span class="string">&quot;root_path&quot;</span>])</span><br><span class="line">    device = [data[<span class="string">&quot;dev_connect&quot;</span>]]</span><br><span class="line">    test.run_air(device, data)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_air</span>(<span class="params">self, device, data</span>):</span><br><span class="line">    get_data_list = get_test_case(data)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> get_data_list:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;无可用用例&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="comment"># 开启本地http服务器</span></span><br><span class="line">    HttpServer.start(data[<span class="string">&quot;local_host_path&quot;</span>], data[<span class="string">&quot;local_host_port&quot;</span>])</span><br><span class="line">	<span class="comment"># 循环执行用例</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> get_data_list:</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment"># 执行用例</span></span><br><span class="line">        get_run = run(data[<span class="string">&quot;root_path&quot;</span>], j, device, local_host_path, data[<span class="string">&quot;recording&quot;</span>])</span><br><span class="line">        </span><br><span class="line">        ..</span><br><span class="line">         <span class="comment"># 生成测试用例的详情报告,注意这里修改了lib目录下的report.py中源代码，主要为了达到通过服务器ip访问测试报告</span></span><br><span class="line">       rpt = report.LogToHtml(get_run[<span class="string">&quot;script&quot;</span>], get_run[<span class="string">&quot;log&quot;</span>], data[<span class="string">&quot;report_host&quot;</span>]+<span class="string">&quot;/report&quot;</span>, log_host=</span><br><span class="line">                              data[<span class="string">&quot;report_host&quot;</span>] + <span class="string">&quot;/log/&quot;</span> + log_date + <span class="string">&quot;/&quot;</span> + get_run[<span class="string">&quot;log_host_path&quot;</span>])</span><br><span class="line">      rpt.report(<span class="string">&quot;log_template.html&quot;</span>, output_file=get_run[<span class="string">&quot;output_file&quot;</span>])</span><br><span class="line">      <span class="comment"># self。results主要记录测试用例结果，通过解析summary_template.html生成测试报告</span></span><br><span class="line">      result = &#123;<span class="string">&quot;result&quot;</span>: get_run[<span class="string">&quot;is_success&quot;</span>], <span class="string">&quot;start_date&quot;</span>: st_date,<span class="string">&quot;end_date&quot;</span>: end_date, <span class="string">&quot;sum_time&quot;</span>: sum_time,<span class="string">&quot;log&quot;</span>: s_log, <span class="string">&quot;name&quot;</span>: s_name&#125;</span><br><span class="line">        modules.append(j[<span class="string">&quot;module&quot;</span>])</span><br><span class="line">        self.results[<span class="string">&quot;data&quot;</span>].append(result)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>from airtest.report import report</code> 里面的report.py文件修改，实际文件目录如图：</li>
</ul>
<p><img src="/aposts/6e64669e/image-20220120112555007.png" alt="image-20220120112555007"></p>
<ul>
<li>report.py文件修改</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LogToHtml</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    scale = <span class="number">0.5</span></span><br><span class="line">    <span class="comment"># 这里的log_host是我新增的日志文件服务器地址，这样新增一个字段，不影响到其他代码逻辑</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, script_root, log_root=<span class="string">&quot;&quot;</span>, static_root=<span class="string">&quot;&quot;</span>, export_dir=<span class="literal">None</span>, script_name=<span class="string">&quot;&quot;</span>, logfile=<span class="literal">None</span>, lang=<span class="string">&quot;en&quot;</span>, plugins=<span class="literal">None</span>, log_host=<span class="literal">None</span></span>):</span><br><span class="line">        ...</span><br><span class="line">      self.log_host = log_host <span class="comment"># shikun 2022-1-19</span></span><br><span class="line">    </span><br><span class="line"> <span class="comment"># 这个函数，主要生成log.html文件中的图片展示</span></span><br><span class="line"> <span class="keyword">def</span> <span class="title function_">_translate_screen</span>(<span class="params">self, step, code</span>):</span><br><span class="line">        ...</span><br><span class="line">          <span class="keyword">for</span> item <span class="keyword">in</span> step[<span class="string">&quot;__children__&quot;</span>]:</span><br><span class="line">            <span class="keyword">if</span> item[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;name&quot;</span>] == <span class="string">&quot;try_log_screen&quot;</span>:</span><br><span class="line">                snapshot = item[<span class="string">&quot;data&quot;</span>].get(<span class="string">&quot;ret&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">isinstance</span>(snapshot, six.text_type):</span><br><span class="line">                    src = snapshot</span><br><span class="line">                <span class="keyword">elif</span> <span class="built_in">isinstance</span>(snapshot, <span class="built_in">dict</span>):</span><br><span class="line">                    src = snapshot[<span class="string">&#x27;screen&#x27;</span>]</span><br><span class="line">                    screen[<span class="string">&#x27;resolution&#x27;</span>] = snapshot[<span class="string">&#x27;resolution&#x27;</span>]</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">if</span> self.export_dir:  <span class="comment"># all relative path</span></span><br><span class="line">                    screen[<span class="string">&#x27;_filepath&#x27;</span>] = os.path.join(DEFAULT_LOG_DIR, src)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    screen[<span class="string">&#x27;_filepath&#x27;</span>] = os.path.abspath(os.path.join(self.log_root, src))</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 修改了这里逻辑， screen[&#x27;src&#x27;]展示的图片路径就Log.html中img src中的路径</span></span><br><span class="line">                <span class="keyword">if</span> self.log_host:</span><br><span class="line">                    screen[<span class="string">&#x27;_filepath&#x27;</span>] = self.log_host + <span class="string">&quot;/&quot;</span> + src</span><br><span class="line">                screen[<span class="string">&#x27;src&#x27;</span>] = screen[<span class="string">&#x27;_filepath&#x27;</span>]</span><br><span class="line"> <span class="comment"># 根据模板文件生成测试报告，这里主要对视频文件路径进行处理  </span></span><br><span class="line"> <span class="keyword">def</span> <span class="title function_">report</span>(<span class="params">self, template_name=HTML_TPL, output_file=HTML_FILE, record_list=<span class="literal">None</span></span>):</span><br><span class="line">       ....</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> record_list:</span><br><span class="line">            record_list = [f <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(self.log_root) <span class="keyword">if</span> f.endswith(<span class="string">&quot;.mp4&quot;</span>)]</span><br><span class="line">        <span class="comment"># 源代码时这样，我多加了个log_host</span></span><br><span class="line">        <span class="comment"># data = self.report_data(output_file=output_file, record_list=record_list)</span></span><br><span class="line">        <span class="comment"># shikun-2121-1-19</span></span><br><span class="line">        data = self.report_data(output_file=output_file, record_list=record_list, log_host=self.log_host)</span><br><span class="line">        </span><br><span class="line">   <span class="comment"># log_host 为我新增</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">report_data</span>(<span class="params">self, output_file=<span class="literal">None</span>, record_list=<span class="literal">None</span>, log_host=<span class="literal">None</span></span>):</span><br><span class="line">	...</span><br><span class="line">       <span class="keyword">if</span> record_list:</span><br><span class="line">            records = [os.path.join(DEFAULT_LOG_DIR, f) <span class="keyword">if</span> self.export_dir</span><br><span class="line">                       <span class="keyword">else</span> os.path.abspath(os.path.join(self.log_root, f)) <span class="keyword">for</span> f <span class="keyword">in</span> record_list]</span><br><span class="line">            <span class="comment"># 对视频路径进行处理</span></span><br><span class="line">            <span class="keyword">if</span> log_host:</span><br><span class="line">                records = []</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> record_list:</span><br><span class="line">                    records.append(log_host + <span class="string">&quot;/&quot;</span> + i)</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<ul>
<li>运行runner5.py</li>
</ul>
<p><img src="/aposts/6e64669e/image-20220120113714163.png" alt="image-20220120113714163"></p>
<ul>
<li>通过http服务查看运行结果</li>
</ul>
<p><img src="/aposts/6e64669e/image-20220120113910981.png" alt="image-20220120113910981"></p>
<p><img src="/aposts/6e64669e/image-20220120113940586.png" alt="image-20220120113940586"></p>
<p><img src="/aposts/6e64669e/image-20220120114713093.png" alt="image-20220120114713093"></p>
<ul>
<li>实际上http服务，定位到的就是在配置文件中的：local_host_path&#x3D;E:\proj\aritest</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">E:\<span class="title">proj</span>\<span class="title">aritest</span>&gt;<span class="title">dir</span> <span class="title">log</span>\2022-01-20-10-56-21</span></span><br><span class="line"><span class="function"> 驱动器 <span class="title">E</span> 中的卷是 软件盘</span></span><br><span class="line"><span class="function"> 卷的序列号是 240<span class="title">F</span>-1787</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"> <span class="title">E</span>:\<span class="title">proj</span>\<span class="title">aritest</span>\<span class="title">log</span>\2022-01-20-10-56-21 的目录</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">2022/01/20  10:58    &lt;<span class="title">DIR</span>&gt;          .</span></span><br><span class="line"><span class="function">2022/01/20  10:58    &lt;<span class="title">DIR</span>&gt;          ..</span></span><br><span class="line"><span class="function">2022/01/20  10:58             2,803 <span class="title">summary_2022</span>-01-20-10-58-33.<span class="title">html</span></span></span><br><span class="line"><span class="function">2022/01/20  10:58             1,568 <span class="title">summary_template.html</span></span></span><br><span class="line"><span class="function">2022/01/20  10:57    &lt;<span class="title">DIR</span>&gt;          他的</span></span><br><span class="line"><span class="function">2022/01/20  10:57    &lt;<span class="title">DIR</span>&gt;          我的</span></span><br><span class="line"><span class="function">               2 个文件          4,371 字节</span></span><br><span class="line"><span class="function">               4 个目录 19,213,107,200 可用字节</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">E</span>:\<span class="title">proj</span>\<span class="title">aritest</span>&gt;<span class="title">dir</span> <span class="title">report</span></span></span><br><span class="line"><span class="function"> 驱动器 <span class="title">E</span> 中的卷是 软件盘</span></span><br><span class="line"><span class="function"> 卷的序列号是 240<span class="title">F</span>-1787</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"> <span class="title">E</span>:\<span class="title">proj</span>\<span class="title">aritest</span>\<span class="title">report</span> 的目录</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">2022/01/18  16:43    &lt;<span class="title">DIR</span>&gt;          .</span></span><br><span class="line"><span class="function">2022/01/18  16:43    &lt;<span class="title">DIR</span>&gt;          ..</span></span><br><span class="line"><span class="function">2022/01/18  16:42    &lt;<span class="title">DIR</span>&gt;          <span class="title">css</span></span></span><br><span class="line"><span class="function">2022/01/18  16:42    &lt;<span class="title">DIR</span>&gt;          <span class="title">fonts</span></span></span><br><span class="line"><span class="function">2022/01/18  16:42    &lt;<span class="title">DIR</span>&gt;          <span class="title">image</span></span></span><br><span class="line"><span class="function">2022/01/18  16:42    &lt;<span class="title">DIR</span>&gt;          <span class="title">js</span></span></span><br><span class="line"><span class="function">2021/05/21  10:28            10,634 <span class="title">log_template.html</span></span></span><br><span class="line"><span class="function">2021/08/16  10:43            21,860 <span class="title">report.py</span></span></span><br><span class="line"><span class="function">2021/06/23  16:53            22,405 <span class="title">test.py</span></span></span><br><span class="line"><span class="function">2018/08/28  11:39                 0 <span class="title">__init__.py</span></span></span><br><span class="line"><span class="function">               4 个文件         54,899 字节</span></span><br><span class="line"><span class="function">               6 个目录 19,213,107,200 可用字节</span></span><br></pre></td></tr></table></figure>

<ul>
<li>修改好的report.py文件已经放在项目跟目录，可以覆盖到各自目录即可</li>
</ul>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ul>
<li><p>查看<a target="_blank" rel="noopener" href="https://github.com/Louis-me/airtest_auto">github源代码</a></p>
</li>
<li><p>查看<a target="_blank" rel="noopener" href="https://gitee.com/moon-full/airtest_auto">gitee源代码</a></p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://louis-me.github.io/aposts/d4ea272f/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="一个正经的测试工程师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="施坤的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/aposts/d4ea272f/" class="post-title-link" itemprop="url">Flink+zk+python+kafka集群实时日志读取</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-04 09:36:40" itemprop="dateCreated datePublished" datetime="2022-01-04T09:36:40+08:00">2022-01-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-25 11:20:56" itemprop="dateModified" datetime="2022-02-25T11:20:56+08:00">2022-02-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">大数据</span></a>
                </span>
            </span>

          
            <span id="/aposts/d4ea272f/" class="post-meta-item leancloud_visitors" data-flag-title="Flink+zk+python+kafka集群实时日志读取" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/aposts/d4ea272f/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/aposts/d4ea272f/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><ul>
<li>本文章主要是学Flink 处理实时数据，使用zk+kafka搭建日志系统，python编写测试代码</li>
<li>本次服务器，采用的腾讯云服务器，使用的centos7 系统</li>
<li>本次的flink采用本地部署的方式，zk+kafka采用伪分布式</li>
</ul>
<h2 id="Flink特点"><a href="#Flink特点" class="headerlink" title="Flink特点"></a>Flink特点</h2><ul>
<li>采用了基于操作符（Operator）的连续流模型，可以做到微秒级别的延迟。Flink最核心的数据结构是Stream，它代表一个运行在多分区上的并行流。在大数据场景中，经常用来对实时要求比较高的操作，比如实时处理。</li>
</ul>
<h3 id="如何选择Spark和Flink"><a href="#如何选择Spark和Flink" class="headerlink" title="如何选择Spark和Flink"></a>如何选择Spark和Flink</h3><ul>
<li><p>对于以下场景，你可以选择 Spark：</p>
<ul>
<li>数据量非常大而且逻辑复杂的批数据处理，并且对计算效率有较高要求（比如用大数据分析来构建推荐系统进行个性化推荐、广告定点投放等）；</li>
<li>基于历史数据的交互式查询，要求响应较快；</li>
<li>基于实时数据流的数据处理，延迟性要求在在数百毫秒到数秒之间。</li>
</ul>
</li>
<li><p>Spark完美满足这些场景的需求，而且它可以一站式解决这些问题，无需用别的数据处理平台。由于Flink是为了提升流处理而创建的平台，所以它适用于各种需要非常低延迟（微秒到毫秒级）的实时数据处理场景，比如实时日志报表分析。<br>而且Flink 用流处理去模拟批处理的思想，比Spark 用批处理去模拟流处理的思想扩展性更好</p>
</li>
<li><p>具体<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_40247263/article/details/97000109">参考</a></p>
</li>
</ul>
<h2 id="环境安装"><a href="#环境安装" class="headerlink" title="环境安装"></a>环境安装</h2><h3 id="java"><a href="#java" class="headerlink" title="java"></a>java</h3><ul>
<li>flink安装的版本现在在官网为最新版本：V1.14.2，对java要求为8或者11</li>
<li>我之前已经搭建好了java刚好为 java8，此步省略</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-24-13-centos ~]# java -version</span><br><span class="line">java version &quot;1.8.0_311&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_311-b11)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.311-b11, mixed mode)</span><br><span class="line">[root@VM-24-13-centos ~]#</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="flink"><a href="#flink" class="headerlink" title="flink"></a>flink</h3><ul>
<li>常见部署模式分为：local本地部署（学习研究环节），集群模式有Standalone Cluster、Flink ON YARN、Mesos，Docker，Kubernetes等</li>
<li><strong>本次采用本地部署</strong>，后续打算用本地三台虚拟机的方式学习（和hadoop一起）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">wget  http://mirrors.aliyun.com/apache/flink/flink-1.14.2/flink-1.14.2-bin-scala_2.11.tgz</span><br><span class="line">tar -zxvf flink-1.14.2-bin-scala_2.11.tgz</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置环境变量</span></span><br><span class="line">vi /etc/profile</span><br><span class="line"></span><br><span class="line">export FLINK_HOME=/usr/local/flink-1.14.2</span><br><span class="line">export PATH=$PATH:$FLINK_HOME/bin</span><br><span class="line"></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>

<ul>
<li>启动flink</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@VM-24-13-centos flink-1.14.2]# ./bin/start-cluster.sh</span><br><span class="line">Starting cluster.</span><br><span class="line">Starting standalonesession daemon on host VM-24-13-centos.</span><br><span class="line">Starting taskexecutor daemon on host VM-24-13-centos.</span><br><span class="line"></span><br><span class="line">[root@VM-24-13-centos flink-1.14.2]# ps -ef | grep flink</span><br><span class="line">root     22422     1  3 17:05 pts/1    00:00:06 /usr/local/jdk1.8.0_311/bin/java                         .../flink-root-standalonesession-0-VM-24-13-c</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>flink一般都是8081端口，需要服务器防火墙打开，然后再腾讯云服务器再单独开启相应端口</li>
</ul>
<p><img src="/aposts/d4ea272f/image-20220104172514390.png" alt="image-20220104172514390"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-24-13-centos flink-1.14.2]# firewall-cmd --zone=public --add-port=8081/tcp --permanent</span><br><span class="line">success</span><br><span class="line">[root@VM-24-13-centos flink-1.14.2]# firewall-cmd --reload</span><br><span class="line">success</span><br></pre></td></tr></table></figure>

<ul>
<li>远程可以访问</li>
</ul>
<p><img src="/aposts/d4ea272f/image-20220104172658930.png" alt="image-20220104172658930"></p>
<h3 id="kafka"><a href="#kafka" class="headerlink" title="kafka"></a>kafka</h3><ul>
<li>一个分布式的、可分区的、可复制的消息中间件系统。kafka依赖于zookeeper</li>
</ul>
<h4 id="Zookeeper"><a href="#Zookeeper" class="headerlink" title="Zookeeper"></a>Zookeeper</h4><ul>
<li>注册中心，主要功能就是对中间件进行<strong>分布式通知&#x2F;协调</strong>，比如对外部需要调用kafka，其实是通过调用zk进行协调访问。</li>
<li><strong>Master选举的方式是核心</strong>，可以看看<a target="_blank" rel="noopener" href="https://blog.csdn.net/lingbo229/article/details/81052078">zookeeper的原理和应用（非常详细透彻）</a>和<a target="_blank" rel="noopener" href="https://www.cnblogs.com/xinyonghu/p/11031729.html">ZooKeeper原理及介绍</a>，我暂时也没完全理解，zk有三个角色：<strong>leader(主)、follower（从）、observer（观察）</strong></li>
<li>安装kafka之前，先安装zk，zk有三种部署方式：本地、伪分布式、完全分布式。<strong>本次打算采用伪分布式</strong></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget http://mirrors.aliyun.com/apache/zookeeper/zookeeper-3.7.0/apache-zookeeper-3.7.0-bin.tar.gz</span><br><span class="line">tar -zxvf apache-zookeeper-3.7.0-bin.tar.gz</span><br><span class="line"></span><br><span class="line">mv apache-zookeeper-3.7.0-bin zookeeper_01</span><br></pre></td></tr></table></figure>

<ul>
<li>复制1份zoo.cfg 配置文件，命名为 zoo.cfg，并做好配置，<strong>注意填入的ip要填入腾讯云的内外ip，之前填入公网ip一直启动失败</strong></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cd zookeeper_01/conf</span><br><span class="line">cp zoo_sample.cfg zoo.cfg</span><br><span class="line">vi zoo.cfg</span><br><span class="line"></span><br><span class="line">dataDir=/usr/local/zookeeper_01/data</span><br><span class="line">clientPort=2181</span><br><span class="line">server.1=ip:2881:3881</span><br><span class="line">server.2=ip:2882:3882</span><br><span class="line">server.3=ip:2883:3883</span><br></pre></td></tr></table></figure>

<ul>
<li>复制zookeeper_01目录伪zookeeper_02，配置zoo.cfg</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local</span><br><span class="line">mv zookeeper_01 zookeeper_02</span><br><span class="line">cd zookeeper_02</span><br><span class="line">vi zoo.cfg</span><br><span class="line"></span><br><span class="line">dataDir=/usr/local/zookeeper_02/data</span><br><span class="line">clientPort=2182</span><br><span class="line">server.1=ip:2881:3881</span><br><span class="line">server.2=ip:2882:3882</span><br><span class="line">server.3=ip:2883:3883</span><br></pre></td></tr></table></figure>

<ul>
<li>复制zookeeper_01目录伪zookeeper_03，配置zoo.cfg</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local</span><br><span class="line">mv zookeeper_01 zookeeper_03</span><br><span class="line">cd zookeeper_03</span><br><span class="line">vi zoo.cfg</span><br><span class="line"></span><br><span class="line">dataDir=/usr/local/zookeeper_03/data</span><br><span class="line">clientPort=2183</span><br><span class="line">server.1=ip:2881:3881</span><br><span class="line">server.2=ip:2882:3882</span><br><span class="line">server.3=ip:2883:3883</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<ul>
<li>修改zookeeper_01中conf目录下zoo.cfg文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dataDir=/usr/local/zookeeper_01/data</span><br><span class="line">clientPort=2181</span><br><span class="line">server.1=ip:2881:3881</span><br><span class="line">server.2=ip:2882:3882</span><br><span class="line">server.3=ip:2883:3883</span><br></pre></td></tr></table></figure>

<ul>
<li>修改zookeeper_02中conf目录下zoo.cfg文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dataDir=/usr/local/zookeeper_02/data</span><br><span class="line">clientPort=2182</span><br><span class="line">server.1=ip:2881:3881</span><br><span class="line">server.2=ip:2882:3882</span><br><span class="line">server.3=ip:2883:3883</span><br></pre></td></tr></table></figure>

<ul>
<li>修改zookeeper_03中conf目录下zoo.cfg文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dataDir=/usr/local/zookeeper_03/data</span><br><span class="line">clientPort=2183</span><br><span class="line">server.1=ip:2881:3881</span><br><span class="line">server.2=ip:2882:3882</span><br><span class="line">server.3=ip:2883:3883</span><br></pre></td></tr></table></figure>

<ul>
<li>分别启动zookeeper_01、zookeeper_02、zookeeper_03</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-24-13-centos zookeeper_01]# bin/zkServer.sh start</span><br><span class="line">[root@VM-24-13-centos zookeeper_01]# ../zookeeper_02/bin/zkServer.sh start</span><br><span class="line">[root@VM-24-13-centos zookeeper_01]# ../zookeeper_03/bin/zkServer.sh start</span><br></pre></td></tr></table></figure>

<ul>
<li>查看有三个<code>QuorumPeerMain</code>进程</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@VM-24-13-centos zookeeper_01]# jps</span><br><span class="line">4674 QuorumPeerMain</span><br><span class="line">2594 NodeManager</span><br><span class="line">2467 ResourceManager</span><br><span class="line">4774 QuorumPeerMain</span><br><span class="line">32550 CMDRunner.jar</span><br><span class="line">22422 StandaloneSessionClusterEntrypoint</span><br><span class="line">30150 SecondaryNameNode</span><br><span class="line">6087 Jps</span><br><span class="line">22698 TaskManagerRunner</span><br><span class="line">29930 DataNode</span><br><span class="line">4589 QuorumPeerMa</span><br></pre></td></tr></table></figure>

<ul>
<li>查看每个zk启动的模式，发现zookeeper_03的model为leader</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@VM-24-13-centos zookeeper_01]# bin/zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/local/zookeeper_01/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost. Client SSL: false.</span><br><span class="line">Mode: follower</span><br><span class="line">[root@VM-24-13-centos zookeeper_01]# ../zookeeper_02/bin/zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/local/zookeeper_02/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2182. Client address: localhost. Client SSL: false.</span><br><span class="line">Mode: follower</span><br><span class="line">[root@VM-24-13-centos zookeeper_01]# ../zookeeper_03/bin/zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/local/zookeeper_03/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2183. Client address: localhost. Client SSL: false.</span><br><span class="line">Mode: leader</span><br></pre></td></tr></table></figure>

<h4 id="kafka介绍"><a href="#kafka介绍" class="headerlink" title="kafka介绍"></a>kafka介绍</h4><ul>
<li>kafka是Apache组织下的一个开源系统，它的最大的特性就是可以实时的处理大量数据以满足各种需求场景：比如基于hadoop平台的数据分析、低时延的实时系统、storm&#x2F;spark流式处理引擎等。kafka现在它已被多家大型公司作为多种类型的数据管道和消息系统使用。</li>
<li>来源于<a target="_blank" rel="noopener" href="https://blog.csdn.net/okhymok/article/details/103506250">这里</a></li>
</ul>
<h4 id="kafka角色"><a href="#kafka角色" class="headerlink" title="kafka角色"></a>kafka角色</h4><table>
<thead>
<tr>
<th>角色</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Broker</td>
<td>Kafka服务器，无论是单台Kafka还是集群，被统一叫做Broker</td>
</tr>
<tr>
<td>Producer</td>
<td>指消息的生产者，负责发布消息到kafka broker</td>
</tr>
<tr>
<td>Consumer</td>
<td>指消息的消费者，从kafka broker拉取数据，并消费这些已发布的消息。Kafka发布消息通常有两种模式：**队列模式（queuing）和发布&#x2F;订阅模式(publish-subscribe)**。在队列模式下，只有一个消费组，而这个消费组有多个消费者，一条消息只能被这个消费组中的一个消费者所消费；而在发布&#x2F;订阅模式下，可有多个消费组，每个消费组只有一个消费者，同一条消息可被多个消费组消费</td>
</tr>
<tr>
<td>Topic</td>
<td>主题，用于建立生产者和消费者之间的订阅关系，生产者将消息发送到指定的Topic，然后消费者再从该Topic下去取消息</td>
</tr>
<tr>
<td>Partition</td>
<td>消息分区，一个Topic下面会有多个Partition，每个Partition都是一个有序队列，Partition中的每条消息都会被分配一个有序的id。</td>
</tr>
<tr>
<td>Consumer Group</td>
<td>消费者组，可以给每个Consumer指定消费组，若不指定消费者组，则属于默认的group</td>
</tr>
<tr>
<td>Message</td>
<td>消息，通信的基本单位，每个producer可以向一个topic发布一些消息。</td>
</tr>
</tbody></table>
<h4 id="kafka工作流程"><a href="#kafka工作流程" class="headerlink" title="kafka工作流程"></a>kafka工作流程</h4><ul>
<li><p>生产者定期向主题发送消息。</p>
</li>
<li><p>Kafka broker将所有消息存储在为该特定主题配置的分区中。它确保消息在分区之间平等共享。如果生产者发送两个消息，并且有两个分区，则Kafka将在第一个分区中存储一个消息，在第二个分区中存储第二个消息。</p>
</li>
<li><p>消费者订阅一个特定的主题。一旦消费者订阅了一个主题，Kafka将向消费者提供该主题的当前偏移量，并将偏移量保存在ZooKeeper中。</p>
</li>
<li><p>消费者将定期请求Kafka新消息。</p>
</li>
<li><p>一旦Kafka收到来自生产者的消息，它会将这些消息转发给消费者。消费者将收到消息并处理它。</p>
</li>
<li><p>一旦消息被处理，消费者将向Kafka broker发送确认。</p>
</li>
<li><p>一旦Kafka收到确认，它会将偏移量更改为新值，并在ZooKeeper中进行更新。由于ZooKeeper中保留了偏移量，因此即使在服务器出现故障时，消费者也可以正确读取下一条消息</p>
</li>
</ul>
<h4 id="kafka拓扑架构"><a href="#kafka拓扑架构" class="headerlink" title="kafka拓扑架构"></a>kafka拓扑架构</h4><ul>
<li>一个典型的Kafka集群包含若干Producer，若干broker、若干Consumer Group，以及一个Zookeeper集群。Kafka通过Zookeeper管理集群配置，选举leader，以及在Consumer Group发生变化时进行rebalance。Producer使用push模式将消息发布到broker，Consumer使用pull模式从broker订阅并消费消息。典型架构如下图所示</li>
</ul>
<p><img src="/aposts/d4ea272f/image-20220107101958730.png" alt="image-20220107101958730"></p>
<h4 id="安装配置kafka"><a href="#安装配置kafka" class="headerlink" title="安装配置kafka"></a>安装配置kafka</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget --no-check-certificate https://dlcdn.apache.org/kafka/3.0.0/kafka_2.12-3.0.0.tgz</span><br><span class="line">tar -zxvf kafka_2.12-3.0.0.tgz</span><br><span class="line">mv kafka_2.12-3.0.0 kafka</span><br><span class="line">cd kafka</span><br></pre></td></tr></table></figure>

<ul>
<li>复制server.properties命名为server1.properties，配置如下</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cd kafka/config</span><br><span class="line">cp server.properties server1.properties</span><br><span class="line">vi server1.properties</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">服务器标识</span></span><br><span class="line">broker.id=1</span><br><span class="line">listeners=PLAINTEXT://10.0.24.13:9091</span><br><span class="line">log.dirs=/usr/kafka/kafka-logs1</span><br><span class="line">zookeeper.connect=10.0.24.13:2181,10.0.24.13:2182,10.0.24.13:2183</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>复制server1.properties命名为server2.properties，配置如下</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cp server.properties1 server2.properties</span><br><span class="line">vi server1.properties</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">服务器标识</span></span><br><span class="line">broker.id=2</span><br><span class="line">listeners=PLAINTEXT://10.0.24.13:9092</span><br><span class="line">log.dirs=/usr/kafka/kafka-logs2</span><br><span class="line">zookeeper.connect=10.0.24.13:2182,10.0.24.13:2182,10.0.24.13:2182</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>复制server1.properties命名为server3.properties，配置如下</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cp server.properties1 server3.properties</span><br><span class="line">vi server3.properties</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">服务器标识</span></span><br><span class="line">broker.id=3</span><br><span class="line">advertised.listeners=PLAINTEXT://10.0.24.13:9093</span><br><span class="line">log.dirs=/usr/kafka/kafka-logs3</span><br><span class="line">zookeeper.connect=10.0.24.13:2881,10.0.24.13:2882,10.0.24.13:2883</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建日志文件</span></span><br><span class="line">[root@VM-24-13-centos kafka]# mkdir kafka-logs1 kafka-logs2 kafka-logs3</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>修改<code>bin</code>目录下的<code>kafka-server-start.sh</code>文件，将初始堆的大小(-Xms)设置小一些，不然启动报错</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export KAFKA_HEAP_OPTS=&quot;-Xmx1024M -Xms128M&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>启动kafka。切记先要启动zk</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@VM-24-13-centos local]# kafka/bin/kafka-server-start.sh kafka/config/server1.properties</span><br><span class="line"></span><br><span class="line">[root@VM-24-13-centos local]# kafka/bin/kafka-server-start.sh kafka/config/server2.properties</span><br><span class="line"></span><br><span class="line">[root@VM-24-13-centos local]# kafka/bin/kafka-server-start.sh kafka/config/server3.properties</span><br><span class="line">...</span><br><span class="line">2022-01-07 18:28:37,222] INFO [ExpirationReaper-3-topic]: Starting (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)</span><br><span class="line">[2022-01-07 18:28:37,239] INFO [ExpirationReaper-3-Heartbeat]: Starting (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)</span><br><span class="line">[2022-01-07 18:28:37,249] INFO [ExpirationReaper-3-Rebalance]: Starting (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)</span><br><span class="line">[2022-01-07 18:28:37,266] INFO [GroupCoordinator 3]: Starting up. (kafka.coordinator.group.GroupCoordinator)</span><br><span class="line">[2022-01-07 18:28:37,271] INFO [GroupCoordinator 3]: Startup complete. (kafka.coordinator.group.GroupCoordinator)</span><br><span class="line">[2022-01-07 18:28:37,289] INFO [TransactionCoordinator id=3] Starting up. (kafka.coordinator.transaction.TransactionCoordinator)</span><br><span class="line">[2022-01-07 18:28:37,292] INFO [TransactionCoordinator id=3] Startup complete. (kafka.coordinator.transaction.TransactionCoordinator)</span><br><span class="line">[2022-01-07 18:28:37,302] INFO [Transaction Marker Channel Manager 3]: Starting (kafka.coordinator.transaction.TransactionMarkerChannelManager)</span><br><span class="line">[2022-01-07 18:28:37,332] INFO [ExpirationReaper-3-AlterAcls]: Starting (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)</span><br><span class="line">[2022-01-07 18:28:37,367] INFO [SocketServer listenerType=ZK_BROKER, nodeId=3] Starting socket server acceptors and processors (kafka.network.SocketServer)</span><br><span class="line">[2022-01-07 18:28:37,370] INFO [/config/changes-event-process-thread]: Starting (kafka.common.ZkNodeChangeNotificationListener$ChangeEventProcessThread)</span><br><span class="line">[2022-01-07 18:28:37,396] INFO [SocketServer listenerType=ZK_BROKER, nodeId=3] Started data-plane acceptor and processor(s) for endpoint : ListenerName(PLA</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>查看kafka和flink是否启动</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-24-13-centos ~]# jps</span><br><span class="line">5187 QuorumPeerMain # zk</span><br><span class="line">10853 Jps</span><br><span class="line">5110 QuorumPeerMain # zk</span><br><span class="line">5271 QuorumPeerMain # zk</span><br><span class="line">10407 Kafka #kafka</span><br><span class="line">4216 StandaloneSessionClusterEntrypoint</span><br><span class="line">9866 Kafka # kafka</span><br><span class="line">4491 TaskManagerRunner # flink</span><br><span class="line">8494 Kafka # kafka</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="python3"><a href="#python3" class="headerlink" title="python3"></a>python3</h3><ul>
<li>服务器现在默认用的python2.7，现在升级为python3</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装依赖文件</span></span><br><span class="line">yum install zlib-devel bzip2-devel openssl-devel ncurses-devel sqlite-devel readline-devel tk-devel gcc make</span><br><span class="line"></span><br><span class="line">wget https://www.python.org/ftp/python/3.7.9/Python-3.7.9.tar.xz</span><br><span class="line">tar -xvf Python-3.7.9.tar.xz</span><br><span class="line">cd Python-3.7.9.tar.xz</span><br><span class="line"></span><br><span class="line">./configure prefix=/usr/local/python3.7.9 # 指定编译python存放路径</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<ul>
<li>备份python2</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /usr/bin/python /usr/bin/python.bak</span><br></pre></td></tr></table></figure>

<ul>
<li>创建软链接</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/local/python3/bin/python3 /usr/bin/python</span><br></pre></td></tr></table></figure>

<ul>
<li>修改yum配置文件。由于执行CentOS的yum命令需要使用自带的python2的版本，所以需要做两处修改</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/bin/yum</span><br><span class="line">vi /usr/libexec/urlgrabber-ext-down</span><br><span class="line"></span><br><span class="line">将 这两个文件的 #!/usr/bin/python修改为 #!/usr/bin/python2</span><br></pre></td></tr></table></figure>

<ul>
<li>查看python3版本</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-24-13-centos local]# python --version</span><br><span class="line">Python 3.7.9</span><br></pre></td></tr></table></figure>

<h2 id="测试过程"><a href="#测试过程" class="headerlink" title="测试过程"></a>测试过程</h2><ul>
<li>暂时放弃，服务器内存不足，在一台机器上部署分布式配置不够</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://louis-me.github.io/aposts/549ce9d8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="一个正经的测试工程师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="施坤的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/aposts/549ce9d8/" class="post-title-link" itemprop="url">第七章 大数据测试方法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-31 10:35:43" itemprop="dateCreated datePublished" datetime="2021-12-31T10:35:43+08:00">2021-12-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-25 11:20:56" itemprop="dateModified" datetime="2022-02-25T11:20:56+08:00">2022-02-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">大数据</span></a>
                </span>
            </span>

          
            <span id="/aposts/549ce9d8/" class="post-meta-item leancloud_visitors" data-flag-title="第七章 大数据测试方法" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/aposts/549ce9d8/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/aposts/549ce9d8/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="与传统测试区别"><a href="#与传统测试区别" class="headerlink" title="与传统测试区别"></a>与传统测试区别</h2><p><img src="/aposts/549ce9d8/image-20211231104504478.png" alt="image-20211231104504478"></p>
<h2 id="功能测试"><a href="#功能测试" class="headerlink" title="功能测试"></a>功能测试</h2><h3 id="数据质量"><a href="#数据质量" class="headerlink" title="数据质量"></a>数据质量</h3><ul>
<li>主要包括4种测试方法</li>
</ul>
<p><img src="/aposts/549ce9d8/image-20211231104800758.png" alt="image-20211231104800758"></p>
<h3 id="常用的功能测试方法"><a href="#常用的功能测试方法" class="headerlink" title="常用的功能测试方法"></a>常用的功能测试方法</h3><h4 id="数据约束检查"><a href="#数据约束检查" class="headerlink" title="数据约束检查"></a>数据约束检查</h4><ul>
<li>如数据类型、长度、索引、主键等是否符合要求</li>
</ul>
<h4 id="数据存储检查"><a href="#数据存储检查" class="headerlink" title="数据存储检查"></a>数据存储检查</h4><ul>
<li>是否需要压缩文件形式存储</li>
<li>hive表类型是否合理（内外部表、分区、分桶表）</li>
<li>代码中读取、写入文件目录是否正确</li>
</ul>
<h4 id="SQL文件检查"><a href="#SQL文件检查" class="headerlink" title="SQL文件检查"></a>SQL文件检查</h4><p>开发规范检查。一般公司都有自己的规范，如hiveql中的：</p>
<ul>
<li>注释</li>
<li>字段，不行用*代替全部</li>
<li>…..</li>
</ul>
<h4 id="SQ语法检查"><a href="#SQ语法检查" class="headerlink" title="SQ语法检查"></a>SQ语法检查</h4><ul>
<li>合理使用insert into、insert overwrite、order by、group by等</li>
</ul>
<h4 id="数据处理逻辑验证"><a href="#数据处理逻辑验证" class="headerlink" title="数据处理逻辑验证"></a>数据处理逻辑验证</h4><ul>
<li>脏数据处理是否符合预期</li>
<li>去重处理</li>
</ul>
<h4 id="shell脚本测试"><a href="#shell脚本测试" class="headerlink" title="shell脚本测试"></a>shell脚本测试</h4><ul>
<li>测试jar包是否引用正确</li>
<li>mapper、reducer文件、mapreduce依赖文件等路径、运行配置参数是否合理</li>
<li>我对shell不熟悉，一般采用python</li>
</ul>
<h4 id="调度任务测试"><a href="#调度任务测试" class="headerlink" title="调度任务测试"></a>调度任务测试</h4><ul>
<li>是否支持重跑</li>
<li>依赖层次是否合理</li>
<li>任务是否在规定时间完成等</li>
</ul>
<h2 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h2><p>主要由六种测试：基准测试、并发测试、负载测试、压力测试、容量测试、稳定性测试</p>
<h3 id="性能测试步骤"><a href="#性能测试步骤" class="headerlink" title="性能测试步骤"></a>性能测试步骤</h3><p><img src="/aposts/549ce9d8/image-20211231111135709.png" alt="image-20211231111135709"></p>
<h3 id="性能测试案例"><a href="#性能测试案例" class="headerlink" title="性能测试案例"></a>性能测试案例</h3><ul>
<li><p>以<a target="_blank" rel="noopener" href="https://moon-full.gitee.io/2021/12/29/%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%A4%A7%E6%95%B0%E6%8D%AE%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B/#%E5%A4%A7%E6%95%B0%E6%8D%AE%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%A1%88%E4%BE%8B">第六章用户行为分析平台</a>为例子，采用YCSB工具，对平台底层Kudu进行性能测试</p>
</li>
<li><p>YCSB 是雅虎开源的性能测试工具，对NoSql产品进行测试和评估，如HBase、MongoDB等</p>
</li>
</ul>
<h4 id="测试场景"><a href="#测试场景" class="headerlink" title="测试场景"></a>测试场景</h4><p><img src="/aposts/549ce9d8/image-20211231152400144.png" alt="image-20211231152400144"></p>
<h4 id="测试结果"><a href="#测试结果" class="headerlink" title="测试结果"></a>测试结果</h4><p><img src="/aposts/549ce9d8/image-20211231152443995.png" alt="image-20211231152443995"></p>
<p><img src="/aposts/549ce9d8/image-20211231153058203.png" alt="image-20211231153058203"></p>
<h2 id="大数据基准测试"><a href="#大数据基准测试" class="headerlink" title="大数据基准测试"></a>大数据基准测试</h2><p>对大数据框架、大数据平台、工具的出现进行基准测试，测试步骤分为：</p>
<ul>
<li><p>数据准备</p>
</li>
<li><p>负载选择</p>
</li>
</ul>
<p><img src="/aposts/549ce9d8/image-20211231153711579.png" alt="image-20211231153711579"></p>
<ul>
<li>指标度量</li>
</ul>
<h3 id="基准测试工具"><a href="#基准测试工具" class="headerlink" title="基准测试工具"></a>基准测试工具</h3><p><img src="/aposts/549ce9d8/image-20211231153834017.png" alt="image-20211231153834017"></p>
<h2 id="大数据ETL测试"><a href="#大数据ETL测试" class="headerlink" title="大数据ETL测试"></a>大数据ETL测试</h2><h3 id="ETL测试类型"><a href="#ETL测试类型" class="headerlink" title="ETL测试类型"></a>ETL测试类型</h3><h4 id="元数据测试"><a href="#元数据测试" class="headerlink" title="元数据测试"></a>元数据测试</h4><ul>
<li>验证表定义是否符号数据模型和应用程序的设计规范，包括对数据类型、数据长度、索引和约束等</li>
</ul>
<h4 id="数据完整性测试"><a href="#数据完整性测试" class="headerlink" title="数据完整性测试"></a>数据完整性测试</h4><ul>
<li>目的是验证是否已将预期数据从源加载到目标中，主要测试：比较源和目标之间的计数，如最大、最小、总和、均值和实际数据量</li>
</ul>
<h4 id="数据转换测试"><a href="#数据转换测试" class="headerlink" title="数据转换测试"></a>数据转换测试</h4><ul>
<li>白盒测试。用sql或pl&#x2F;sql对数据转换，用转换后的数据与目标中数据比较</li>
<li>黑盒测试。外部界面方式造数据完成转换，用转换后的数据与目标中数据比较</li>
</ul>
<h4 id="增量ETL测试"><a href="#增量ETL测试" class="headerlink" title="增量ETL测试"></a>增量ETL测试</h4><p>目的是验证源上的更新能否正确加载到目标系统中</p>
<h3 id="ETL集成测试"><a href="#ETL集成测试" class="headerlink" title="ETL集成测试"></a>ETL集成测试</h3><p>如下几个步骤：</p>
<ul>
<li>在源系统中，设置测试数据</li>
<li>执行ETL过程把数据加载到目标中</li>
<li>查看或处理目标系统中数据</li>
<li>验证数据和使用该数据的应用程序的功能</li>
</ul>
<h4 id="ETL性能测试"><a href="#ETL性能测试" class="headerlink" title="ETL性能测试"></a>ETL性能测试</h4><p>略</p>
<h3 id="ETL测试场景"><a href="#ETL测试场景" class="headerlink" title="ETL测试场景"></a>ETL测试场景</h3><h4 id="实时数据ETL和测试"><a href="#实时数据ETL和测试" class="headerlink" title="实时数据ETL和测试"></a>实时数据ETL和测试</h4><ul>
<li>实时数据一般指分钟级别以下，通常包括实时计算、存储、展示和分析等。</li>
</ul>
<p><img src="/aposts/549ce9d8/image-20211231161902589.png" alt="image-20211231161902589"></p>
<ul>
<li>原始数据:可以理解为上游原始数据。对于整个上层消费应用，除数据本身以外，其他都是“黑盒，即不可见。目前，对于接入的数据源，常见的提供数据的方式人 Kafka、MQ 等。</li>
<li>实时数据处理:这是整个数据流转路径的核心，负责根据业务需求对原始数据进行理并转发。常见的处理实时数据的应用框架有Flink、Storm和SparkStreaming等。</li>
<li>数据存储:用于保存处理后的数据。对于业务功能，可以在这里获取需要使用的数据。在这里，我们一般使用基于内存的key-value数据库 Redis，以及列式数据医。 ClickHouse、MongoDB和HDFS等。另外，我们可以将数据转发至另一个数握 通道。</li>
<li>数据应用:数据的具体使用。在这里，我们可以对数据进行业务层面的处理、数据的可视化展示。</li>
</ul>
<h4 id="离线数据ETL和测试"><a href="#离线数据ETL和测试" class="headerlink" title="离线数据ETL和测试"></a>离线数据ETL和测试</h4><ul>
<li>离线数据一般采用T+1模式，即每天凌晨处理前一天的数据，一般采用Sqoop，datax，Flume和MapReduce等</li>
</ul>
<p><img src="/aposts/549ce9d8/image-20211231163101257.png" alt="image-20211231163101257"></p>
<ul>
<li>对于不同的数据仓库结构，有不同的测试点</li>
</ul>
<p><img src="/aposts/549ce9d8/image-20211231163336807.png" alt="image-20211231163336807"></p>
<h4 id="大数据ETL测试工具"><a href="#大数据ETL测试工具" class="headerlink" title="大数据ETL测试工具"></a>大数据ETL测试工具</h4><ul>
<li>iCDQ</li>
<li>Talend</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://louis-me.github.io/aposts/f5236b59/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="一个正经的测试工程师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="施坤的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/aposts/f5236b59/" class="post-title-link" itemprop="url">第六章 大数据项目开发流程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-29 11:17:29" itemprop="dateCreated datePublished" datetime="2021-12-29T11:17:29+08:00">2021-12-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-25 11:20:56" itemprop="dateModified" datetime="2022-02-25T11:20:56+08:00">2022-02-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">大数据</span></a>
                </span>
            </span>

          
            <span id="/aposts/f5236b59/" class="post-meta-item leancloud_visitors" data-flag-title="第六章 大数据项目开发流程" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/aposts/f5236b59/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/aposts/f5236b59/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="大数据项目开发概览"><a href="#大数据项目开发概览" class="headerlink" title="大数据项目开发概览"></a>大数据项目开发概览</h2><p>一个完整的大数据项目架构可以分为数据采集层、数据存储层、数据计算层、数据接入层、数据应用层和基础服务层，如下图所示：</p>
<p><img src="/aposts/f5236b59/image-20211229113510858.png" alt="image-20211229113510858"></p>
<h2 id="数据的采集和存储"><a href="#数据的采集和存储" class="headerlink" title="数据的采集和存储"></a>数据的采集和存储</h2><p>数据采集方式主要有：</p>
<ul>
<li><p>网络数据采集</p>
</li>
<li><p>服务端日志采集</p>
</li>
<li><p>客户端日志采集</p>
</li>
</ul>
<h2 id="服务端日志采集"><a href="#服务端日志采集" class="headerlink" title="服务端日志采集"></a>服务端日志采集</h2><ul>
<li>服务端日志是重要的数据来源,它可以支持业务问题排查、业务数据分析等。下图是常见的服务端日志架构。客户端通过API( Application Programming Interface,应用程序编程接口)向服务端发送请求,服务端会在服务器本地记录日志文件。日志文件可能包括访问日志、Lnux系统日志和业务日志等。这些日志会被服务端日志采集服务收集、同步发给日志服务器,以便后续使用。</li>
</ul>
<p><img src="/aposts/f5236b59/image-20211229150453592.png" alt="image-20211229150453592"></p>
<p>一个完整的服务端日志采集流程如图4-3所示。</p>
<ul>
<li><p>在客户端向服务端发送请求后，服务端会在服务器本地记录请求日志或业务日志。此外，服务端会通过服务直接向Kafka推送日志。</p>
</li>
<li><p>服务器的本地日志在写入的同时，还会通过Flume等工具进行持续收集，并推送到 Kafka集群中指定的主题。在收集、推送的过程中，会进行一些日志数据处理工作，如请求头信息解析、接口参数提取和日志信息格式化等。</p>
</li>
<li><p>我们可以使用SparkStreaming实时消费处理Kafka消息，并将处理好的数据写入指定的数据库中，如MySQL、Redis等。此种方式可以提供实时的服务端日志应用，如错误日志监控报警等。对于Spark Streaming处理完的数据，将继续推送到Kafka，供其他业务</p>
</li>
<li><p>我们也可以使用flume消费kafka的消息，并将处理号的数据写入HDFS，为后续的离线使用提供基础数据</p>
<p><img src="/aposts/f5236b59/image-20211229151331689.png" alt="image-20211229151331689"></p>
</li>
</ul>
<h3 id="客户端日志采集"><a href="#客户端日志采集" class="headerlink" title="客户端日志采集"></a>客户端日志采集</h3><h4 id="移动端分类"><a href="#移动端分类" class="headerlink" title="移动端分类"></a>移动端分类</h4><p>移动端分为两种：</p>
<ul>
<li>Native App：原生应用程序。也就是基于智能手机系统的原生程式编写运行的应用程序，比如Android，IOS等</li>
<li>Hybrid App：混合应用程序。原生应用程序嵌入h5的方式</li>
</ul>
<h4 id="采集方式"><a href="#采集方式" class="headerlink" title="采集方式"></a>采集方式</h4><ul>
<li>浏览器页面的日志采集。如采集Hybrid App中h5浏览器<ul>
<li>浏览量PV</li>
<li>访问量UV</li>
</ul>
</li>
<li>移动端客户端日志的采集。如采集Native App<ul>
<li>埋点SDK</li>
</ul>
</li>
</ul>
<h2 id="数据同步"><a href="#数据同步" class="headerlink" title="数据同步"></a>数据同步</h2><ul>
<li>数据仓库的特性之一是集成，即首先把未经过加工处理的、不同来源的、不同形式的数据同步到ODS层，一般情况下，这些ODS层数据包括日志数据和业务DB数据。对于业务DB数据而言(比如存储在MySQL中)，将数据采集并导入到数仓中(通常是Hive或者MaxCompute)是非常重要的一个环节。</li>
<li>针对不同数据类型和业务场景，我们可以选择不同的数据同步方式：<ul>
<li>直连同步</li>
<li>数据文件同步</li>
<li>数据库日志解析同步</li>
</ul>
</li>
</ul>
<h3 id="直连同步"><a href="#直连同步" class="headerlink" title="直连同步"></a>直连同步</h3><ul>
<li>直连同步是指通过定义好的规范接口API和基于动态链接库的方式直接连接业务库</li>
<li>直连同步的方式配置十分简单，很容易上手操作，比较适合操作型业务系统的数据同步，但是会存在随着业务规模的增长，<strong>数据同步花费的时间会越来越长、连数据库查询数据，对数据库影响非常大，容易造成慢查询，可能会影响业务线上的正常服务</strong></li>
</ul>
<p><img src="/aposts/f5236b59/image-20211229155528410.png" alt="image-20211229155528410"></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://moon-full.gitee.io/2021/12/14/%E7%AC%AC%E4%BA%94%E7%AB%A0%20%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%E5%AE%9E%E4%BE%8B/">第五章 数据仓库实例</a>，就是采用这种方式</li>
</ul>
<h3 id="数据文件同步"><a href="#数据文件同步" class="headerlink" title="数据文件同步"></a>数据文件同步</h3><ul>
<li>对文件进行格式约定，直接从源系统生成数据（mysql，oracle，DB2等）的文件，通过FTP服务器传输到目标系统，最终加载到目标系统中。</li>
</ul>
<p><img src="/aposts/f5236b59/image-20211229155932718.png" alt="image-20211229155932718"></p>
<ul>
<li>通过文件服务进行上传、下载，可能出现丢包或出现错误。可以加一些校验机制</li>
</ul>
<h3 id="数据库日志解析同步"><a href="#数据库日志解析同步" class="headerlink" title="数据库日志解析同步"></a>数据库日志解析同步</h3><ul>
<li>数据库日志解析的同步方式可以实现实时与准实时的同步，延迟可以控制在毫秒级别的，其最大的优势就是性能好、效率高，不会对源数据库造成影响，目前，从业务系统到数据仓库中的实时增量同步，<strong>广泛采取这种方式</strong>。当然，这种方式也会存在一些问题，比如批量补数时造成大量数据更新，<strong>日志解析会处理较慢</strong>，造成数据延迟。除此之外，<strong>这种方式比较复杂</strong>，<strong>投入也较大</strong>，因为需要一个实时的抽取系统去抽取并解析日志</li>
</ul>
<p><img src="/aposts/f5236b59/image-20211229160911594.png" alt="image-20211229160911594"></p>
<h2 id="大数据存储"><a href="#大数据存储" class="headerlink" title="大数据存储"></a>大数据存储</h2><p>对于大数据存储选项，需要从存储成本、数据规模、数据访问特性和查询性能等方面进行考虑，下图列举了不同场景大数据存储选型。</p>
<p><img src="/aposts/f5236b59/image-20211229161451827.png" alt="image-20211229161451827"></p>
<h2 id="大数据计算"><a href="#大数据计算" class="headerlink" title="大数据计算"></a>大数据计算</h2><ul>
<li>一般分为离线计算、批量计算、实时计算和流式计算，业界一般都使用<strong>离线计算和实时计算</strong>，下图是各个计算方式的区别</li>
</ul>
<h3 id="离线计算"><a href="#离线计算" class="headerlink" title="离线计算"></a>离线计算</h3><p><img src="/aposts/f5236b59/image-20211229164031999.png" alt="image-20211229164031999"></p>
<ul>
<li>离线计算使用的多数场景是周期（小时、天，月）性执行一个job任务，离线计算应用中常用的是离线ETL的处理。如MapReduce就是一个离线的计算框架，下图举例说明了离线计算工作流</li>
</ul>
<p><img src="/aposts/f5236b59/image-20211229165345162.png" alt="image-20211229165345162"></p>
<ul>
<li>离线计算需要上下游各组件合作，一般会由多个任务单元构成（HiveQL，shell，Shell和MapReduce等），多个单元由很强的依赖关系</li>
</ul>
<h3 id="实时计算"><a href="#实时计算" class="headerlink" title="实时计算"></a>实时计算</h3><ul>
<li>对数据计算要求较高，如实时的ETL，实时监控等，延时一般为毫秒级别，目前笔比较流行的实时框架有<code>Spark Streaming</code>和<code>Flink</code></li>
<li>下图展示了一个大数据计算平台架构，其中包含离线计算和实时计算</li>
</ul>
<p><img src="/aposts/f5236b59/image-20211229170148516.png" alt="image-20211229170148516"></p>
<h2 id="大数据监控"><a href="#大数据监控" class="headerlink" title="大数据监控"></a>大数据监控</h2><p>在大数据进行采集、存储和处理后，下面就是项目的上线和日常运行。在运行过程中监控和报警就非常重要</p>
<h3 id="数据监控"><a href="#数据监控" class="headerlink" title="数据监控"></a>数据监控</h3><p>一些常见的监控内容：</p>
<ul>
<li>以时间维度对数据记录进行监控。比如某个时间段出现明显波动</li>
<li>对数据的NULL和0值进行监控</li>
<li>对数据的值域进行监控。如对数据中某字段出现合理域值以外的值</li>
<li>对数据的重复度进行监控。如电商业务的交易记录出现重复等</li>
</ul>
<h3 id="运维监控"><a href="#运维监控" class="headerlink" title="运维监控"></a>运维监控</h3><ul>
<li>在当前大数据项目中，使用服务器集群方式支撑业务已经成为常态，开发自动化运维监控系统非常重要。</li>
<li>监控常见的cpu，men，io，tps，对大数据生态系统进行监控，如zookeeper节点可用性，yarn资源空闲情况、kafka消息堆积情况，以及spark job完成进度等</li>
<li>其他的一些监控，如端口,nginx的延迟</li>
</ul>
<h2 id="大数据项目开发案例"><a href="#大数据项目开发案例" class="headerlink" title="大数据项目开发案例"></a>大数据项目开发案例</h2><ul>
<li>数据分析平台是一类重要的大数据应用,广泛应用于互联网金融、银行、电子商务和在线教育等领域。</li>
<li>数据分析平台通常需要实时计算、查询并借助可视化平台展示数据。通过数据分析平台,用户可以更加直观、高效和全面地了解数据分布情况,观察数据变化趋势,最终达到数据驱动业务决策的目标。</li>
<li>与单纯的数据可视化类平台或BI报表相比,数据分析平台的链路更长,除最终的可视化数据展示以外,还包括源头的数据采集;<strong>而BI报表通常只是对数据的汇总和查询展示,不涉及数据采集、数据存储等环节</strong>。如图4-15所示,根据不同的数据分析类型,数据分析平台可分为如下几类:**用户行为类(应用比较多)**、App分析类、应用市场监控类、流量分析类和广告效果监控类等。</li>
</ul>
<p><img src="/aposts/f5236b59/image-20211230104909426.png" alt="image-20211230104909426"></p>
<h3 id="项目背景介绍"><a href="#项目背景介绍" class="headerlink" title="项目背景介绍"></a>项目背景介绍</h3><ul>
<li>分析手机App用户数量和交易的某些行为习惯，实现精准营销。类似于购物推荐这种</li>
</ul>
<h3 id="项目需求分析"><a href="#项目需求分析" class="headerlink" title="项目需求分析"></a>项目需求分析</h3><ul>
<li>与传统应用开发相同,在迸行大数据项目开发前,首先要明确项目的需求。用户行为分析平台需要提供多种数据釆集方式,通过对埋点数据的采集、处理、建模和存储,进行深度分析和应用,帮助企业高效获取海量数据,并进行多维、实时和准确的数据分析,还原真实业务场。用户行为分析平台的业务流程包括数据釆集、数据处理、数据建模、数据存储、数据簑理、智能分析和基础看板。图4-16是用户行为分析平台的业务流程。</li>
</ul>
<p><img src="/aposts/f5236b59/image-20211230110240930.png" alt="image-20211230110240930"></p>
<ul>
<li>用户行为分析主要包括：<strong>基础看板和智能分析</strong></li>
<li>基础看板：如实时统计在线人数、启动次数</li>
<li>智能分析：如从商品浏览率到提交订单，支付订单，各个节点用户转化率</li>
</ul>
<h3 id="项目开发流程"><a href="#项目开发流程" class="headerlink" title="项目开发流程"></a>项目开发流程</h3><ul>
<li>大数据项目的完整流程如图4-18所示，在进行大数据项目开发时,首先,大数据开发工程师需要根据产品需求文档进行架构设<br>计、模型设计和调度设计,产出架构设计文档、ETL设计文档和调度设计文档;然后,项目<br>相关人员(包括测试人员)需要对这些设计进行评审等。</li>
</ul>
<p><img src="/aposts/f5236b59/image-20211230111333106.png" alt="image-20211230111333106"></p>
<ul>
<li>图4-19为大数据项目开发流程。</li>
</ul>
<p><img src="/aposts/f5236b59/image-20211230111422715.png" alt="image-20211230111422715"></p>
<h4 id="结构设计"><a href="#结构设计" class="headerlink" title="结构设计"></a>结构设计</h4><p>根据平台需求的特点,在架构设计时,将用户行为分析平台拆分为4个服务：</p>
<ul>
<li>数据采集与预处理服务( og service)</li>
<li>数据处理服务(实时数据处理服务(real-task)使用Flink,离线数据处理服务采用 Azkaban进行任务调度),</li>
<li>数据查询服务(DAS),</li>
<li>数据管理服务(DMS)</li>
</ul>
<p>如图4-20所示。数据从源数据到可视化展示需要从下至上经过这些服务的处理。</p>
<p><img src="/aposts/f5236b59/image-20211230112924605.png" alt="image-20211230112924605"></p>
<p>用户行为分析平台的核心是数据处理,即从数据采集到数据应用的数据流转,如图4-21</p>
<p><img src="/aposts/f5236b59/image-20211230113054864.png" alt="image-20211230113054864"></p>
<h4 id="模型设计"><a href="#模型设计" class="headerlink" title="模型设计"></a>模型设计</h4><p>根据用户行为分析平台的功能和特点,我们需要设计能够满足其应用需求的数据仓库架构。图4-24是一个数据仓库架构方案：</p>
<p><img src="/aposts/f5236b59/image-20211230114656565.png" alt="image-20211230114656565"></p>
<ul>
<li>RB层(实时层)KRB的全称是 Kudu ReaBase,该层的表全部为未统计汇总的实时明细数如 krb. trs_app_event_log表是埋点日志事件表</li>
<li>KRS层(实时汇总层)KRS的全称是Kucu Real Sum,该层的表全部为统计汇总的实时明细数据,如ks. rs app_user_open_dh表是App用活跃统计表(以小时为单位进行分区)表名的结尾后缀用于表明该表分区间单位，如本例中的<strong>dh表示小时进行分区</strong>。</li>
<li>HDB层(贴源层):HDB的全称是 Hive Data Base,该层的表全部为未统计汇总的离线明细数据。该层数据是通过mpaa从KRB层同步过来的,如 hdb db app_equ_install_info表是App安装设备信息表。</li>
<li>HDS层(汇总层):HDS的全称是 Hive Data stat,该层的表全部为统计汇总的离线数据明细</li>
<li>HTP层(中间层):HTP的全称是 Hive Temporary,该层的表全部为数据处理过程中生成的中间临时数据,如 htp. tmp skynet user_retention d表是日用户留存分析中间表（以天为单位进行分区）</li>
<li>IVW层(视图层):IVW的全称是 mpala View,该层的表全部为mpaa操作的视图表,如ⅳ w.trs <em>app_event log表是KRB层(实时层)中提到的 krs. trs app</em> event_log表的视图。</li>
</ul>
<p>在后续测试案例中,我们会使用实时层中的埋点日志事件表 krb. trs_ app_event_loc<br>这里只举例说明该表的结构设计。表4-7汇总了(贴出部分)</p>
<ul>
<li>以log_i作为主键。</li>
<li>以log_id作为hash分区,以log_dt作为rang分区</li>
<li>历史数据分区和最新数据分区一直保留</li>
<li><strong>只新增数据,增量分区,使用 Flink SQL写数据</strong></li>
</ul>
<p><img src="/aposts/f5236b59/image-20211230115834627.png" alt="image-20211230115834627"></p>
<h4 id="调度设计"><a href="#调度设计" class="headerlink" title="调度设计"></a>调度设计</h4><ul>
<li>上面列出的HDS层数据表位于用户行为分析平台的离线数据存储层。对于离线数据理,具有周期性、重复性的特点,因此,我们使用调度工具 <strong>Azkaban</strong>提供的可靠计划来处理数据。根据各数据表中数据的前后依赖关系,用户行为分析平台的调度设计如图4-25际示。由图4-25可知,为了提高项目的可读性,子任务节点的命名与表名保持形式上的统一(子任务节点生成与之名称对应的数据表中的数据)。</li>
</ul>
<p><img src="/aposts/f5236b59/image-20211230151251867.png" alt="image-20211230151251867"></p>
<ul>
<li>在完成用户行为分析平台的架构设计、模型设计和调度设计后，开发人员便可以根据它们进行相应的代码开发。通过对用户行为分析平台项目的介绍，我们不难发现，项目中需要开发的功能多、业务流程复杂，需要测试人员的参与来保证平台质量。、</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://louis-me.github.io/aposts/bcb72660/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="一个正经的测试工程师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="施坤的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/aposts/bcb72660/" class="post-title-link" itemprop="url">第五章 数据仓库实例</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-14 16:28:31" itemprop="dateCreated datePublished" datetime="2021-12-14T16:28:31+08:00">2021-12-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-09 17:34:47" itemprop="dateModified" datetime="2022-05-09T17:34:47+08:00">2022-05-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">大数据</span></a>
                </span>
            </span>

          
            <span id="/aposts/bcb72660/" class="post-meta-item leancloud_visitors" data-flag-title="第五章 数据仓库实例" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/aposts/bcb72660/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/aposts/bcb72660/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>阅读本章，请把hadoop和hive环境搭建好，可以参考如下文章：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.shikun.work/aposts/d7dcf086/">第三章 大数据之Hadoop搭建</a></li>
<li><a target="_blank" rel="noopener" href="http://www.shikun.work/aposts/ae85ee2e/">第四章 大数据之hive搭建</a></li>
<li>本次实例来自对《大数据测试技术与实践》中实例补充，书中的实例并不能直接使用,有些地方是错误的，我也修改和补充</li>
</ul>
<h2 id="数据仓库实例"><a href="#数据仓库实例" class="headerlink" title="数据仓库实例"></a>数据仓库实例</h2><ul>
<li><p>在本节中,我们通过一个简单的实例介绍数据仓库对数据的处理过程。假设有一家连锁超市,它有多家分店。每一个分店都有很多种类的商品,包括日用品、肉类、冷冻食品、烘焙食品和花卉等。所有产<br>品在整个连锁超市环境下有一个唯一的产品编号。图3-15为一张顾客结账清单。</p>
<p><img src="/aposts/bcb72660/image-20211214170515688.png" alt="image-20211214170515688"></p>
</li>
<li><p>经过一段时间的商品销售后,连锁超市积累了大量销售数据，如下图所示,超市分店具有分店名、分店地址<br>和开店时间属性,商品有商品类别、商品价格、唯一编号和生产地址属性。当然,地址可以进一步拆分为省、市等。</p>
</li>
</ul>
<p><img src="/aposts/bcb72660/image-20211214170552603.png" alt="image-20211214170552603"></p>
<ul>
<li>假设对商品A进行促销,如发放代金券、降价等,现在分析促销活动对商品A销售量的，为了简便,<strong>本实例统计超市分店中商品A每天的销售量、到店消费人数和购买商品A的消费者的比例</strong></li>
<li>我们在<a target="_blank" rel="noopener" href="https://moon-full.gitee.io/2021/12/06/%E6%95%B0%E6%8D%AE%E4%BB%93%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E6%9E%84%E5%BB%BA/">数据仓的设计与构建</a>文章中的数据仓库的设计中提到过,数据仓库分为数据接入层、数据明细层、数据汇总层和数据集市等。数据接入层负责将业务系统中的商品相关销售数据导入;数据明细层负责对数据接入层的数据进行预处理,过滤”脏”数据等;数据汇总层将数据按照订单进行汇总;数据集市层负责聚合计算相应的指标。</li>
<li>由于要对商品在时间、地点等维度的指标进行汇总计算,因此,我们在数据仓库层使用维度建模方式建表，（我们在<a target="_blank" rel="noopener" href="https://moon-full.gitee.io/2021/12/06/%E7%AC%AC%E4%BA%8C%E7%AB%A0%20%E6%95%B0%E6%8D%AE%E4%BB%93%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E6%9E%84%E5%BB%BA/">数据仓的设计与构建</a>中的数据仓库建模方法也说过相应概念）。显然,我们对日期、超市分店(地址)和商品等维度比较感兴趣。图3-17所示为商品的维度模型实际的建模过程比这复杂。以日期维度为例,在实际建模中,时间维度表一般会会有当天是一个月中的哪一天,当天是一年中的哪天,当前周是一年中的哪周,当前季度是年中哪季度,以及时间视计算肭表示等字段,方便将销售指标在各种时间点上进行同比。</li>
</ul>
<p><img src="/aposts/bcb72660/image-20211214172404147.png" alt="image-20211214172404147"></p>
<ul>
<li><p>假设超市业务系统中的销售数据是以实际购物清单拆分的形式存放,即在购物清单中,含有品、商品价格和交易时间(清单创建时间)等信息,则超市业务系统的数据库中会有如图下的表关系</p>
<p><img src="/aposts/bcb72660/image-20211214172637088.png" alt="image-20211214172637088"></p>
</li>
<li><p>由于商品信息表和超市分店信息表的数据量不大,且基本无改动,因此可以选择<strong>全量更新</strong>的方式将数据加载到数据仓库。而来自各超市分店的商品销售清单的数据量很大,且每天会有新插入的数据记录,因此,在将数据加载到数据仓库时,可以选择<strong>增量加载</strong>方式</p>
</li>
<li><p>在本实例中,对于数据仓库的存储,采用HDFS和Hive,在ETL过程中,使用 HiveQL。图3-19为各级数据表的关系。</p>
</li>
</ul>
<p><img src="/aposts/bcb72660/image-20211215100757274.png" alt="image-20211215100757274"></p>
<h2 id="数据接入层ODS"><a href="#数据接入层ODS" class="headerlink" title="数据接入层ODS"></a>数据接入层ODS</h2><h3 id="创建接入层的表"><a href="#创建接入层的表" class="headerlink" title="创建接入层的表"></a>创建接入层的表</h3><p>首先，在Hive中，创建数据库接入层对应的表，代码如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"># 切换到hadoop用户</span><br><span class="line">su hadoop</span><br><span class="line"># 进入到hive</span><br><span class="line">hive</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建超市分店信息表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> ods_market_info;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> ods_market_info(</span><br><span class="line">market_id string comment <span class="string">&#x27;超市分店编号&#x27;</span>,</span><br><span class="line">market_address string comment <span class="string">&#x27;超市分店地址&#x27;</span>,</span><br><span class="line">start_time string comment <span class="string">&#x27;有效期起始时间&#x27;</span>,</span><br><span class="line">end_time string comment <span class="string">&#x27;有效期终止时间&#x27;</span>,</span><br><span class="line">market_name string comment <span class="string">&#x27;超市分店名称&#x27;</span>,</span><br><span class="line">create_time string comment <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">update_time string comment <span class="string">&#x27;更新时间&#x27;</span></span><br><span class="line">)</span><br><span class="line">partitioned <span class="keyword">by</span>(dt string)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"><span class="comment">--创建商品信息表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> ods_product_info;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ods_product_info(</span><br><span class="line">product_id <span class="type">int</span> comment <span class="string">&#x27;商品id&#x27;</span>,</span><br><span class="line">type_name string comment <span class="string">&#x27;类别名&#x27;</span>,</span><br><span class="line">supplier_phone string comment <span class="string">&#x27;供应商手机号&#x27;</span>,</span><br><span class="line">supplier_address string comment <span class="string">&#x27;供应商地址&#x27;</span>,</span><br><span class="line">product_price string comment <span class="string">&#x27;商品价格&#x27;</span>,</span><br><span class="line">product_desc string comment <span class="string">&#x27;商品说明&#x27;</span>,</span><br><span class="line">start_time string comment <span class="string">&#x27;有效期起始时间&#x27;</span>,</span><br><span class="line">end_time string comment <span class="string">&#x27;有效期终止时间&#x27;</span>,</span><br><span class="line">product_name string comment <span class="string">&#x27;商品名称&#x27;</span>,</span><br><span class="line">create_time string comment <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">update_time string comment <span class="string">&#x27;更新时间&#x27;</span></span><br><span class="line">) comment <span class="string">&#x27;商品信息表&#x27;</span></span><br><span class="line">partitioned <span class="keyword">by</span>(dt string)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--创建清单记录表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> ods_sale_info;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ods_sale_info( </span><br><span class="line">order_id string comment <span class="string">&#x27;清单号&#x27;</span>,</span><br><span class="line">order_status string comment <span class="string">&#x27;清单状态&#x27;</span>, </span><br><span class="line">market_id string comment<span class="string">&#x27; 超市分店编号&#x27;</span>,</span><br><span class="line">product_num <span class="type">int</span> comment <span class="string">&#x27;商品数量&#x27;</span>,</span><br><span class="line">product_id <span class="type">int</span> comment <span class="string">&#x27;商品id&#x27;</span>,</span><br><span class="line">create_time string comment <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">update_time string comment <span class="string">&#x27;更新时间&#x27;</span></span><br><span class="line">) comment <span class="string">&#x27;清单记录表&#x27;</span></span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (dt string)</span><br><span class="line"><span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line"></span><br><span class="line"># 查看到新建成功的表</span><br><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line">OK</span><br><span class="line">course</span><br><span class="line">ods_market_info</span><br><span class="line">ods_product_info</span><br><span class="line">ods_sale_info</span><br><span class="line">stu</span><br><span class="line">stu1</span><br><span class="line"><span class="type">Time</span> taken: <span class="number">0.026</span> seconds, Fetched: <span class="number">6</span> <span class="type">row</span>(s)</span><br></pre></td></tr></table></figure>

<h3 id="准备业务数据"><a href="#准备业务数据" class="headerlink" title="准备业务数据"></a>准备业务数据</h3><ul>
<li><p>批量造mysql表的数据，采用存储过程的方式</p>
</li>
<li><p>mysql中创建业务关系表，product_info（商品信息表）、market_info（超市分店信息表）、sale_info（清单记录表）</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>p </span><br><span class="line">use hive</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建商品信息表，以id为主键</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> product_info(</span><br><span class="line">id <span class="type">int</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="keyword">null</span> auto_increment <span class="keyword">primary</span> key,</span><br><span class="line">product_id <span class="type">int</span> comment <span class="string">&#x27;商品id&#x27;</span>,</span><br><span class="line">type_name <span class="type">varchar</span>(<span class="number">100</span>) comment <span class="string">&#x27;类别名&#x27;</span>,</span><br><span class="line">supplier_phone <span class="type">varchar</span>(<span class="number">100</span>) comment <span class="string">&#x27;供应商手机号&#x27;</span>,</span><br><span class="line">supplier_address <span class="type">varchar</span>(<span class="number">100</span>) comment <span class="string">&#x27;供应商地址&#x27;</span>,</span><br><span class="line">product_price <span class="type">varchar</span>(<span class="number">100</span>) comment <span class="string">&#x27;商品价格&#x27;</span>,</span><br><span class="line">product_desc <span class="type">varchar</span>(<span class="number">100</span>) comment <span class="string">&#x27;商品说明&#x27;</span>,</span><br><span class="line">start_time <span class="type">varchar</span>(<span class="number">100</span>) comment <span class="string">&#x27;有效期起始时间&#x27;</span>,</span><br><span class="line">end_time <span class="type">varchar</span>(<span class="number">100</span>) comment <span class="string">&#x27;有效期终止时间&#x27;</span>,</span><br><span class="line">product_name <span class="type">varchar</span>(<span class="number">100</span>) comment <span class="string">&#x27;商品名称&#x27;</span>,</span><br><span class="line">create_time <span class="type">varchar</span>(<span class="number">100</span>) comment <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">update_time <span class="type">varchar</span>(<span class="number">100</span>) comment <span class="string">&#x27;更新时间&#x27;</span></span><br><span class="line">) engine<span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建超市分店信息表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> market_info(</span><br><span class="line">id <span class="type">int</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="keyword">null</span> auto_increment <span class="keyword">primary</span> key,</span><br><span class="line">market_id <span class="type">varchar</span>(<span class="number">100</span>) comment <span class="string">&#x27;超市分店编号&#x27;</span>,</span><br><span class="line">market_address <span class="type">varchar</span>(<span class="number">100</span>) comment <span class="string">&#x27;超市分店地址&#x27;</span>,</span><br><span class="line">start_time <span class="type">varchar</span>(<span class="number">100</span>) comment <span class="string">&#x27;有效期起始时间&#x27;</span>,</span><br><span class="line">end_time <span class="type">varchar</span>(<span class="number">100</span>) comment <span class="string">&#x27;有效期终止时间&#x27;</span>,</span><br><span class="line">market_name <span class="type">varchar</span>(<span class="number">100</span>) comment <span class="string">&#x27;超市分店名称&#x27;</span>,</span><br><span class="line">create_time <span class="type">varchar</span>(<span class="number">100</span>) comment <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">update_time <span class="type">varchar</span>(<span class="number">100</span>) comment <span class="string">&#x27;更新时间&#x27;</span></span><br><span class="line">) engine<span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">--创建清单记录表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> sale_info( </span><br><span class="line">id <span class="type">int</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="keyword">null</span> auto_increment <span class="keyword">primary</span> key,</span><br><span class="line">order_id <span class="type">varchar</span>(<span class="number">100</span>) comment <span class="string">&#x27;清单号&#x27;</span>,</span><br><span class="line">order_status <span class="type">varchar</span>(<span class="number">100</span>) comment <span class="string">&#x27;清单状态&#x27;</span>, </span><br><span class="line">market_id <span class="type">varchar</span>(<span class="number">100</span>) comment<span class="string">&#x27; 超市分店编号&#x27;</span>,</span><br><span class="line">product_num <span class="type">int</span> comment <span class="string">&#x27;商品数量&#x27;</span>,</span><br><span class="line">product_id <span class="type">int</span> comment <span class="string">&#x27;商品id&#x27;</span>,</span><br><span class="line">create_time <span class="type">varchar</span>(<span class="number">100</span>) comment <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">update_time <span class="type">varchar</span>(<span class="number">100</span>) comment <span class="string">&#x27;更新时间&#x27;</span></span><br><span class="line">) engine<span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 查看到各个新建的三个表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="operator">|</span> market_info                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> product_info                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sale_info                     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+</span></span><br><span class="line"><span class="number">77</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h4><h5 id="超市分店"><a href="#超市分店" class="headerlink" title="超市分店"></a>超市分店</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p </span><br><span class="line">use hive</span><br><span class="line"></span><br><span class="line">insert into market_info(market_id,market_address,start_time,end_time,market_name,create_time,update_time) values (&#x27;1000001&#x27;,&#x27;湖南省长沙市开福区万达广场1021号&#x27;,&#x27;2021-12-16&#x27;,&#x27;2028-12-17&#x27;,&#x27;大润发开福万达店&#x27;,&#x27;2021-12-12&#x27;,&#x27;2021-12-12&#x27;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">insert into market_info(market_id,market_address,start_time,end_time,market_name,create_time,update_time) values (&#x27;1000002&#x27;,&#x27;湖南省长沙市岳麓区万达广场1021号&#x27;,&#x27;2021-12-16&#x27;,&#x27;2028-12-17&#x27;,&#x27;大润发岳麓万达店&#x27;,&#x27;2021-12-12&#x27;,&#x27;2021-12-12&#x27;);</span><br><span class="line"></span><br><span class="line">insert into market_info(market_id,market_address,start_time,end_time,market_name,create_time,update_time) values (&#x27;1000003&#x27;,&#x27;湖南省长沙市雨花区万达广场1021号&#x27;,&#x27;2021-12-16&#x27;,&#x27;2028-12-16&#x27;,&#x27;大润发雨花万达店&#x27;,&#x27;2021-12-12&#x27;,&#x27;2021-12-12&#x27;);</span><br></pre></td></tr></table></figure>

<h5 id="商品表-存储过程"><a href="#商品表-存储过程" class="headerlink" title="商品表-存储过程"></a>商品表-存储过程</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>p </span><br><span class="line">use hive</span><br><span class="line"></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">procedure</span> insert_product_info;</span><br><span class="line">delimiter <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> insert_product_info(type_name <span class="type">varchar</span>(<span class="number">100</span>),product_price <span class="type">varchar</span>(<span class="number">100</span>),start_time <span class="type">varchar</span>(<span class="number">100</span>),end_time <span class="type">varchar</span>(<span class="number">100</span>),create_time <span class="type">varchar</span>(<span class="number">100</span>),update_time <span class="type">varchar</span>(<span class="number">100</span>),num <span class="type">int</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">declare</span> str <span class="type">char</span>(<span class="number">62</span>) <span class="keyword">default</span> <span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span>;</span><br><span class="line"><span class="keyword">declare</span> product_name <span class="type">char</span>(<span class="number">100</span>);</span><br><span class="line"><span class="keyword">declare</span> product_id <span class="type">int</span>;</span><br><span class="line"><span class="keyword">declare</span> i <span class="type">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">while i<span class="operator">&lt;=</span> num DO</span><br><span class="line"><span class="comment">-- 生成商品名称随机数</span></span><br><span class="line"><span class="keyword">set</span> product_name<span class="operator">=</span>concat(&quot;商品名称&quot;,<span class="built_in">substring</span>(str,<span class="number">1</span><span class="operator">+</span><span class="built_in">floor</span>(rand()<span class="operator">*</span><span class="number">61</span>),<span class="number">2</span>),<span class="built_in">substring</span>(str,<span class="number">1</span><span class="operator">+</span><span class="built_in">floor</span>(rand()<span class="operator">*</span><span class="number">61</span>),<span class="number">3</span>));</span><br><span class="line"><span class="comment">-- 生成商品ID随机数</span></span><br><span class="line"><span class="keyword">set</span> product_id <span class="operator">=</span> <span class="built_in">floor</span>(rand()<span class="operator">*</span><span class="number">1000</span>);</span><br><span class="line"><span class="keyword">set</span> i<span class="operator">=</span>i<span class="operator">+</span><span class="number">1</span>; </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `hive`.`product_info` (`product_id`, `type_name`, `supplier_phone`, `supplier_address`, `product_price`, `product_desc`, `start_time`, `end_time`, `product_name`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (product_id, type_name, <span class="string">&#x27;18576759590&#x27;</span>, <span class="string">&#x27;湖南省常德市&#x27;</span>, product_price, <span class="string">&#x27;产品描述&#x27;</span>, start_time, end_time, product_name, create_time, update_time);</span><br><span class="line"><span class="keyword">end</span> while; </span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"># 下面这种方式调用，后面的<span class="number">100</span>就是插入<span class="number">100</span>条数据</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">call</span> insert_product_info(<span class="string">&#x27;食品&#x27;</span>,<span class="string">&#x27;50&#x27;</span>,<span class="string">&#x27;2021-12-16&#x27;</span>, <span class="string">&#x27;2022-12-17&#x27;</span>, <span class="string">&#x27;2021-12-15&#x27;</span>,<span class="string">&#x27;2021-12-15&#x27;</span>,<span class="number">100</span>) <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">call</span> insert_product_info(<span class="string">&#x27;酒水&#x27;</span>,<span class="string">&#x27;100&#x27;</span>,<span class="string">&#x27;2021-12-16&#x27;</span>, <span class="string">&#x27;2022-12-17&#x27;</span>, <span class="string">&#x27;2021-12-15&#x27;</span>,<span class="string">&#x27;2021-12-15&#x27;</span>,<span class="number">100</span>) <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"># 查询到各个插入成功的数据</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> product_info;<span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">202</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>数据列表</li>
</ul>
<p><img src="/aposts/bcb72660/image-20211217165223721.png" alt="image-20211217165223721"></p>
<h5 id="清单记录表-存储过程"><a href="#清单记录表-存储过程" class="headerlink" title="清单记录表-存储过程"></a>清单记录表-存储过程</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>p </span><br><span class="line">use hive</span><br><span class="line"></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">procedure</span> insert_sale_info;</span><br><span class="line">delimiter <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> insert_sale_info(order_status <span class="type">varchar</span>(<span class="number">10</span>),market_id <span class="type">varchar</span>(<span class="number">100</span>),product_num <span class="type">int</span>,product_id <span class="type">int</span>,create_time <span class="type">varchar</span>(<span class="number">100</span>),update_time <span class="type">varchar</span>(<span class="number">100</span>),num <span class="type">int</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">declare</span> order_id <span class="type">int</span>;</span><br><span class="line"><span class="keyword">declare</span> i <span class="type">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">while i<span class="operator">&lt;=</span> num DO</span><br><span class="line"><span class="keyword">set</span> i<span class="operator">=</span>i<span class="operator">+</span><span class="number">1</span>; </span><br><span class="line"><span class="comment">-- 随机生成订单id</span></span><br><span class="line"><span class="keyword">set</span> order_id <span class="operator">=</span> <span class="built_in">floor</span>(rand()<span class="operator">*</span><span class="number">100</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `hive`.`sale_info` (`order_id`, `order_status`, `market_id`, `product_num`, `product_id`, `create_time`, `update_time`) <span class="keyword">VALUES</span> (order_id, order_status, market_id, product_num, product_id, create_time, update_time);</span><br><span class="line"><span class="keyword">end</span> while; </span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"># 注意<span class="operator">/</span><span class="operator">/</span>这个分隔符，是区分存储过程的，调用存储过程注意market_id，product_id的值，要从相应的超市分店，商品信息表中找到对应数据</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">call</span> insert_sale_info(<span class="string">&#x27;待付款&#x27;</span>,<span class="string">&#x27;1000001&#x27;</span>,<span class="number">5</span>, <span class="number">221</span>,<span class="string">&#x27;2021-12-15&#x27;</span>,<span class="string">&#x27;2021-12-15&#x27;</span>,<span class="number">100</span>) <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">call</span> insert_sale_info(<span class="string">&#x27;已付款&#x27;</span>,<span class="string">&#x27;1000002&#x27;</span>,<span class="number">10</span>, <span class="number">182</span>, <span class="string">&#x27;2021-12-14&#x27;</span>,<span class="string">&#x27;2021-12-14&#x27;</span>,<span class="number">100</span>) <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"># 查询到刚刚插入的数据</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> sale_info;<span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">203</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>数据列表如下</li>
</ul>
<p><img src="/aposts/bcb72660/image-20211217170539691.png" alt="image-20211217170539691"></p>
<h3 id="业务数据导入ODS-datax"><a href="#业务数据导入ODS-datax" class="headerlink" title="业务数据导入ODS-datax"></a>业务数据导入ODS-datax</h3><h4 id="datax-环境搭建"><a href="#datax-环境搭建" class="headerlink" title="datax 环境搭建"></a>datax 环境搭建</h4><ul>
<li>建议自己用源代码编译方式，比较稳妥</li>
<li>下载源文件解压</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/alibaba/DataX/archive/master.zip</span><br><span class="line">unzip DataX-master.zip </span><br></pre></td></tr></table></figure>

<ul>
<li>下载maven</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo wget --no-check-certificate  https://dlcdn.apache.org/maven/maven-3/3.8.4/binaries/apache-maven-3.8.4-bin.tar.gz</span><br><span class="line"></span><br><span class="line">tar -zxvf apache-maven-3.8.4-bin.tar.gz</span><br><span class="line"><span class="comment"># 配置maven环境变量 </span></span><br><span class="line">vi /etc/profile </span><br><span class="line"></span><br><span class="line"> <span class="built_in">export</span> M2_HOME=/usr/local/apache-maven-3.8.4 //本地maven安装home目录</span><br><span class="line"> <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$M2_HOME</span>/bin</span><br><span class="line"> <span class="comment"># 生效环境变量设置</span></span><br><span class="line"> <span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>

<p><img src="/aposts/bcb72660/image-20211221090119715.png" alt="image-20211221090119715"></p>
<ul>
<li>配置maven本地仓库,   进如本地maven安装目录里的conf目录，   <code>vi settings.xml</code>进行如下修改</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> -- 设置仓库地址</span><br><span class="line"> &lt;localRepository&gt;/usr/local/apache-maven-3.8.4/repo&lt;/localRepository&gt;</span><br><span class="line"> -- 设置阿里云镜像</span><br><span class="line">&lt;mirror&gt;</span><br><span class="line">  &lt;<span class="built_in">id</span>&gt;nexus-aliyun&lt;/id&gt;</span><br><span class="line">  &lt;mirrorOf&gt;central&lt;/mirrorOf&gt;</span><br><span class="line">  &lt;name&gt;Nexus aliyun&lt;/name&gt;</span><br><span class="line">  &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public&lt;/url&gt;</span><br><span class="line">&lt;/mirror&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后查看maven安装结果 maven -version</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-24-13-centos resp]# mvn -version</span><br><span class="line">Apache Maven 3.8.4 (9b656c72d54e5bacbed989b64718c159fe39b537)</span><br><span class="line">Maven home: /usr/local/apache-maven-3.8.4</span><br><span class="line">Java version: 1.8.0_311, vendor: Oracle Corporation, runtime: /usr/local/jdk1.8.0_311/jre</span><br><span class="line">Default locale: en_US, platform encoding: UTF-8</span><br><span class="line">OS name: &quot;linux&quot;, version: &quot;3.10.0-1160.11.1.el7.x86_64&quot;, arch: &quot;amd64&quot;, family: &quot;unix&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>修改datax的目录中的pom.xml中的内容</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mysql.driver.version</span>&gt;</span>8.0.26<span class="tag">&lt;/<span class="name">mysql.driver.version</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- reader --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>mysqlreader<span class="tag">&lt;/<span class="name">module</span>&gt;</span>      </span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>hdfsreader<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>streamreader<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">&lt;!-- writer --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>mysqlwriter<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">module</span>&gt;</span>hdfswriter<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">module</span>&gt;</span>streamwriter<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">     <span class="comment">&lt;!-- common support module --&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">module</span>&gt;</span>plugin-rdbms-util<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">module</span>&gt;</span>plugin-unstructured-storage-util<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">module</span>&gt;</span>hbase20xsqlreader<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">module</span>&gt;</span>hbase20xsqlwriter<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">module</span>&gt;</span>kuduwriter<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>hdfswrite目录下面的pom.xml修改hive和hadoop版本</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">hive.version</span>&gt;</span>3.1.2<span class="tag">&lt;/<span class="name">hive.version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">hadoop.version</span>&gt;</span>3.0.3<span class="tag">&lt;/<span class="name">hadoop.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>在 datax的目录执行编译命令</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mvn -U clean package assembly:assembly -Dmaven.test.skip=<span class="literal">true</span></span><br><span class="line">WARNING] Assembly file: /usr/local/DataX-master/target/datax is not a regular file (it may be a directory). It cannot be attached to the project build <span class="keyword">for</span> installation or deployment.</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Reactor Summary <span class="keyword">for</span> datax-all 0.0.1-SNAPSHOT:</span><br><span class="line">[INFO] kuduwriter ......................................... SUCCESS [  2.148 s]</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD SUCCESS</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>把target目录中的datax.tar.gz移动到指定目录,解压</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-24-13-centos target]<span class="comment"># cp datax.tar.gz /usr/local/</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local/</span><br><span class="line">tar -zxvf datax.tar.gz</span><br></pre></td></tr></table></figure>

<h5 id="数据超市导入ods表"><a href="#数据超市导入ods表" class="headerlink" title="数据超市导入ods表"></a>数据超市导入ods表</h5><ul>
<li><p>创建分区信息，手动创建分区路径</p>
</li>
<li><p>不过奇怪的是我用下面命令的方式创建，用datax导入报错找不到创建的分区</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs dfs -<span class="built_in">mkdir</span> -p /user/hive/warehouse/hive.db/ods_market_info/dt=2021-12-21</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>用sql原生语句insert插入一条数据后</strong>，重新datax导入就成功了</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> ods_market_info <span class="keyword">partition</span>(dt <span class="operator">=</span> <span class="string">&#x27;2021-12-21&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换用户</span></span><br><span class="line">su hadoop</span><br><span class="line"><span class="comment"># 进入到hive模式</span></span><br><span class="line">hive</span><br><span class="line"><span class="comment"># 使用hive数据库</span></span><br><span class="line">use hive;</span><br><span class="line"><span class="comment"># 手动插入分区信息内容</span></span><br><span class="line">hive&gt;insert into ods_market_info partition(dt = <span class="string">&#x27;2021-12-21&#x27;</span>) values (<span class="string">&#x27;111&#x27;</span>,<span class="string">&#x27;222&#x27;</span>,<span class="string">&#x27;33&#x27;</span>,<span class="string">&#x27;44&#x27;</span>,<span class="string">&#x27;55&#x27;</span>,<span class="string">&#x27;66&#x27;</span>,<span class="string">&#x27;77&#x27;</span>);</span><br><span class="line"><span class="comment"># 查看到刚刚插入的信息</span></span><br><span class="line">hive&gt;select * from ods_market_info;</span><br><span class="line"><span class="comment"># 新增完后，可以删除表中数据，也可不删</span></span><br><span class="line">hive&gt;<span class="built_in">truncate</span> table ods_market_info;</span><br><span class="line">hive&gt;<span class="built_in">exit</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>查看到分区信息</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@VM-24-13-centos root]$ hadoop fs -ls /user/hive/warehouse/hive.db/ods_market_info/</span><br><span class="line">drwxr-xr-x   - hadoop supergroup          0 2021-12-22 15:57 /user/hive/warehouse/hive.db/ods_market_info/dt=2021-12-21</span><br><span class="line">drwxr-xr-x   - hadoop supergroup          0 2021-12-22 15:57 /user/hive/warehouse/hive.db/ods_market_info/dt=2021-12-22</span><br></pre></td></tr></table></figure>

<ul>
<li><p>在datax的job目录编写一个mysql_hive_ods_market_info.json文件，同步超市分店配置用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-24-13-centos job]<span class="comment"># ls</span></span><br><span class="line">job.json  mysql_hive_ods_market_info.json</span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑mysql_hive_ods_market_info.json文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;job&quot;: &#123;</span><br><span class="line">		&quot;setting&quot;: &#123;</span><br><span class="line">			&quot;speed&quot;: &#123;</span><br><span class="line">				&quot;channel&quot;: 1</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		&quot;content&quot;: [&#123;</span><br><span class="line">			 &quot;reader&quot;: &#123;</span><br><span class="line">                    &quot;name&quot;: &quot;mysqlreader&quot;,</span><br><span class="line">                    &quot;parameter&quot;: &#123;</span><br><span class="line">                        &quot;column&quot;: [</span><br><span class="line">                            &quot;market_id&quot;,</span><br><span class="line">							&quot;market_address&quot;,</span><br><span class="line">							&quot;start_time&quot;,</span><br><span class="line">							&quot;end_time&quot;,</span><br><span class="line">							&quot;market_name&quot;,</span><br><span class="line">							&quot;create_time&quot;,</span><br><span class="line">							&quot;update_time&quot;							</span><br><span class="line">                        ],</span><br><span class="line">                        &quot;connection&quot;: [</span><br><span class="line">                            &#123;</span><br><span class="line">                                &quot;jdbcUrl&quot;: [</span><br><span class="line">                                    &quot;jdbc:mysql://localhost:3306/hive&quot;</span><br><span class="line">                                ],</span><br><span class="line">                                &quot;table&quot;: [</span><br><span class="line">                                    &quot;market_info&quot;</span><br><span class="line">                                ]</span><br><span class="line">                            &#125;</span><br><span class="line">                        ],</span><br><span class="line">                        &quot;password&quot;: &quot;hive1234&quot;,</span><br><span class="line">                        &quot;username&quot;: &quot;hive&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line"></span><br><span class="line">			&quot;writer&quot;: &#123;</span><br><span class="line">				&quot;name&quot;: &quot;hdfswriter&quot;,</span><br><span class="line">				&quot;parameter&quot;: &#123;</span><br><span class="line">					&quot;defaultFS&quot;: &quot;hdfs://localhost:9000&quot;,</span><br><span class="line">					&quot;fileType&quot;: &quot;text&quot;,</span><br><span class="line">					&quot;path&quot;: &quot;/user/hive/warehouse/hive.db/ods_market_info/dt=2021-12-21&quot;,</span><br><span class="line">					&quot;fileName&quot;: &quot;ods_market_info&quot;,</span><br><span class="line">					&quot;column&quot;: [&#123;</span><br><span class="line">							&quot;name&quot;: &quot;market_id&quot;,</span><br><span class="line">							&quot;type&quot;: &quot;string&quot;</span><br><span class="line">						&#125;,</span><br><span class="line">						&#123;</span><br><span class="line">							&quot;name&quot;: &quot;market_address&quot;,</span><br><span class="line">							&quot;type&quot;: &quot;string&quot;</span><br><span class="line">						&#125;,</span><br><span class="line">						&#123;</span><br><span class="line">							&quot;name&quot;: &quot;start_time&quot;,</span><br><span class="line">							&quot;type&quot;: &quot;string&quot;</span><br><span class="line">						&#125;,</span><br><span class="line">						&#123;</span><br><span class="line">							&quot;name&quot;: &quot;end_time&quot;,</span><br><span class="line">							&quot;type&quot;: &quot;string&quot;</span><br><span class="line">						&#125;,</span><br><span class="line">						&#123;</span><br><span class="line">							&quot;name&quot;: &quot;market_name&quot;,</span><br><span class="line">							&quot;type&quot;: &quot;string&quot;</span><br><span class="line">						&#125;,</span><br><span class="line">						&#123;</span><br><span class="line">							&quot;name&quot;: &quot;create_time&quot;,</span><br><span class="line">							&quot;type&quot;: &quot;string&quot;</span><br><span class="line">						&#125;,</span><br><span class="line">						&#123;</span><br><span class="line">							&quot;name&quot;: &quot;update_time&quot;,</span><br><span class="line">							&quot;type&quot;: &quot;string&quot;</span><br><span class="line">						&#125;</span><br><span class="line">					],</span><br><span class="line">					&quot;writeMode&quot;: &quot;append&quot;,</span><br><span class="line">					&quot;fieldDelimiter&quot;: &quot;\t&quot;,</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;]</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>hive&gt; show create table hive.ods_market_info;<br>…..<br>LOCATION<br>‘hdfs:&#x2F;&#x2F;localhost:9000&#x2F;user&#x2F;hive&#x2F;warehouse&#x2F;hive.db&#x2F;ods_market_info’<br>….</p>
<p>执行命令后在结果中可以看到LOCATOIN,就是hive在hdfs中的存储目录。填写到writer下的path中，dt就是刚刚创建的分区</p>
</blockquote>
</li>
<li><p>运行datax命令</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 回到root用户</span><br><span class="line">[hadoop@VM-24-13-centos root]$ su</span><br><span class="line">[root@VM-24-13-centos ~]# cd /usr/local/datax/bin/</span><br><span class="line"># DHADOOP_USER_NAME一定要用hadoop用户，用其他用户会报错没有权限</span><br><span class="line">[root@VM-24-13-centos bin]# python datax.py -p &quot;-DHADOOP_USER_NAME=hadoop&quot; ../job/mysql_hive_ods_market_info.json</span><br></pre></td></tr></table></figure>

<p><img src="/aposts/bcb72660/image-20211222172711034.png" alt="image-20211222172711034"></p>
<ul>
<li>查看hive中的超市表中是否有数据</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@VM-24-13-centos bin]# su hadoop</span><br><span class="line">[hadoop@VM-24-13-centos bin]$ hive</span><br><span class="line"><span class="meta prompt_">hive&gt; </span><span class="language-bash">select * from hive.ods_market_info;</span></span><br><span class="line">000001 湖南省长沙市开福区万达广场1021号        2021-12-16 00:00:00     2028-12-16 23:59:59     大润发开福万达店        2021-12-12 16:00:00     2021-12-12 16:00:00   2021-12-21</span><br><span class="line">1000002 湖南省长沙市岳麓万达广场1021号  2021-12-16 00:00:00     2028-12-16 23:59:59     大润发岳麓万达店        2021-12-12 16:00:00     2021-12-12 16:00:00  2021-12-21</span><br></pre></td></tr></table></figure>

<h5 id="商品信息导入ods表"><a href="#商品信息导入ods表" class="headerlink" title="商品信息导入ods表"></a>商品信息导入ods表</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换用户</span></span><br><span class="line">su hadoop</span><br><span class="line"><span class="comment"># 进入到hive模式</span></span><br><span class="line">hive</span><br><span class="line"><span class="comment"># 使用hive数据库</span></span><br><span class="line">use hive;</span><br><span class="line"><span class="comment"># 手动插入分区信息内容</span></span><br><span class="line">hive&gt;insert into ods_product_info partition(dt = <span class="string">&#x27;2021-12-21&#x27;</span>) VALUES (11, <span class="string">&#x27;222&#x27;</span>, <span class="string">&#x27;18576759590&#x27;</span>, <span class="string">&#x27;湖南省常德市&#x27;</span>, <span class="string">&#x27;222&#x27;</span>, <span class="string">&#x27;产品描述&#x27;</span>, <span class="string">&#x27;333&#x27;</span>, <span class="string">&#x27;444&#x27;</span>, <span class="string">&#x27;555&#x27;</span>, <span class="string">&#x27;666&#x27;</span>, <span class="string">&#x27;77&#x27;</span>);</span><br><span class="line"><span class="comment"># 查看到刚刚插入的信息</span></span><br><span class="line">hive&gt;select * from ods_product_info;</span><br><span class="line"><span class="comment"># 新增完后，可以删除表中数据，也可不删</span></span><br><span class="line">hive&gt;<span class="built_in">truncate</span> table ods_product_info;</span><br><span class="line">hive&gt;<span class="built_in">exit</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>查看到分区信息</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@VM-24-13-centos root]$ hadoop fs -ls /user/hive/warehouse/hive.db/ods_product_info/</span><br><span class="line">drwxr-xr-x   - hadoop supergroup          0 2021-12-23 09:31 /user/hive/warehouse/hive.db/ods_product_info/dt=2021-12-21</span><br></pre></td></tr></table></figure>

<ul>
<li><p>在datax的job目录编写一个mysql_hive_ods_product_info.json文件，同步超市分店配置用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-24-13-centos job]<span class="comment"># ls</span></span><br><span class="line">-rwxrwxrwx 1 root root 1587 Dec 21 18:05 job.json</span><br><span class="line">-rw-r--r-- 1 root root 1861 Dec 22 15:54 mysql_hive_ods_market_info.json</span><br><span class="line">-rw-r--r-- 1 root root 1861 Dec 23 09:36 mysql_hive_ods_product_info.json</span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑mysql_hive_ods_productinfo.json文件</p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;job&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;setting&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;speed&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;channel&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">			<span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">			 <span class="attr">&quot;reader&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mysqlreader&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;parameter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;column&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                            <span class="string">&quot;product_id&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="string">&quot;type_name&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="string">&quot;supplier_phone&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="string">&quot;supplier_address&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="string">&quot;product_price&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="string">&quot;product_desc&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="string">&quot;start_time&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="string">&quot;end_time&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="string">&quot;product_name&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="string">&quot;create_time&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="string">&quot;update_time&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;connection&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                            <span class="punctuation">&#123;</span></span><br><span class="line">                                <span class="attr">&quot;jdbcUrl&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                                    <span class="string">&quot;jdbc:mysql://localhost:3306/hive&quot;</span></span><br><span class="line">                                <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;table&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                                    <span class="string">&quot;product_info&quot;</span></span><br><span class="line">                                <span class="punctuation">]</span></span><br><span class="line">                            <span class="punctuation">&#125;</span></span><br><span class="line">                        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hive1234&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hive&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">			<span class="attr">&quot;writer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hdfswriter&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;parameter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;defaultFS&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hdfs://localhost:9000&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;fileType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/user/hive/warehouse/hive.db/ods_product_info/dt=2021-12-21&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;fileName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ods_product_info&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;column&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">							<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;product_id&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;int&quot;</span></span><br><span class="line">						<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">						<span class="punctuation">&#123;</span></span><br><span class="line">							<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;type_name&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">						<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">						<span class="punctuation">&#123;</span></span><br><span class="line">							<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;supplier_phone&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">						<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">						<span class="punctuation">&#123;</span></span><br><span class="line">							<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;supplier_address&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">						<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">						<span class="punctuation">&#123;</span></span><br><span class="line">							<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;product_price&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">						<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">						<span class="punctuation">&#123;</span></span><br><span class="line">							<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;product_desc&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">						<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">						<span class="punctuation">&#123;</span></span><br><span class="line">							<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;start_time&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">						<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">						<span class="punctuation">&#123;</span></span><br><span class="line">							<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;end_time&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">						<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">						<span class="punctuation">&#123;</span></span><br><span class="line">							<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;product_name&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">						<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">						<span class="punctuation">&#123;</span></span><br><span class="line">							<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;create_time&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">						<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">						<span class="punctuation">&#123;</span></span><br><span class="line">							<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;update_time&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">						<span class="punctuation">&#125;</span></span><br><span class="line">					<span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;writeMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;append&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;fieldDelimiter&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>运行datax命令</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 回到root用户</span><br><span class="line">[hadoop@VM-24-13-centos root]$ su</span><br><span class="line">[root@VM-24-13-centos ~]# cd /usr/local/datax/bin/</span><br><span class="line"># DHADOOP_USER_NAME一定要用hadoop用户，用其他用户会报错没有权限</span><br><span class="line">[root@VM-24-13-centos bin]# python datax.py -p &quot;-DHADOOP_USER_NAME=hadoop&quot; ../job/mysql_hive_ods_product_info.json</span><br><span class="line"></span><br><span class="line">任务启动时刻                    : 2021-12-23 10:30:52</span><br><span class="line">任务结束时刻                    : 2021-12-23 10:31:05</span><br><span class="line">任务总计耗时                    :                 12s</span><br><span class="line">任务平均流量                    :            2.22KB/s</span><br><span class="line">记录写入速度                    :             20rec/s</span><br><span class="line">读出记录总数                    :                 201</span><br><span class="line">读写失败总数                    :                   0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>查看hive中的商品表中是否有数据</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">su hadoop</span><br><span class="line">hive</span><br><span class="line">use hive;</span><br><span class="line">hive&gt; select count(product_id) from ods_product_info;</span><br><span class="line">Total MapReduce CPU Time Spent: 0 msec</span><br><span class="line">OK</span><br><span class="line">201</span><br><span class="line">Time taken: 2.154 seconds, Fetched: 1 row(s)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="销售事实导入ods表"><a href="#销售事实导入ods表" class="headerlink" title="销售事实导入ods表"></a>销售事实导入ods表</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">切换用户</span></span><br><span class="line">su hadoop</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入到hive模式</span></span><br><span class="line">hive</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用hive数据库</span></span><br><span class="line">use hive;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">手动插入分区信息内容</span></span><br><span class="line"><span class="meta prompt_">hive&gt;</span><span class="language-bash">insert into ods_sale_info partition(dt = <span class="string">&#x27;2021-12-21&#x27;</span>) values (1, <span class="string">&#x27;222&#x27;</span>, <span class="string">&#x27;333&#x27;</span>, 4, 55, <span class="string">&#x27;666&#x27;</span>, <span class="string">&#x27;77&#x27;</span>);</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看到刚刚插入的信息</span></span><br><span class="line"><span class="meta prompt_">hive&gt;</span><span class="language-bash">select * from ods_sale_info;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">新增完后，可以删除表中数据，也可不删</span></span><br><span class="line"><span class="meta prompt_">hive&gt;</span><span class="language-bash"><span class="built_in">truncate</span> table ods_sale_info;</span></span><br><span class="line"><span class="meta prompt_">hive&gt;</span><span class="language-bash"><span class="built_in">exit</span>;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>查看到分区信息</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@VM-24-13-centos root]$ hadoop fs -ls /user/hive/warehouse/hive.db/ods_sale_info/</span><br><span class="line">drwxr-xr-x   - hadoop supergroup          0 2021-12-23 11:09 /user/hive/warehouse/hive.db/ods_sale_info/dt=2021-12-21</span><br></pre></td></tr></table></figure>

<ul>
<li><p>在datax的job目录编写一个mysql_hive_ods_sale_info.json文件，同步销售事实表配置用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-24-13-centos job]<span class="comment"># ls</span></span><br><span class="line">-rwxrwxrwx 1 root root 1587 Dec 21 18:05 job.json</span><br><span class="line">-rw-r--r-- 1 root root 1861 Dec 22 15:54 mysql_hive_ods_market_info.json</span><br><span class="line">-rw-r--r-- 1 root root 2267 Dec 23 10:28 mysql_hive_ods_product_info.json</span><br><span class="line">-rw-r--r-- 1 root root 2267 Dec 23 11:06 mysql_hive_ods_sale_info.json</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑mysql_hive_ods_productinfo.json文件</p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;job&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;setting&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;speed&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;channel&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">			<span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">			 <span class="attr">&quot;reader&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mysqlreader&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;parameter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;column&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                            <span class="string">&quot;order_id&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="string">&quot;order_status&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="string">&quot;market_id&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="string">&quot;product_num&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="string">&quot;product_id&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="string">&quot;create_time&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="string">&quot;update_time&quot;</span></span><br><span class="line">                        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;connection&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                            <span class="punctuation">&#123;</span></span><br><span class="line">                                <span class="attr">&quot;jdbcUrl&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                                    <span class="string">&quot;jdbc:mysql://localhost:3306/hive&quot;</span></span><br><span class="line">                                <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;table&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                                    <span class="string">&quot;sale_info&quot;</span></span><br><span class="line">                                <span class="punctuation">]</span></span><br><span class="line">                            <span class="punctuation">&#125;</span></span><br><span class="line">                        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hive1234&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hive&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">			<span class="attr">&quot;writer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hdfswriter&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;parameter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;defaultFS&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hdfs://localhost:9000&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;fileType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/user/hive/warehouse/hive.db/ods_sale_info/dt=2021-12-21&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;fileName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ods_sale_info&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;column&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">							<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;order_id&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">						<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">						<span class="punctuation">&#123;</span></span><br><span class="line">							<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;order_status&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">						<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">						<span class="punctuation">&#123;</span></span><br><span class="line">							<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;market_id&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">						<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">						<span class="punctuation">&#123;</span></span><br><span class="line">							<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;product_num&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;int&quot;</span></span><br><span class="line">						<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">						<span class="punctuation">&#123;</span></span><br><span class="line">							<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;product_id&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;int&quot;</span></span><br><span class="line">						<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">						<span class="punctuation">&#123;</span></span><br><span class="line">							<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;create_time&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">						<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">						<span class="punctuation">&#123;</span></span><br><span class="line">							<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;update_time&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">						<span class="punctuation">&#125;</span></span><br><span class="line">					<span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;writeMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;append&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;fieldDelimiter&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>运行datax</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 回到root用户</span></span><br><span class="line">[hadoop@VM-24-13-centos root]$ su</span><br><span class="line">[root@VM-24-13-centos ~]<span class="comment"># cd /usr/local/datax/bin/</span></span><br><span class="line"><span class="comment"># DHADOOP_USER_NAME一定要用hadoop用户，用其他用户会报错没有权限</span></span><br><span class="line">[root@VM-24-13-centos bin]<span class="comment"># python datax.py -p &quot;-DHADOOP_USER_NAME=hadoop&quot; ../job/mysql_hive_ods_sale_info.json</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">任务启动时刻                    : 2021-12-23 11:17:21</span><br><span class="line">任务结束时刻                    : 2021-12-23 11:17:34</span><br><span class="line">任务总计耗时                    :                 12s</span><br><span class="line">任务平均流量                    :            1.07KB/s</span><br><span class="line">记录写入速度                    :             20rec/s</span><br><span class="line">读出记录总数                    :                 202</span><br><span class="line">读写失败总数                    :                   0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>查看hive中的销售事实表是否有数据</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">su hadoop</span><br><span class="line">hive</span><br><span class="line">use hive;</span><br><span class="line">hive&gt; select count(order_id) from ods_sale_info;</span><br><span class="line"></span><br><span class="line">Stage-Stage-1:  HDFS Read: 27232 HDFS Write: 0 SUCCESS</span><br><span class="line">Total MapReduce CPU Time Spent: 0 msec</span><br><span class="line">OK</span><br><span class="line">202</span><br></pre></td></tr></table></figure>

<ul>
<li>再次导入一次数据，造成重复的脏数据，为下一步数据清洗例子做准备</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-24-13-centos bin]# python datax.py -p &quot;-DHADOOP_USER_NAME=hadoop&quot; ../job/mysql_hive_ods_sale_info.json</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>查看 hive中的销售事实表存在了404条数据，有一半重复的</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">su hadoop</span><br><span class="line">hive</span><br><span class="line">use hive;</span><br><span class="line">hive&gt; select count(order_id) from ods_sale_info;</span><br><span class="line"></span><br><span class="line">Stage-Stage-1:  HDFS Read: 27232 HDFS Write: 0 SUCCESS</span><br><span class="line">Total MapReduce CPU Time Spent: 0 msec</span><br><span class="line">OK</span><br><span class="line">404</span><br></pre></td></tr></table></figure>

<h3 id="数据清洗"><a href="#数据清洗" class="headerlink" title="数据清洗"></a>数据清洗</h3><ul>
<li>在业务数据导入到ods层时，可能一些误操作，脏数据等，需要对ods层的数据进行清洗处理，本次就以ods_sale_info表中去重重复的order_id</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">su hadoop</span><br><span class="line">hive</span><br><span class="line">use hive;</span><br><span class="line"></span><br><span class="line">hive&gt;drop table if exists tmp_ods_to_dwd_sale_info;</span><br><span class="line">create table tmp_ods_to_dwd_sale_info</span><br><span class="line">as select a.order_id,a.order_status,a.market_id,a.product_num,a.product_id,a.create_time,a.update_time from</span><br><span class="line">(select order_id,order_status,market_id,product_num,product_id,create_time,update_time, ROW_NUMBER() OVER(partition by order_id order BY create_time DESC) rn FROM ods_sale_info) a</span><br><span class="line">WHERE a.rn=1;</span><br><span class="line"></span><br><span class="line"># 查看到的只有85条数据</span><br><span class="line">hive&gt; select count(*) from  tmp_ods_to_dwd_sale_info;</span><br><span class="line">OK</span><br><span class="line">85</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/yimingsilence/article/details/70140877">数据去重及row_number()</a></li>
</ul>
<h2 id="数据明细层DWD"><a href="#数据明细层DWD" class="headerlink" title="数据明细层DWD"></a>数据明细层DWD</h2><ul>
<li>数据清洗完毕后，把ODS层数据导入到OWD层</li>
</ul>
<h3 id="数据仓库建模"><a href="#数据仓库建模" class="headerlink" title="数据仓库建模"></a>数据仓库建模</h3><ul>
<li>在数据仓库层，采用星形模式创建超市分店维度表、商品维度表、日期维度表和销售事实表</li>
</ul>
<h4 id="维度建模"><a href="#维度建模" class="headerlink" title="维度建模"></a>维度建模</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"># 切换到hadoop用户</span><br><span class="line">su hadoop</span><br><span class="line"># 进入到hive</span><br><span class="line">hive</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建超市分维度表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> dw_dim_market_info;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> dw_dim_market_info(</span><br><span class="line">market_id string comment <span class="string">&#x27;超市分店编号&#x27;</span>,</span><br><span class="line">market_address string comment <span class="string">&#x27;超市分店地址&#x27;</span>,</span><br><span class="line">effective_date string comment <span class="string">&#x27;有效期起始时间&#x27;</span>,</span><br><span class="line">expriry_date string comment <span class="string">&#x27;有效期终止时间&#x27;</span>,</span><br><span class="line">market_name string comment <span class="string">&#x27;超市分店名称&#x27;</span></span><br><span class="line">) comment <span class="string">&#x27;创建超市分维度表&#x27;</span></span><br><span class="line">partitioned <span class="keyword">by</span>(dt string)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"><span class="comment">--创建商品维度表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> dw_dim_product_info;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> dw_dim_product_info(</span><br><span class="line">product_id <span class="type">int</span> comment <span class="string">&#x27;商品id&#x27;</span>,</span><br><span class="line">type_name string comment <span class="string">&#x27;类别名&#x27;</span>,</span><br><span class="line">supplier_phone string comment <span class="string">&#x27;供应商手机号&#x27;</span>,</span><br><span class="line">supplier_address string comment <span class="string">&#x27;供应商地址&#x27;</span>,</span><br><span class="line">product_price string comment <span class="string">&#x27;商品价格&#x27;</span>,</span><br><span class="line">product_desc string comment <span class="string">&#x27;商品说明&#x27;</span>,</span><br><span class="line">effective_date string comment <span class="string">&#x27;有效期起始时间&#x27;</span>,</span><br><span class="line">expriry_date string comment <span class="string">&#x27;有效期终止时间&#x27;</span>,</span><br><span class="line">product_name string comment <span class="string">&#x27;商品名称&#x27;</span></span><br><span class="line">) comment <span class="string">&#x27;商品维度表&#x27;</span></span><br><span class="line">partitioned <span class="keyword">by</span>(dt string)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--创建日期维度表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> dw_dim_date_info;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> dw_dim_date_info( </span><br><span class="line">date_id string comment <span class="string">&#x27;日期id&#x27;</span>,</span><br><span class="line">year_value string comment <span class="string">&#x27;年&#x27;</span>, </span><br><span class="line">month_value string comment<span class="string">&#x27;月&#x27;</span>,</span><br><span class="line">day_value string comment <span class="string">&#x27;日&#x27;</span>,</span><br><span class="line">date_value string comment <span class="string">&#x27;年-月-日&#x27;</span>,</span><br><span class="line">is_weekend string comment <span class="string">&#x27;是否周末&#x27;</span>, <span class="comment">-- 0表示非周末，1表示周末</span></span><br><span class="line">day_of_week string comment <span class="string">&#x27;一周中的周几&#x27;</span></span><br><span class="line">) comment <span class="string">&#x27;日期维度表&#x27;</span></span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (dt string)</span><br><span class="line"><span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--创建销售事实表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> dwd_sale_fact;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> dwd_sale_fact( </span><br><span class="line">order_id string comment <span class="string">&#x27;清单号&#x27;</span>,</span><br><span class="line">order_status string comment <span class="string">&#x27;清单状态&#x27;</span>, </span><br><span class="line">market_id string comment<span class="string">&#x27; 超市分店编号&#x27;</span>,</span><br><span class="line">date_id string comment <span class="string">&#x27;日期id&#x27;</span>,</span><br><span class="line">product_num <span class="type">int</span> comment <span class="string">&#x27;商品数量&#x27;</span>,</span><br><span class="line">product_id <span class="type">int</span> comment <span class="string">&#x27;商品id&#x27;</span>,</span><br><span class="line">create_time string comment <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">update_time string comment <span class="string">&#x27;更新时间&#x27;</span></span><br><span class="line">) comment <span class="string">&#x27;销售事实表&#x27;</span></span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (dt string)</span><br><span class="line"><span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 查看到新建成功的表</span><br><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line">OK</span><br><span class="line">course</span><br><span class="line">dw_dim_date_info</span><br><span class="line">dw_dim_market_info</span><br><span class="line">dw_dim_product_info</span><br><span class="line">dwd_sale_fact</span><br><span class="line">ods_market_info</span><br><span class="line">ods_product_info</span><br><span class="line">ods_sale_info</span><br><span class="line">stu</span><br><span class="line">stu1</span><br><span class="line">tmp_ods_to_dwd_sale_info</span><br></pre></td></tr></table></figure>

<h4 id="导入ODS层数据"><a href="#导入ODS层数据" class="headerlink" title="导入ODS层数据"></a>导入ODS层数据</h4><ul>
<li>把数据接入层（ODS）导入到维度表中</li>
</ul>
<h5 id="日期维度表"><a href="#日期维度表" class="headerlink" title="日期维度表"></a>日期维度表</h5><ul>
<li>初始化一些测试数据，注意date_value这个字段的值，需要和<code>tmp_ods_to_dwd_sale_info</code>中的<code>create_time</code>有关联关系，要造一些相等条件的数据</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">su hadoop</span><br><span class="line">hive</span><br><span class="line">hive<span class="operator">&gt;</span>use hive;</span><br><span class="line">hive<span class="operator">&gt;</span><span class="keyword">insert</span> <span class="keyword">into</span> dw_dim_date_info <span class="keyword">partition</span>(dt <span class="operator">=</span> <span class="string">&#x27;2021-12-21&#x27;</span>) <span class="keyword">VALUES</span> (<span class="string">&#x27;2021122101&#x27;</span>, <span class="string">&#x27;2021&#x27;</span>, <span class="string">&#x27;12&#x27;</span>,<span class="string">&#x27;15&#x27;</span>,<span class="string">&#x27;2021-12-15&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;51&#x27;</span>);</span><br><span class="line"></span><br><span class="line">hive<span class="operator">&gt;</span><span class="keyword">insert</span> <span class="keyword">into</span> dw_dim_date_info <span class="keyword">partition</span>(dt <span class="operator">=</span> <span class="string">&#x27;2021-12-21&#x27;</span>) <span class="keyword">VALUES</span> (<span class="string">&#x27;2021122102&#x27;</span>, <span class="string">&#x27;2021&#x27;</span>, <span class="string">&#x27;12&#x27;</span>, <span class="string">&#x27;24&#x27;</span>,<span class="string">&#x27;2021-12-24&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;51&#x27;</span>);</span><br><span class="line"></span><br><span class="line">hive<span class="operator">&gt;</span><span class="keyword">insert</span> <span class="keyword">into</span> dw_dim_date_info <span class="keyword">partition</span>(dt <span class="operator">=</span> <span class="string">&#x27;2021-12-21&#x27;</span>) <span class="keyword">VALUES</span> (<span class="string">&#x27;2021122103&#x27;</span>, <span class="string">&#x27;2021&#x27;</span>, <span class="string">&#x27;12&#x27;</span>, <span class="string">&#x27;25&#x27;</span>,<span class="string">&#x27;2021-12-25&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;51&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> dw_dim_date_info;</span><br><span class="line">OK</span><br><span class="line"><span class="number">2021122101</span>      <span class="number">2021</span>    <span class="number">12</span>      <span class="number">15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">0</span>       <span class="number">51</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-21</span></span><br><span class="line"><span class="number">2021122102</span>      <span class="number">2021</span>    <span class="number">12</span>      <span class="number">24</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-24</span>      <span class="number">0</span>       <span class="number">51</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-21</span></span><br><span class="line"><span class="number">2021122103</span>      <span class="number">2021</span>    <span class="number">12</span>      <span class="number">25</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-25</span>      <span class="number">1</span>       <span class="number">51</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-21</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="超市维度表"><a href="#超市维度表" class="headerlink" title="超市维度表"></a>超市维度表</h5><ul>
<li>ods_market_info 表数据插入</li>
<li><strong>此次实例中，好像没有用到</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">hive<span class="operator">&gt;</span><span class="keyword">insert</span> <span class="keyword">into</span> dw_dim_market_info <span class="keyword">partition</span>(dt <span class="operator">=</span> <span class="string">&#x27;2021-12-21&#x27;</span>) <span class="keyword">select</span> market_id,market_address,market_name,start_time <span class="keyword">as</span> effective_date,end_time <span class="keyword">as</span> expiry_date</span><br><span class="line"><span class="keyword">from</span> ods_market_info;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> dw_dim_market_info;</span><br><span class="line">OK</span><br><span class="line"><span class="number">1000001</span> 湖南省长沙市开福区万达广场<span class="number">1021</span>号        大润发开福万达店        <span class="number">2021</span><span class="number">-12</span><span class="number">-16</span>      <span class="number">2028</span><span class="number">-12</span><span class="number">-17</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-21</span></span><br><span class="line"><span class="number">1000002</span> 湖南省长沙市岳麓区万达广场<span class="number">1021</span>号        大润发岳麓万达店        <span class="number">2021</span><span class="number">-12</span><span class="number">-16</span>      <span class="number">2028</span><span class="number">-12</span><span class="number">-17</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-21</span></span><br><span class="line"><span class="number">1000003</span> 湖南省长沙市雨花区万达广场<span class="number">1021</span>号        大润发雨花万达店        <span class="number">2021</span><span class="number">-12</span><span class="number">-16</span>      <span class="number">2028</span><span class="number">-12</span><span class="number">-16</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-21</span></span><br></pre></td></tr></table></figure>

<h5 id="商品维度表"><a href="#商品维度表" class="headerlink" title="商品维度表"></a>商品维度表</h5><ul>
<li>ods_product_info表数据插入</li>
<li><strong>此次实例中，好像没有用到</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">hive<span class="operator">&gt;</span><span class="keyword">insert</span> <span class="keyword">into</span> dw_dim_product_info <span class="keyword">partition</span>(dt <span class="operator">=</span> <span class="string">&#x27;2021-12-21&#x27;</span>) <span class="keyword">select</span> product_id,product_name,type_name,supplier_phone,supplier_address,product_price,product_desc,start_time <span class="keyword">as</span> effective_date,end_time <span class="keyword">as</span> expiry_date</span><br><span class="line"><span class="keyword">from</span> ods_product_info;</span><br><span class="line"></span><br><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> dw_dim_product_info;</span><br><span class="line">OK</span><br><span class="line"><span class="number">221</span>     商品名称<span class="number">78</span>ABC   食品    <span class="number">18576759590</span>     湖南省常德市    <span class="number">50</span>      产品描述        <span class="number">2021</span><span class="number">-12</span><span class="number">-16</span>      <span class="number">2022</span><span class="number">-12</span><span class="number">-17</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-21</span></span><br><span class="line"><span class="number">545</span>     商品名称XYyzA   食品    <span class="number">18576759590</span>     湖南省常德市    <span class="number">50</span>      产品描述        <span class="number">2021</span><span class="number">-12</span><span class="number">-16</span>      <span class="number">2022</span><span class="number">-12</span><span class="number">-17</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-21</span></span><br><span class="line"><span class="number">639</span>     商品名称GHdef   食品    <span class="number">18576759590</span>     湖南省常德市    <span class="number">50</span>      产品描述        <span class="number">2021</span><span class="number">-12</span><span class="number">-16</span>      <span class="number">2022</span><span class="number">-12</span><span class="number">-17</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-21</span></span><br><span class="line"><span class="number">459</span>     商品名称cdtuv   食品    <span class="number">18576759590</span>     湖南省常德市    <span class="number">50</span>      产品描述        <span class="number">2021</span><span class="number">-12</span><span class="number">-16</span>      <span class="number">2022</span><span class="number">-12</span><span class="number">-17</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-21</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="销售事实表"><a href="#销售事实表" class="headerlink" title="销售事实表"></a>销售事实表</h5><ul>
<li><code>tmp_ods_to_dwd_sale_info</code>表是上述处理重复销售清单记录表的过滤后的临时表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">hive<span class="operator">&gt;</span><span class="keyword">insert</span> <span class="keyword">into</span> dwd_sale_fact <span class="keyword">partition</span>(dt <span class="operator">=</span> <span class="string">&#x27;2021-12-21&#x27;</span>) <span class="keyword">select</span> a.order_id,a.order_status,a.market_id,b.date_id,a.product_num,a.product_id,a.create_time,a.update_time</span><br><span class="line"><span class="keyword">from</span> tmp_ods_to_dwd_sale_info a</span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> dw_dim_date_info b</span><br><span class="line"><span class="keyword">on</span> a.create_time<span class="operator">=</span>b.date_value;</span><br><span class="line"></span><br><span class="line">#  查询到<span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>的关联数据</span><br><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> dwd_sale_fact;</span><br><span class="line">OK</span><br><span class="line"><span class="number">11</span>      待付款  <span class="number">1000001</span> <span class="number">2021122101</span>      <span class="number">5</span>       <span class="number">221</span>     <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-21</span></span><br><span class="line"><span class="number">12</span>      待付款  <span class="number">1000001</span> <span class="number">2021122101</span>      <span class="number">5</span>       <span class="number">221</span>     <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-21</span></span><br><span class="line"><span class="number">14</span>      待付款  <span class="number">1000001</span> <span class="number">2021122101</span>      <span class="number">5</span>       <span class="number">221</span>     <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-21</span></span><br><span class="line"><span class="number">16</span>      待付款  <span class="number">1000001</span> <span class="number">2021122101</span>      <span class="number">5</span>       <span class="number">221</span>     <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-21</span></span><br><span class="line"><span class="number">17</span>      待付款  <span class="number">1000001</span> <span class="number">2021122101</span>      <span class="number">5</span>       <span class="number">221</span>     <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-21</span></span><br><span class="line"><span class="number">20</span>      待付款  <span class="number">1000001</span> <span class="number">2021122101</span>      <span class="number">5</span>       <span class="number">221</span>     <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-21</span></span><br><span class="line">....</span><br></pre></td></tr></table></figure>

<h2 id="数据汇总层DWS"><a href="#数据汇总层DWS" class="headerlink" title="数据汇总层DWS"></a>数据汇总层DWS</h2><ul>
<li>由于我们要统计商品A的销售量，以及商品A的购买比例，因此在数据汇总层，对销售数据按照清单号进行汇总，并添加include_product_a 字段，用于表示该清单是否商品A（本实例中的商品id为221），处理过程如下：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建DWS层清单记录表</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> dws_order_info;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> dws_order_info (</span><br><span class="line">order_id string comment <span class="string">&#x27;清单号&#x27;</span>,</span><br><span class="line">order_status string comment <span class="string">&#x27;清单状态&#x27;</span>, </span><br><span class="line">market_id string comment<span class="string">&#x27; 超市分店编号&#x27;</span>,</span><br><span class="line">include_product_a <span class="type">int</span> comment <span class="string">&#x27;是否包括商品A&#x27;</span>,</span><br><span class="line">date_id string comment <span class="string">&#x27;日期id&#x27;</span>,</span><br><span class="line">a_num <span class="type">int</span> comment <span class="string">&#x27;商品A数量&#x27;</span>,</span><br><span class="line">product_info string comment <span class="string">&#x27;商品信息&#x27;</span>,</span><br><span class="line">create_time string comment <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">update_time string comment <span class="string">&#x27;更新时间&#x27;</span></span><br><span class="line">) comment <span class="string">&#x27;清单记录表&#x27;</span></span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (dt string)</span><br><span class="line"><span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建中间表，添加is_product_a字段</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> tmp_dwd_to_dws_order_info;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tmp_dwd_to_dws_order_info <span class="keyword">as</span> <span class="keyword">select</span> </span><br><span class="line">order_id,order_status,market_id,date_id,</span><br><span class="line"><span class="keyword">Case</span> </span><br><span class="line"><span class="keyword">when</span> product_id<span class="operator">=</span><span class="number">221</span> <span class="keyword">then</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">else</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span> <span class="keyword">as</span> is_product_a, <span class="comment">-- 是否为商品A</span></span><br><span class="line"><span class="keyword">case</span> </span><br><span class="line"><span class="keyword">when</span> product_id<span class="operator">=</span><span class="number">221</span> <span class="keyword">then</span> product_num</span><br><span class="line"><span class="keyword">else</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span> <span class="keyword">as</span> a_num, <span class="comment">-- 商品A的数量</span></span><br><span class="line">product_id,</span><br><span class="line">product_num,</span><br><span class="line">create_time,</span><br><span class="line">update_time</span><br><span class="line"><span class="keyword">from</span> dwd_sale_fact;</span><br><span class="line"></span><br><span class="line"># 查询到以及过滤的product_id为<span class="number">221</span>的清单数据</span><br><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tmp_dwd_to_dws_order_info;</span><br><span class="line">OK</span><br><span class="line"><span class="number">11</span>      待付款  <span class="number">1000001</span> <span class="number">2021122101</span>      <span class="number">1</span>       <span class="number">5</span>       <span class="number">221</span>     <span class="number">5</span>       <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span></span><br><span class="line"><span class="number">12</span>      待付款  <span class="number">1000001</span> <span class="number">2021122101</span>      <span class="number">1</span>       <span class="number">5</span>       <span class="number">221</span>     <span class="number">5</span>       <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span></span><br><span class="line"><span class="number">14</span>      待付款  <span class="number">1000001</span> <span class="number">2021122101</span>      <span class="number">1</span>       <span class="number">5</span>       <span class="number">221</span>     <span class="number">5</span>       <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span></span><br><span class="line"><span class="number">16</span>      待付款  <span class="number">1000001</span> <span class="number">2021122101</span>      <span class="number">1</span>       <span class="number">5</span>       <span class="number">221</span>     <span class="number">5</span>       <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span></span><br><span class="line"><span class="number">17</span>      待付款  <span class="number">1000001</span> <span class="number">2021122101</span>      <span class="number">1</span>       <span class="number">5</span>       <span class="number">221</span>     <span class="number">5</span>       <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span></span><br><span class="line"><span class="number">20</span>      待付款  <span class="number">1000001</span> <span class="number">2021122101</span>      <span class="number">1</span>       <span class="number">5</span>       <span class="number">221</span>     <span class="number">5</span>       <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span></span><br><span class="line"><span class="number">22</span>      待付款  <span class="number">1000001</span> <span class="number">2021122101</span>      <span class="number">1</span>       <span class="number">5</span>       <span class="number">221</span>     <span class="number">5</span>       <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span></span><br><span class="line"><span class="number">23</span>      待付款  <span class="number">1000001</span> <span class="number">2021122101</span>      <span class="number">1</span>       <span class="number">5</span>       <span class="number">221</span>     <span class="number">5</span>       <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span></span><br><span class="line"><span class="number">24</span>      待付款  <span class="number">1000001</span> <span class="number">2021122101</span>      <span class="number">1</span>       <span class="number">5</span>       <span class="number">221</span>     <span class="number">5</span>       <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span></span><br><span class="line"><span class="number">25</span>      待付款  <span class="number">1000001</span> <span class="number">2021122101</span>      <span class="number">1</span>       <span class="number">5</span>       <span class="number">221</span>     <span class="number">5</span>       <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 按照清单号进行清单数据汇总</span></span><br><span class="line">hive<span class="operator">&gt;</span><span class="keyword">insert</span> <span class="keyword">into</span> dws_order_info <span class="keyword">partition</span>(dt <span class="operator">=</span> <span class="string">&#x27;2021-12-21&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> order_id,order_status,market_id,date_id,</span><br><span class="line"><span class="keyword">case</span></span><br><span class="line"><span class="keyword">when</span> <span class="built_in">sum</span>(is_product_a)<span class="operator">&gt;</span><span class="number">0</span> <span class="keyword">then</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">else</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span> <span class="keyword">as</span> include_product_a,</span><br><span class="line"><span class="built_in">sum</span>(a_num) <span class="keyword">as</span> a_num,</span><br><span class="line">concat_ws(<span class="string">&#x27;_&#x27;</span>,collect_list(<span class="built_in">cast</span>(product_id <span class="keyword">as</span> string)),collect_list(<span class="built_in">cast</span>(product_num <span class="keyword">as</span> string))) <span class="keyword">as</span> product_info,</span><br><span class="line">create_time,update_time</span><br><span class="line"><span class="keyword">from</span> tmp_dwd_to_dws_order_info <span class="keyword">group</span> <span class="keyword">by</span> order_id,order_status,market_id,date_id,create_time,update_time;</span><br><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> dws_order_info;</span><br><span class="line">OK</span><br><span class="line"><span class="number">11</span>      待付款  <span class="number">1000001</span> <span class="number">2021122101</span>      <span class="number">1</span>       <span class="number">5</span>       <span class="number">221</span>_5   <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-21</span></span><br><span class="line"><span class="number">12</span>      待付款  <span class="number">1000001</span> <span class="number">2021122101</span>      <span class="number">1</span>       <span class="number">5</span>       <span class="number">221</span>_5   <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-21</span></span><br><span class="line"><span class="number">14</span>      待付款  <span class="number">1000001</span> <span class="number">2021122101</span>      <span class="number">1</span>       <span class="number">5</span>       <span class="number">221</span>_5   <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-21</span></span><br><span class="line"><span class="number">16</span>      待付款  <span class="number">1000001</span> <span class="number">2021122101</span>      <span class="number">1</span>       <span class="number">5</span>       <span class="number">221</span>_5   <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-21</span></span><br><span class="line"><span class="number">17</span>      待付款  <span class="number">1000001</span> <span class="number">2021122101</span>      <span class="number">1</span>       <span class="number">5</span>       <span class="number">221</span>_5   <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-21</span></span><br><span class="line"><span class="number">20</span>      待付款  <span class="number">1000001</span> <span class="number">2021122101</span>      <span class="number">1</span>       <span class="number">5</span>       <span class="number">221</span>_5   <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-15</span>      <span class="number">2021</span><span class="number">-12</span><span class="number">-21</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/ygdlx521/article/details/71156354">Hive中case when的两种语法</a></li>
<li>参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_37536446/article/details/80597480">hive中对多行进行合</a></li>
<li>发现个奇怪问题，<strong>插入的字段居然要和表中的顺序一致，不然为空</strong>，比如<code>product_info</code>就有这样的问题</li>
</ul>
<h2 id="数据集市层DWM"><a href="#数据集市层DWM" class="headerlink" title="数据集市层DWM"></a>数据集市层DWM</h2><ul>
<li>在数据集市层，需要对相关指标进行聚合计算，处理过程如下。</li>
<li><strong>此处商品A的id为221</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> dwn_order_info_by_day;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> dwn_order_info_by_day</span><br><span class="line"><span class="keyword">as</span> <span class="keyword">select</span></span><br><span class="line"><span class="built_in">count</span>(<span class="keyword">distinct</span> c.order_id) <span class="keyword">as</span> consumption_num, <span class="comment">-- 商品A销售清单</span></span><br><span class="line"><span class="built_in">sum</span>(c.a_num) <span class="keyword">as</span> day_num, <span class="comment">-- 商品A消费总数</span></span><br><span class="line"><span class="built_in">sum</span>(c.include_product_a)<span class="operator">/</span><span class="built_in">count</span>(<span class="keyword">distinct</span> c.order_id) <span class="keyword">as</span> buy_a_rate <span class="comment">-- 购买商品A的消费比例</span></span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">a.order_id <span class="keyword">as</span> order_id,</span><br><span class="line">a.a_num <span class="keyword">as</span> a_num,</span><br><span class="line">a.include_product_a <span class="keyword">as</span> include_product_a,</span><br><span class="line">b.year_value <span class="keyword">as</span> year_value,</span><br><span class="line">b.month_value <span class="keyword">as</span> month_value,</span><br><span class="line">b.day_value <span class="keyword">as</span> day_value </span><br><span class="line"><span class="keyword">from</span> dws_order_info a </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> dw_dim_date_info b <span class="keyword">on</span> a.date_id<span class="operator">=</span>b.date_id) c </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> c.day_value;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询到商品A的购买数据记录</span></span><br><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> dwn_order_info_by_day;</span><br><span class="line">OK</span><br><span class="line"><span class="number">62</span>      <span class="number">310</span>     <span class="number">2.021122101E9</span></span><br><span class="line"><span class="type">Time</span> taken: <span class="number">0.098</span> seconds, Fetched: <span class="number">1</span> <span class="type">row</span>(s)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>以上就是数据从数据源经过ETL处理最终加载到数据仓库的整个过程。在实际业务过程中，数据规模庞大、业务逻辑复杂，需要生成大量的ETL处理任务，因此在数据仓库设计过程中，需要考虑中间层数据的通用性。在调度系统（如Airflow、Azkaban等）的调度下，这些ETL任务分批有序执行，最终生成报表等应用所需的数据</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://louis-me.github.io/aposts/ae85ee2e/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="一个正经的测试工程师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="施坤的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/aposts/ae85ee2e/" class="post-title-link" itemprop="url">第四章 大数据之hive搭建</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-07 16:56:19" itemprop="dateCreated datePublished" datetime="2021-12-07T16:56:19+08:00">2021-12-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-25 11:20:56" itemprop="dateModified" datetime="2022-02-25T11:20:56+08:00">2022-02-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">大数据</span></a>
                </span>
            </span>

          
            <span id="/aposts/ae85ee2e/" class="post-meta-item leancloud_visitors" data-flag-title="第四章 大数据之hive搭建" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/aposts/ae85ee2e/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/aposts/ae85ee2e/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><ul>
<li>学习本教程，请先看完<a target="_blank" rel="noopener" href="https://moon-full.gitee.io/2021/12/07/%E7%AC%AC%E4%B8%89%E7%AB%A0%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E4%B9%8BHadoop%E6%90%AD%E5%BB%BA/">第三章 大数据之Hadoop搭建</a></li>
<li>本次教程主要来自<a target="_blank" rel="noopener" href="http://dblab.xmu.edu.cn/blog/1080-2/">基于Hadoop的数据仓库Hive 学习指南</a>，本次的内容全部经过了自己的实践，与参考文档中不一致的地方，也是经过查询各种资料和实践通过</li>
</ul>
<h2 id="hive简单介绍"><a href="#hive简单介绍" class="headerlink" title="hive简单介绍"></a>hive简单介绍</h2><p>使用 hive 的命令行接口，感觉很像操作关系数据库，但是 hive 和关系数据库还是有很大的不同，下面我就比较下 hive 与关系数据库的区别，具体如下：</p>
<ul>
<li>Hive 和关系数据库存储文件的系统不同，Hive 使用的是 hadoop 的 HDFS（hadoop 的分布式文件系统），关系数据库则是服务器本地的文件系统；</li>
<li>hive 使用的计算模型是 mapreduce，而关系数据库则是自己设计的计算模型；</li>
<li>关系数据库都是为实时查询的业务进行设计的，而 Hive 则是为海量数据做数据挖掘设计的，实时性很差；实时性的区别导致 Hive 的应用场景和关系数据库有很大的不同；</li>
</ul>
<h2 id="安装hive"><a href="#安装hive" class="headerlink" title="安装hive"></a>安装hive</h2><ul>
<li>下载版本选择为3.1.2</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-24-13-centos <span class="built_in">local</span>]<span class="comment"># wget --no-check-certificate  https://dlcdn.apache.org/hive/hive-3.1.2/apache-hive-3.1.2-bin.tar.gz</span></span><br><span class="line"></span><br><span class="line">sudo tar -zxvf ./apache-hive-3.1.2-bin.tar.gz -C /usr/local   <span class="comment"># 解压到/usr/local中</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local/</span><br><span class="line">sudo <span class="built_in">mv</span> apache-hive-3.1.2-bin hive       <span class="comment"># 将文件夹名改为hive</span></span><br><span class="line">sudo <span class="built_in">chown</span> -R hadoop:hadoop hive   <span class="comment"># 修改文件权限</span></span><br></pre></td></tr></table></figure>

<h2 id="配置环境"><a href="#配置环境" class="headerlink" title="配置环境"></a>配置环境</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@VM-24-13-centos local]$ vi ~/.bashrc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">export HIVE_HOME=/usr/local/hive</span><br><span class="line">export PATH=$PATH:$HIVE_HOME/bin</span><br><span class="line">export HADOOP_HOME=/usr/local/hadoop</span><br></pre></td></tr></table></figure>

<ul>
<li><p>生效环境变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure>


</li>
<li><p><strong>修改<code>/usr/local/hive/conf</code>下的hive-site.xml</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/hive/conf</span><br><span class="line"><span class="built_in">mv</span> hive-default.xml.template hive-default.xml</span><br><span class="line"></span><br><span class="line">[hadoop@VM-24-13-centos conf]$ vi hive-site.xml</span><br><span class="line"></span><br><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> standalone=<span class="string">&quot;no&quot;</span>?&gt;</span><br><span class="line">&lt;?xml-stylesheet <span class="built_in">type</span>=<span class="string">&quot;text/xsl&quot;</span> href=<span class="string">&quot;configuration.xsl&quot;</span>?&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;javax.jdo.option.ConnectionURL&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;jdbc:mysql://localhost:3306/hive?createDatabaseIfNotExist=<span class="literal">true</span>&lt;/value&gt;</span><br><span class="line">    &lt;description&gt;JDBC connect string <span class="keyword">for</span> a JDBC metastore&lt;/description&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;javax.jdo.option.ConnectionDriverName&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;com.mysql.jdbc.Driver&lt;/value&gt;</span><br><span class="line">    &lt;description&gt;Driver class name <span class="keyword">for</span> a JDBC metastore&lt;/description&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;javax.jdo.option.ConnectionUserName&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;hive&lt;/value&gt;</span><br><span class="line">    &lt;description&gt;username to use against metastore database&lt;/description&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;javax.jdo.option.ConnectionPassword&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;hive1234&lt;/value&gt;</span><br><span class="line">    &lt;description&gt;记得在创建用户时，密码要和这个对应&lt;/description&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="安装和配置mysql"><a href="#安装和配置mysql" class="headerlink" title="安装和配置mysql"></a>安装和配置mysql</h2><h3 id="安装mysql"><a href="#安装mysql" class="headerlink" title="安装mysql"></a>安装mysql</h3><ul>
<li>我之前已经装好了，省略此步骤</li>
</ul>
<h3 id="配置mysql"><a href="#配置mysql" class="headerlink" title="配置mysql"></a>配置mysql</h3><ul>
<li>新建hive数据库</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@VM-24-13-centos conf]$ mysql -u root -p</span><br><span class="line">create database hive;  #这个hive数据库与hive-site.xml中localhost:3306/hive的hive对应，用来保存hive元数据</span><br></pre></td></tr></table></figure>

<ul>
<li>配置mysql允许hive接入</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="built_in">set</span> global validate_password.policy=<span class="string">&#x27;LOW&#x27;</span>; <span class="comment"># mysql8后，有密码策略要求，改为低</span></span><br><span class="line">mysql &gt;create user hive@localhost identified by <span class="string">&#x27;hive1234&#x27;</span>;</span><br><span class="line">					<span class="comment"># hive 代表你要创建的此数据库的新用户账号</span></span><br><span class="line">					<span class="comment"># localhost 代表访问本地权限，不可远程访问，还有其他值</span></span><br><span class="line">						<span class="comment"># %代表通配所有host地址权限(可远程访问)</span></span><br><span class="line">						<span class="comment"># 指定特殊Ip访问权限 如10.138.106.10</span></span><br><span class="line">                    <span class="comment"># hive1234代表你要创建的此数据库的新用密码</span></span><br><span class="line">mysql&gt;grant all privileges on  *.* to <span class="string">&#x27;hive&#x27;</span>@<span class="string">&#x27;%&#x27;</span> <span class="comment"># 授权数据库给hive用户</span></span><br><span class="line">mysql&gt; flush privileges;  <span class="comment">#刷新mysql系统权限关系表</span></span><br></pre></td></tr></table></figure>

<h2 id="配置hive"><a href="#配置hive" class="headerlink" title="配置hive"></a>配置hive</h2><h3 id="启动hive"><a href="#启动hive" class="headerlink" title="启动hive"></a>启动hive</h3><ul>
<li><p>启动hive之前，请先启动hadoop集群。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">start-all.sh <span class="comment">#启动hadoop</span></span><br><span class="line">hive  <span class="comment">#启动hive</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; show databases;<span class="comment"># 输入后报错</span></span><br><span class="line">FAILED: HiveException java.lang.RuntimeException: Unable to instantiate org.apache.hadoop.hive.ql.metadata.SessionHiveMetaStoreClient</span><br></pre></td></tr></table></figure>

<ul>
<li>Hive现在包含一个用于 Hive Metastore 架构操控的脱机工具，名为 schematool.此工具可用于初始化当前 Hive 版本的 Metastore 架构。此外，其还可处理从较旧版本到新版本的架构升级，用下面的命令：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@VM-24-13-centos conf]$ schematool -dbType mysql -initSchema</span><br><span class="line"></span><br><span class="line"><span class="comment"># 出现下面的错误，提升驱动载入失败</span></span><br><span class="line">org.apache.hadoop.hive.metastore.HiveMetaException: Failed to load driver</span><br><span class="line">Underlying cause: java.lang.ClassNotFoundException : com.mysql.jdbc.Driver</span><br></pre></td></tr></table></figure>

<ul>
<li>打开<a target="_blank" rel="noopener" href="https://downloads.mysql.com/archives/c-j/">mysql下载链接</a></li>
</ul>
<p><img src="/aposts/ae85ee2e/image-20211208112332826.png" alt="image-20211208112332826"></p>
<ul>
<li>下载安装mysql驱动</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">sudo wget https://downloads.mysql.com/archives/get/p/3/file/mysql-connector-java-8.0.26-1.el7.noarch.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以看到其他都是文档，那么连接驱动文件是/usr/share/java/mysql-connector-java.jar</span></span><br><span class="line">[root@study1 opt]<span class="comment"># rpm -qpl mysql-connector-java-8.0.26-1.el7.noarch.rpm </span></span><br><span class="line">警告：mysql-connector-java-8.0.26-1.el7.noarch.rpm: 头V3 DSA/SHA1 Signature, 密钥 ID 5072e1f5: NOKEY</span><br><span class="line">/usr/share/doc/mysql-connector-java-8.0.26</span><br><span class="line">/usr/share/doc/mysql-connector-java-8.0.26/CHANGES</span><br><span class="line">/usr/share/doc/mysql-connector-java-8.0.26/INFO_BIN</span><br><span class="line">/usr/share/doc/mysql-connector-java-8.0.26/INFO_SRC</span><br><span class="line">/usr/share/doc/mysql-connector-java-8.0.26/LICENSE</span><br><span class="line">/usr/share/doc/mysql-connector-java-8.0.26/README</span><br><span class="line">/usr/share/java/mysql-connector-java.jar</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 安装，提示缺少依赖java-headless且版本要大于1.8版本</span></span><br><span class="line">[root@study1 opt]<span class="comment"># rpm -ivh mysql-connector-java-8.0.26-1.el7.noarch.rpm </span></span><br><span class="line">警告：mysql-connector-java-8.0.26-1.el7.noarch.rpm: 头V3 DSA/SHA1 Signature, 密钥 ID 5072e1f5: NOKEY</span><br><span class="line">错误：依赖检测失败：</span><br><span class="line">	java-headless &gt;= 1:1.8.0 被 mysql-connector-java-1:8.0.26-1.el7.noarch 需要</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">[root@study1 opt]<span class="comment"># yum -y install java-headless</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 再次安装</span></span><br><span class="line">[root@study1 opt]<span class="comment"># rpm -ivh mysql-connector-java-8.0.26-1.el7.noarch.rpm </span></span><br><span class="line">警告：mysql-connector-java-8.0.26-1.el7.noarch.rpm: 头V3 DSA/SHA1 Signature, 密钥 ID 5072e1f5: NOKEY</span><br><span class="line">准备中...                          <span class="comment">################################# [100%]</span></span><br><span class="line">正在升级/安装...</span><br><span class="line">   1:mysql-connector-java-1:8.0.26-1.e<span class="comment">################################# [100%]</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 查看驱动文件</span></span><br><span class="line">[root@study1 opt]<span class="comment"># ll /usr/share/java</span></span><br><span class="line">总用量 2328</span><br><span class="line">-rw-r--r--. 1 root root 2381198 9月  11 05:55 mysql-connector-java.jar</span><br><span class="line"><span class="comment"># 把驱动文件拷贝到hive的lib中</span></span><br><span class="line">[root@study1 opt]<span class="comment"># cp /usr/share/java/mysql-connector-java.jar /usr/local/hive/lib</span></span><br></pre></td></tr></table></figure>

<ul>
<li>再次schematool初始化就可以了</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@VM-24-13-centos local]$ schematool -dbType mysql -initSchema</span><br></pre></td></tr></table></figure>

<ul>
<li>进入hive</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@VM-24-13-centos <span class="built_in">local</span>]$ hive</span><br><span class="line"></span><br><span class="line">hive&gt; show databases;</span><br><span class="line">OK</span><br><span class="line">default</span><br><span class="line">Time taken: 0.02 seconds, Fetched: 1 row(s)</span><br><span class="line">hive&gt; show tables;</span><br><span class="line">OK</span><br><span class="line">Time taken: 0.036 seconds</span><br><span class="line">hive&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果要退出Hive交互式执行环境，可以输入如下命令：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; <span class="built_in">exit</span>;</span><br><span class="line">[hadoop@VM-24-13-centos <span class="built_in">local</span>]$</span><br></pre></td></tr></table></figure>

<h2 id="Hive的常用HiveQL操作"><a href="#Hive的常用HiveQL操作" class="headerlink" title="Hive的常用HiveQL操作"></a>Hive的常用HiveQL操作</h2><h3 id="Hive基本数据类型"><a href="#Hive基本数据类型" class="headerlink" title="Hive基本数据类型"></a>Hive基本数据类型</h3><ul>
<li>Hive支持基本数据类型和复杂类型, 基本数据类型主要有数值类型(INT、FLOAT、DOUBLE ) 、布尔型和字符串, 复杂类型有三种:ARRAY、MAP 和 STRUCT。</li>
</ul>
<h4 id="基本数据类型"><a href="#基本数据类型" class="headerlink" title="基本数据类型"></a>基本数据类型</h4><ul>
<li>TINYINT: 1个字节</li>
<li>SMALLINT: 2个字节</li>
<li>INT: 4个字节</li>
<li>BIGINT: 8个字节</li>
<li>BOOLEAN: TRUE&#x2F;FALSE</li>
<li>FLOAT: 4个字节，单精度浮点型</li>
<li>DOUBLE: 8个字节，双精度浮点型STRING 字符串</li>
</ul>
<h4 id="复杂数据类型"><a href="#复杂数据类型" class="headerlink" title="复杂数据类型"></a>复杂数据类型</h4><ul>
<li>ARRAY: 有序字段</li>
<li>MAP: 无序字段</li>
<li>STRUCT: 一组命名的字段</li>
</ul>
<h3 id="用的HiveQL操作命令"><a href="#用的HiveQL操作命令" class="headerlink" title="用的HiveQL操作命令"></a>用的HiveQL操作命令</h3><ul>
<li><p>Hive常用的HiveQL操作命令主要包括：数据定义、数据操作。接下来详细介绍一下这些命令即用法（想要了解更多请参照《Hive编程指南》一书）</p>
</li>
<li><p>数据定义：主要用于创建修改和删除数据库、表、视图、函数和索引。</p>
</li>
</ul>
<h4 id="创建、修改和删除数据库"><a href="#创建、修改和删除数据库" class="headerlink" title="创建、修改和删除数据库"></a>创建、修改和删除数据库</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">create database if not exists hive;       #创建数据库</span><br><span class="line">show databases;                           #查看Hive中包含数据库</span><br><span class="line">show databases like &#x27;h.*&#x27;;                #查看Hive中以h开头数据库</span><br><span class="line">use hive; # 使用数据库</span><br><span class="line">show tables; # 查看表列表</span><br><span class="line">drop table usr; #  删除表</span><br></pre></td></tr></table></figure>

<h4 id="创建、修改和删除表"><a href="#创建、修改和删除表" class="headerlink" title="创建、修改和删除表"></a>创建、修改和删除表</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">#创建内部表（管理表）</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> hive.usr(</span><br><span class="line">      name string comment <span class="string">&#x27;username&#x27;</span>, # name表示字段命，string表示字段类型，comment后面内容表示说明</span><br><span class="line">      pwd string comment <span class="string">&#x27;password&#x27;</span>,</span><br><span class="line">      address struct<span class="operator">&lt;</span>street:string,city:string,state:string,zip:<span class="type">int</span><span class="operator">&gt;</span> comment  <span class="string">&#x27;home address&#x27;</span>,</span><br><span class="line">      identify map<span class="operator">&lt;</span><span class="type">int</span>,tinyint<span class="operator">&gt;</span> comment <span class="string">&#x27;number,sex&#x27;</span>) comment <span class="string">&#x27;description of the table&#x27;</span>  </span><br><span class="line">     tblproperties(<span class="string">&#x27;creator&#x27;</span><span class="operator">=</span><span class="string">&#x27;me&#x27;</span>,<span class="string">&#x27;time&#x27;</span><span class="operator">=</span><span class="string">&#x27;2016.1.1&#x27;</span>); #tblproperties 设置表的属性 </span><br><span class="line">     </span><br><span class="line">#创建外部表</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">external</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> usr2(</span><br><span class="line">      name string,</span><br><span class="line">      pwd string,</span><br><span class="line">  address struct<span class="operator">&lt;</span>street:string,city:string,state:string,zip:<span class="type">int</span><span class="operator">&gt;</span>,</span><br><span class="line">      identify map<span class="operator">&lt;</span><span class="type">int</span>,tinyint<span class="operator">&gt;</span>) </span><br><span class="line">      <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span> # 字段分隔符来进行分割，如：test1,<span class="number">223456</span>,湖南省</span><br><span class="line">     location <span class="string">&#x27;/usr/local/hive/warehouse/hive.db/usr&#x27;</span>; </span><br><span class="line">     # LOCATION一般与外部表（<span class="keyword">EXTERNAL</span>）一起使用。一般情况下hive元数据默认保存在<span class="operator">&lt;</span>hive.metastore.warehouse.dir<span class="operator">&gt;</span>中。</span><br><span class="line">     # 这个字段的适用场景是：数据已经存在HDFS上不能移动位置了，那么就通过这个字段让表可以直接读到这份数据。另外，要注意建表的时候，应该让表变成外部表。</span><br><span class="line"></span><br><span class="line">#创建分区表</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> usr3(</span><br><span class="line">      name string,</span><br><span class="line">      pwd string,</span><br><span class="line">      address struct<span class="operator">&lt;</span>street:string,city:string,state:string,zip:<span class="type">int</span><span class="operator">&gt;</span>,</span><br><span class="line">      identify map<span class="operator">&lt;</span><span class="type">int</span>,tinyint<span class="operator">&gt;</span>) </span><br><span class="line">      partitioned <span class="keyword">by</span>(city string,state string); # 双分区</span><br><span class="line">      </span><br><span class="line"> #复制usr表的表模式       </span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> hive.usr1 <span class="keyword">like</span> hive.usr;</span><br><span class="line"><span class="keyword">show</span> tables <span class="keyword">in</span> hive;  </span><br><span class="line"><span class="keyword">show</span> tables <span class="string">&#x27;u.*&#x27;</span>;        #查看hive中以u开头的表</span><br><span class="line"><span class="keyword">describe</span> hive.usr;        #查看usr表相关信息</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> hive.usr rename <span class="keyword">to</span> custom;      #重命名表</span><br><span class="line">#为表增加一个分区</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> usr3 <span class="keyword">add</span> if <span class="keyword">not</span> <span class="keyword">exists</span> <span class="keyword">partition</span>(city<span class="operator">=</span>&quot;beijing&quot;,state<span class="operator">=</span>&quot;China&quot;) location <span class="string">&#x27;/usr/local/hive/warehouse/usr3/China/beijing&#x27;</span>; </span><br><span class="line"></span><br><span class="line">#修改分区路径</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> usr3 <span class="keyword">partition</span>(city<span class="operator">=</span>&quot;beijing&quot;,state<span class="operator">=</span>&quot;China&quot;) <span class="keyword">set</span> location <span class="string">&#x27;/usr/local/hive/warehouse/usr3/CH/beijing&#x27;</span>;</span><br><span class="line">#删除分区</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> usr3 <span class="keyword">drop</span> if <span class="keyword">exists</span>  <span class="keyword">partition</span>(city<span class="operator">=</span>&quot;beijing&quot;,state<span class="operator">=</span>&quot;China&quot;);</span><br><span class="line">#修改列信息,注意这里，如果使用 after时，交换元素类型不一致，就无法交换成功</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> custom change <span class="keyword">column</span> username username string after pwd;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> custom <span class="keyword">add</span> columns(hobby string);                  #增加列</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> custom replace columns(uname string);              #删除替换列</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> custom <span class="keyword">set</span> tblproperties(<span class="string">&#x27;creator&#x27;</span><span class="operator">=</span><span class="string">&#x27;liming&#x27;</span>);      #修改表属性</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> usr3 <span class="keyword">partition</span>(city<span class="operator">=</span>&quot;beijing&quot;,state<span class="operator">=</span>&quot;China&quot;) <span class="keyword">set</span> fileformat sequencefile;     #修改存储属性            </span><br><span class="line">use hive;                                                   #切换到hive数据库下</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> usr1;                                  #删除表</span><br><span class="line"><span class="keyword">drop</span> database if <span class="keyword">exists</span> hive cascade;                       #删除数据库和它中的表</span><br></pre></td></tr></table></figure>

<h6 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h6><ul>
<li><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/sx66/p/12039163.html">Hive的数据模型及各模块的应用场景</a> 结合这个<a target="_blank" rel="noopener" href="https://www.cnblogs.com/syx-1987/p/4182967.html">Hive之数据模型</a>来看效果比较好</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/heiren_a/article/details/109119081">Hive在建表时的分隔符的设置</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44736028/article/details/106250453">hive 中的location</a></p>
</li>
</ul>
<h4 id="视图和索引的创建、修改和删除"><a href="#视图和索引的创建、修改和删除" class="headerlink" title="视图和索引的创建、修改和删除"></a>视图和索引的创建、修改和删除</h4><ul>
<li>主要语法如下，用户可自行实现。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create view view_name as....;                <span class="comment">#创建视图</span></span><br><span class="line">alter view view_name <span class="built_in">set</span> tblproperties(…);   <span class="comment">#修改视图</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>因为视图是只读的，所以 对于视图只允许改变元数据中的 tblproperties属性。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#删除视图</span><br><span class="line">drop view if exists view_name;</span><br><span class="line">#创建索引</span><br><span class="line">create index index_name on table table_name(partition_name/column_name)  </span><br><span class="line">as &#x27;org.apache.hadoop.hive.ql.index.compact.CompactIndexHandler&#x27; with deferred rebuild....; </span><br></pre></td></tr></table></figure>
</li>
<li><p>这里’org.apache.hadoop.hive.ql.index.compact.CompactIndexHandler’是一个索引处理器，即一个实现了索引接口的Java类，另外Hive还有其他的索引实现。</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter index index_name on table table_name partition(...)  rebulid;   #重建索引</span><br></pre></td></tr></table></figure>

<ul>
<li>如果使用 deferred rebuild，那么新索引成空白状态，任何时候可以进行第一次索引创建或重建。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">show formatted index on table_name;                       #显示索引</span><br><span class="line">drop index if exists index_name on table table_name;      #删除索引</span><br></pre></td></tr></table></figure>

<h6 id="说明-1"><a href="#说明-1" class="headerlink" title="说明"></a>说明</h6><ul>
<li>这里没有实践，示例可以参考这里<a target="_blank" rel="noopener" href="https://www.cnblogs.com/tsxylhs/p/7341474.html">hadoop Hive 的建表 和导入导出及索引视图</a></li>
</ul>
<h4 id="用户自定义函数"><a href="#用户自定义函数" class="headerlink" title="用户自定义函数"></a>用户自定义函数</h4><ul>
<li><p>没有实践自定义函数，后续有需求在学</p>
</li>
<li><p>在新建用户自定义函数（UDF）方法前，先了解一下Hive自带的那些函数。<code>show functions;</code> 命令会显示Hive中所有的函数名称：</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; show functions;</span><br><span class="line">OK</span><br><span class="line">!</span><br><span class="line">!=</span><br><span class="line">$sum0</span><br><span class="line">....</span><br><span class="line">cardinality_violation</span><br><span class="line">case</span><br><span class="line">cbrt</span><br><span class="line">ceil</span><br><span class="line">ceiling</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ul>
<li>若想要查看具体函数使用方法可使用describe function 函数名：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; describe function abs;</span><br><span class="line">OK</span><br><span class="line">abs(x) - returns the absolute value of x</span><br></pre></td></tr></table></figure>

<ul>
<li><p>首先编写自己的UDF前需要继承UDF类并实现evaluate()函数，或是继承GenericUDF类实现initialize()函数、evaluate()函数和getDisplayString()函数，还有其他的实现方法，感兴趣的用户可以自行学习。</p>
</li>
<li><p>另外，如果用户想在Hive中使用该UDF需要将我们编写的Java代码进行编译，然后将编译后的UDF二进制类文件(.class文件)打包成一个JAR文件，然后在Hive会话中将这个JAR文件加入到类路径下，在通过create function语句定义好使用这个Java类的函数。</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add jar &lt;jar文件的绝对路径&gt;;                        #创建函数</span><br><span class="line">create temporary function function_name;</span><br><span class="line">drop temporary function if exists function_name;    #删除函数</span><br></pre></td></tr></table></figure>

<h3 id="数据操作"><a href="#数据操作" class="headerlink" title="数据操作"></a>数据操作</h3><ul>
<li>主要实现的是将数据装载到表中（或是从表中导出），并进行相应查询操作，对熟悉SQL语言的用户应该不会陌生。</li>
</ul>
<h4 id="向表中装载数据"><a href="#向表中装载数据" class="headerlink" title="向表中装载数据"></a>向表中装载数据</h4><p>这里我们以只有两个属性的简单表为例来介绍。首先创建表stu和course，stu有两个属性id与name，course有两个属性cid与sid。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">create table if not exists hive.stu(id int,name string) </span><br><span class="line">row format delimited fields terminated by &#x27;\t&#x27;;</span><br><span class="line">create table if not exists hive.course(cid int,sid int) </span><br><span class="line">row format delimited fields terminated by &#x27;\t&#x27;;</span><br></pre></td></tr></table></figure>

<ul>
<li>向表中装载数据有两种方法：<strong>从文件中导入和通过查询语句插入</strong>。</li>
</ul>
<h5 id="从文件中导入"><a href="#从文件中导入" class="headerlink" title="从文件中导入"></a>从文件中导入</h5><ul>
<li>假如这个表中的记录存储于文件stu.txt中，该文件的存储路径为&#x2F;usr&#x2F;local&#x2F;hadoop&#x2F;examples&#x2F;stu.txt，内容如下。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># id后面的name分割符号要用键盘上的tab隔开，直接复制过去，导入进去会全部都是null</span><br><span class="line">1	xiapi </span><br><span class="line">2	xiaoxue </span><br><span class="line">3	qingqing</span><br></pre></td></tr></table></figure>

<ul>
<li><p>下面我们把这个文件中的数据装载到表stu中，操作如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">hive<span class="operator">&gt;</span> use hive;</span><br><span class="line">hive<span class="operator">&gt;</span> load data <span class="keyword">local</span> inpath <span class="string">&#x27;/usr/local/hadoop/examples/stu.txt&#x27;</span> overwrite <span class="keyword">into</span> <span class="keyword">table</span> stu;</span><br><span class="line">Loading data <span class="keyword">to</span> <span class="keyword">table</span> hive.stu</span><br><span class="line">OK</span><br><span class="line"># 查询到数据</span><br><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> hive.stu;</span><br><span class="line">OK</span><br><span class="line"><span class="number">1</span>       xiapi</span><br><span class="line"><span class="number">2</span>       xiaoxue</span><br><span class="line"><span class="number">3</span>       qingqing</span><br><span class="line"><span class="type">Time</span> taken: <span class="number">1.324</span> s</span><br></pre></td></tr></table></figure>

<ul>
<li>如果stu.txt文件存储在HDFS 上，则不需要 local 关键字。</li>
</ul>
</li>
</ul>
<h5 id="通过查询语句插入"><a href="#通过查询语句插入" class="headerlink" title="通过查询语句插入"></a>通过查询语句插入</h5><p>使用如下命令，创建stu1表，它和stu表属性相同，我们要把从stu表中查询得到的数据插入到stu1中：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> stu1 <span class="keyword">as</span> <span class="keyword">select</span> id,name <span class="keyword">from</span> stu;</span><br><span class="line">...</span><br><span class="line">Moving data <span class="keyword">to</span> directory hdfs:<span class="operator">/</span><span class="operator">/</span>localhost:<span class="number">9000</span><span class="operator">/</span><span class="keyword">user</span><span class="operator">/</span>hive<span class="operator">/</span>warehouse<span class="operator">/</span>hive.db<span class="operator">/</span>.hive<span class="operator">-</span>staging_hive_2021<span class="number">-12</span><span class="number">-10</span>_10<span class="number">-42</span><span class="number">-32</span>_320_1543053100774530944<span class="number">-1</span><span class="operator">/</span><span class="operator">-</span>ext<span class="number">-10002</span></span><br><span class="line">Moving data <span class="keyword">to</span> directory hdfs:<span class="operator">/</span><span class="operator">/</span>localhost:<span class="number">9000</span><span class="operator">/</span><span class="keyword">user</span><span class="operator">/</span>hive<span class="operator">/</span>warehouse<span class="operator">/</span>hive.db<span class="operator">/</span>stu1</span><br><span class="line">MapReduce Jobs Launched:</span><br><span class="line">Stage<span class="operator">-</span>Stage<span class="number">-1</span>:  HDFS Read: <span class="number">31</span> HDFS Write: <span class="number">114</span> SUCCESS</span><br><span class="line">Total MapReduce CPU <span class="type">Time</span> Spent: <span class="number">0</span> msec</span><br><span class="line">OK</span><br><span class="line"># 查询到stu1表结构如下</span><br><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">describe</span> stu1;</span><br><span class="line">OK</span><br><span class="line">id                      <span class="type">int</span></span><br><span class="line">name                    string</span><br><span class="line"><span class="type">Time</span> taken: <span class="number">0.268</span> seconds, Fetched: <span class="number">2</span> <span class="type">row</span>(s)</span><br></pre></td></tr></table></figure>

<p>上面是创建表，并直接向新表插入数据；若表已经存在，向表中插入数据需执行以下命令：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 这里关键字overwrite的作用是替换掉表（或分区）中原有数据，换成<span class="keyword">into</span>关键字，直接追加到原有内容后。</span><br><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">insert</span> overwrite <span class="keyword">table</span> stu1 <span class="keyword">select</span> id,name <span class="keyword">from</span> stu <span class="keyword">where</span>（id<span class="operator">=</span><span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"></span><br><span class="line"># 查询发现只有id为<span class="number">1</span>的数据，其他数据全部清空</span><br><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> hive.stu1;</span><br><span class="line">OK</span><br><span class="line"><span class="number">1</span>       xiapi</span><br></pre></td></tr></table></figure>

<h4 id="从表中导出数据"><a href="#从表中导出数据" class="headerlink" title="从表中导出数据"></a>从表中导出数据</h4><h5 id="导出到本地文件"><a href="#导出到本地文件" class="headerlink" title="导出到本地文件"></a>导出到本地文件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">hive&gt; </span><span class="language-bash">insert overwrite <span class="built_in">local</span> directory <span class="string">&#x27;/usr/local/hadoop/examples/export_stu&#x27;</span> select * from hive.stu;</span></span><br><span class="line">...</span><br><span class="line">Moving data to local directory /usr/local/hadoop/examples/export_stu</span><br><span class="line">MapReduce Jobs Launched:</span><br><span class="line">Stage-Stage-1:  HDFS Read: 30 HDFS Write: 0 SUCCESS</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看导出的文件</span></span><br><span class="line">[hadoop@VM-24-13-centos local]$ cat /usr/local/hadoop/examples/export_stu/000000_0</span><br><span class="line">1xiapi</span><br><span class="line">2xiaoxue</span><br><span class="line">3qingqing</span><br></pre></td></tr></table></figure>

<h5 id="导出到hdfs"><a href="#导出到hdfs" class="headerlink" title="导出到hdfs"></a>导出到hdfs</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; insert overwrite directory &#x27;/usr/local/hadoop/examples/export_hdfs_stu&#x27; select * from hive.stu;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Moving data to directory /usr/local/hadoop/examples/export_hdfs_stu</span><br><span class="line">MapReduce Jobs Launched:</span><br><span class="line">Stage-Stage-1:  HDFS Read: 30 HDFS Write: 30 SUCCESS</span><br><span class="line">Total MapReduce CPU Time Spent: 0 msec</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"># 查看导出成功的数据</span><br><span class="line">hive&gt; dfs -cat /usr/local/hadoop/examples/export_hdfs_stu/*;</span><br><span class="line">1xiapi</span><br><span class="line">2xiaoxue</span><br><span class="line">3qingqing</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="查询操作"><a href="#查询操作" class="headerlink" title="查询操作"></a>查询操作</h4><ul>
<li><p>和SQL的查询完全一样，这里不再赘述。主要使用select…from…where…等语句，再结合关键字group by、having、like、rlike等操作。这里我们简单介绍一下SQL中没有的case…when…then…句式、join操作和子查询操作。</p>
</li>
<li><p><code>case…when…then…</code>句式和if条件语句类似，用于处理单个列的查询结果，语句如下：</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">select</span> id,name,</span><br><span class="line">    <span class="operator">&gt;</span>   <span class="keyword">case</span></span><br><span class="line">    <span class="operator">&gt;</span>   <span class="keyword">when</span> id<span class="operator">=</span><span class="number">1</span> <span class="keyword">then</span> <span class="string">&#x27;first&#x27;</span></span><br><span class="line">    <span class="operator">&gt;</span>   <span class="keyword">when</span> id<span class="operator">=</span><span class="number">2</span> <span class="keyword">then</span> <span class="string">&#x27;second&#x27;</span></span><br><span class="line">    <span class="operator">&gt;</span>   <span class="keyword">else</span> <span class="string">&#x27;third&#x27;</span></span><br><span class="line">    <span class="operator">&gt;</span>   <span class="keyword">end</span> <span class="keyword">from</span> stu;</span><br><span class="line">OK</span><br><span class="line"><span class="number">1</span>       xiapi   <span class="keyword">first</span></span><br><span class="line"><span class="number">2</span>       xiaoxue         <span class="keyword">second</span></span><br><span class="line"><span class="number">3</span>       qingqing        third</span><br><span class="line"><span class="type">Time</span> taken: <span class="number">0.385</span> seconds, Fetched: <span class="number">3</span> <span class="type">row</span>(s)</span><br></pre></td></tr></table></figure>

<ul>
<li>连接（join）是将两个表中在共同数据项上相互匹配的那些行合并起来, HiveQL 的连接分为内连接、左向外连接、右向外连接、全外连接和半连接 5 种。</li>
</ul>
<h5 id="内连接"><a href="#内连接" class="headerlink" title="内连接"></a>内连接</h5><ul>
<li>内连接使用比较运算符根据每个表共有的列的值匹配两个表中的行。</li>
<li>首先，我们先把以下内容插入到course表中</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> course <span class="keyword">values</span>(<span class="number">1</span>,<span class="number">3</span>);</span><br><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> course <span class="keyword">values</span>(<span class="number">2</span>,<span class="number">1</span>);</span><br><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> course <span class="keyword">values</span>(<span class="number">3</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>下面, 查询stu和course表中学号相同的所有行，命令如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">select</span> stu.<span class="operator">*</span>, course.<span class="operator">*</span> <span class="keyword">from</span> stu <span class="keyword">join</span> course <span class="keyword">on</span>(stu.id<span class="operator">=</span>course.sid);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">OK</span><br><span class="line"><span class="number">1</span>       xiapi   <span class="number">2</span>       <span class="number">1</span></span><br><span class="line"><span class="number">1</span>       xiapi   <span class="number">3</span>       <span class="number">1</span></span><br><span class="line"><span class="number">2</span>       xiaoxue         <span class="number">1</span>       <span class="number">2</span></span><br><span class="line"><span class="type">Time</span> taken: <span class="number">11.049</span> seconds, Fetched: <span class="number">3</span> <span class="type">row</span>(s)</span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="右连接"><a href="#右连接" class="headerlink" title="右连接"></a>右连接</h5><p>右连接是左向外连接的反向连接,将返回右表的所有行。如果右表的某行在左表中没有匹配行,则将为左表返回空值。命令</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">select</span> stu.<span class="operator">*</span>, course.<span class="operator">*</span> <span class="keyword">from</span> stu <span class="keyword">right</span> <span class="keyword">outer</span> <span class="keyword">join</span> course <span class="keyword">on</span>(stu.id<span class="operator">=</span>course.sid);</span><br><span class="line">Total MapReduce CPU <span class="type">Time</span> Spent: <span class="number">0</span> msec</span><br><span class="line">OK</span><br><span class="line"><span class="number">2</span>       xiaoxue         <span class="number">1</span>       <span class="number">2</span></span><br><span class="line"><span class="number">1</span>       xiapi   <span class="number">2</span>       <span class="number">1</span></span><br><span class="line"><span class="number">1</span>       xiapi   <span class="number">3</span>       <span class="number">1</span></span><br><span class="line"><span class="type">Time</span> taken: <span class="number">10.887</span> seconds, Fetched: <span class="number">3</span> <span class="type">row</span>(s)</span><br></pre></td></tr></table></figure>

<h5 id="全连接"><a href="#全连接" class="headerlink" title="全连接"></a>全连接</h5><p>全连接返回左表和右表中的所有行。当某行在另一表中没有匹配行时,则另一个表的选择列表包含空值。如果表之间有匹配行,则整个结果集包含基表的数据值。命令如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">select</span> stu.<span class="operator">*</span>, course.<span class="operator">*</span> <span class="keyword">from</span> stu <span class="keyword">full</span> <span class="keyword">outer</span> <span class="keyword">join</span> course <span class="keyword">on</span>(stu .id<span class="operator">=</span>course .sid);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">OK</span><br><span class="line"><span class="number">1</span>       xiapi   <span class="number">3</span>       <span class="number">1</span></span><br><span class="line"><span class="number">1</span>       xiapi   <span class="number">2</span>       <span class="number">1</span></span><br><span class="line"><span class="number">2</span>       xiaoxue         <span class="number">1</span>       <span class="number">2</span></span><br><span class="line"><span class="number">3</span>       qingqing        <span class="keyword">NULL</span>    <span class="keyword">NULL</span></span><br></pre></td></tr></table></figure>

<h5 id="半连接"><a href="#半连接" class="headerlink" title="半连接"></a>半连接</h5><p>半连接是 Hive 所特有的, <strong>Hive 不支持 in 操作,但是拥有替代的方案</strong>;<code> left semi join,</code> 称为半连接, 需要注意的是连接的表不能在查询的列中,只能出现在 on 子句中。命令如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">select</span> stu.<span class="operator">*</span> <span class="keyword">from</span> stu <span class="keyword">left</span> semi <span class="keyword">join</span> course <span class="keyword">on</span>(stu .id<span class="operator">=</span>course .sid);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Total MapReduce CPU <span class="type">Time</span> Spent: <span class="number">0</span> msec</span><br><span class="line">OK</span><br><span class="line"><span class="number">1</span>       xiapi</span><br><span class="line"><span class="number">2</span>       xiaoxue</span><br><span class="line"><span class="type">Time</span> taken: <span class="number">9.267</span> seconds, Fetched: <span class="number">2</span> <span class="type">row</span>(s)</span><br></pre></td></tr></table></figure>

<h5 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a>子查询</h5><p>标准 SQL 的子查询支持嵌套的 select 子句,HiveQL 对子查询的支持很有限,只能在from 引导的子句中出现子查询。</p>
<h3 id="Hive简单编程实践"><a href="#Hive简单编程实践" class="headerlink" title="Hive简单编程实践"></a>Hive简单编程实践</h3><ul>
<li><p>下面我们以词频统计算法为例，来介绍怎么在具体应用中使用Hive。词频统计算法又是最能体现MapReduce思想的算法之一，这里我们可以对比它在MapReduce中的实现，来说明使用Hive后的优势。</p>
</li>
<li><p>MapReduce实现词频统计的代码可以通过下载Hadoop源码后，在 $HADOOP_HOME&#x2F;share&#x2F;hadoop&#x2F;mapreduce&#x2F;hadoop-mapreduce-examples-3.0.3.jar 包中找到(wordcount类)，wordcount类由63行Java代码编写而成。下面首先简单介绍一下怎么使用MapReduce中wordcount类来统计单词出现的次数，具体步骤如下：</p>
<ul>
<li>创建input目录，output目录会自动生成。其中input为输入目录，output目录为输出目录。命令如下：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/hadoop</span><br><span class="line">rm -r input</span><br><span class="line">mkdir input</span><br></pre></td></tr></table></figure>

<ul>
<li>然后，在input文件夹中创建两个测试文件file1.txt和file2.txt，命令如下：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd  /usr/local/hadoop/input</span><br><span class="line">[hadoop@VM-24-13-centos input]$ echo &quot;hello world&quot; &gt; file1.txt</span><br><span class="line">[hadoop@VM-24-13-centos input]$ echo &quot;hello world&quot; &gt; file1.txt</span><br></pre></td></tr></table></figure>

<ul>
<li>执行如下hadoop命令：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@VM-24-13-centos hadoop]$ cd  ..</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">先删除hdfs中output目录，不然会报错</span></span><br><span class="line">[hadoop@VM-24-13-centos hadoop]$ hadoop dfs -rm -r output</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> 删除input</span></span><br><span class="line">[hadoop@VM-24-13-centos hadoop]$ hdfs dfs -rm -r input</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在HDFS创建一个目录</span></span><br><span class="line">[hadoop@VM-24-13-centos hadoop]$ hdfs dfs -mkdir input</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制input到hdfs中的input目录</span></span><br><span class="line">[hadoop@VM-24-13-centos hadoop]$ hdfs dfs -put input/*  input</span><br><span class="line"></span><br><span class="line">[hadoop@VM-24-13-centos hadoop]$ hadoop jar share/hadoop/mapreduce/hadoop-mapreduce-examples-3.0.3.jar wordcount input output</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">2021-12-10 15:22:03,703 INFO mapreduce.Job:  map 100% reduce 100%</span><br><span class="line">2021-12-10 15:22:03,704 INFO mapreduce.Job: Job job_local1659054277_0001 completed successfully</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>我们可以到output文件夹中查看结果，结果如下：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@VM-24-13-centos hadoop]$ hdfs dfs -ls output/*</span><br><span class="line">-rw-r--r--   1 hadoop supergroup          0 2021-12-10 17:12 output/_SUCCESS</span><br><span class="line">-rw-r--r--   1 hadoop supergroup         25 2021-12-10 17:12 output/part-r-00000</span><br><span class="line"></span><br><span class="line">[hadoop@VM-24-13-centos hadoop]$ hdfs dfs -cat  output/part-r-00000</span><br><span class="line">hadoop  1</span><br><span class="line">hello   2</span><br><span class="line">world   1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>下面我们通过HiveQL实现词频统计功能，此时只要编写下面7行代码，而且不需要进行编译生成jar来执行。HiveQL实现命令如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[hadoop<span class="variable">@VM</span><span class="number">-24</span><span class="number">-13</span><span class="operator">-</span>centos hadoop]$ hive</span><br><span class="line"></span><br><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> docs(line string);</span><br><span class="line">hive<span class="operator">&gt;</span> load data inpath <span class="string">&#x27;input&#x27;</span> overwrite <span class="keyword">into</span> <span class="keyword">table</span> docs;</span><br><span class="line"># <span class="keyword">create</span> <span class="keyword">table</span> word_count 表示创建数据库</span><br><span class="line"># <span class="keyword">as</span> <span class="keyword">select</span> word, <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">as</span> count 表示查询列表，一个word，一个统计值</span><br><span class="line">#  <span class="keyword">from</span> (<span class="keyword">select</span> explode(split(line,<span class="string">&#x27; &#x27;</span>))<span class="keyword">as</span> word <span class="keyword">from</span> docs) 这里就是从docs复制数据</span><br><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> word_count <span class="keyword">as</span> <span class="keyword">select</span> word, <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">as</span> count <span class="keyword">from</span> (<span class="keyword">select</span> explode(split(line,<span class="string">&#x27; &#x27;</span>))<span class="keyword">as</span> word <span class="keyword">from</span> docs) w <span class="keyword">group</span> <span class="keyword">by</span> word <span class="keyword">order</span> <span class="keyword">by</span> word;</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行后，用select语句查看，结果如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> word_count;</span><br><span class="line">OK</span><br><span class="line">hadoop  <span class="number">1</span></span><br><span class="line">hello   <span class="number">2</span></span><br><span class="line">world   <span class="number">1</span></span><br><span class="line"><span class="type">Time</span> taken: <span class="number">0.148</span> seconds, Fetched: <span class="number">3</span> <span class="type">row</span>(s)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>由上可知，采用Hive实现最大的优势是，对于非程序员，不用学习编写Java MapReduce代码了，只需要用户学习使用HiveQL就可以了，而这对于有SQL基础的用户而言是非常容易的。</p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://louis-me.github.io/aposts/d7dcf086/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="一个正经的测试工程师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="施坤的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/aposts/d7dcf086/" class="post-title-link" itemprop="url">第三章 大数据之Hadoop搭建</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-07 09:18:51" itemprop="dateCreated datePublished" datetime="2021-12-07T09:18:51+08:00">2021-12-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-25 11:20:56" itemprop="dateModified" datetime="2022-02-25T11:20:56+08:00">2022-02-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">大数据</span></a>
                </span>
            </span>

          
            <span id="/aposts/d7dcf086/" class="post-meta-item leancloud_visitors" data-flag-title="第三章 大数据之Hadoop搭建" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/aposts/d7dcf086/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/aposts/d7dcf086/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><ul>
<li>服务器信息，是腾讯云服务器，2核cpu，4GB内存，80GB云硬盘，系统为centos 7.6_x64</li>
</ul>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Hadoop是用来处理大数据集合的分布式存储计算基础架构。可以使用一种简单的编程模式，通过多台计算机构成的集群，分布式处理大数据集。hadoop作为底层，其生态环境很丰富。hadoop基础包括以下四个基本模块：</p>
<ul>
<li>hadoop基础功能库：支持其他hadoop模块的通用程序包。</li>
<li>HDFS: 一个分布式文件系统，能够以高吞吐量访问应用的数据。</li>
<li>YARN: 一个作业调度和资源管理框架。</li>
<li>MapReduce: 一个基于YARN的大数据并行处理程序。</li>
</ul>
<h2 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h2><h3 id="创建hadoop用户"><a href="#创建hadoop用户" class="headerlink" title="创建hadoop用户"></a>创建hadoop用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">su              <span class="comment">#  root 用户登录</span></span><br><span class="line">useradd -m hadoop -s /bin/bash   <span class="comment"># 创建新用户hadoop,并使用 /bin/bash 作为shell</span></span><br><span class="line">passwd hadoop <span class="comment"># 设置密码</span></span><br></pre></td></tr></table></figure>

<h4 id="设置权限"><a href="#设置权限" class="headerlink" title="设置权限"></a>设置权限</h4><ul>
<li><p>为 hadoop 用户增加管理员权限，方便部署，避免一些对新手来说比较棘手的权限问题，输入命令<code>visudo</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@VM-24-13-centos hadoop]$ sudo visudo</span><br><span class="line">[sudo] password for hadoop:</span><br></pre></td></tr></table></figure>


</li>
<li><p>找到 <code>root ALL=(ALL) ALL</code> 这行，然后在这行下面增加一行内容：<code>hadoop ALL=(ALL) ALL</code> （当中的间隔为tab），如下图所示：</p>
<p><img src="/aposts/d7dcf086/image-20211207093705705.png" alt="image-20211207093705705"></p>
</li>
<li><p><code>su hadoop</code> 直接可以切换用户</p>
</li>
</ul>
<h3 id="安装SSH、配置SSH无密码登陆"><a href="#安装SSH、配置SSH无密码登陆" class="headerlink" title="安装SSH、配置SSH无密码登陆"></a>安装SSH、配置SSH无密码登陆</h3><ul>
<li><p>集群、单节点模式都需要用到 SSH 登陆（类似于远程登陆，你可以登录某台 Linux 主机，并且在上面运行命令），一般情况下，CentOS 默认已安装了 SSH client、SSH server，打开终端执行如下命令进行检验：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@VM-24-13-centos /]$ rpm -qa | grep ssh</span><br><span class="line">openssh-7.4p1-21.el7.x86_64</span><br><span class="line">openssh-clients-7.4p1-21.el7.x86_64</span><br><span class="line">openssh-server-7.4p1-21.el7.x86_64</span><br><span class="line">libssh2-1.8.0-4.el7.x86_64</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>包含了 SSH client 跟 SSH server，则不需要再安装</li>
</ul>
</li>
<li><p>接着执行如下命令(<code>ssh localhost</code>)测试一下 SSH 是否可用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[hadoop@VM-24-13-centos /]$ ssh localhost</span><br><span class="line">The authenticity of host <span class="string">&#x27;localhost (::1)&#x27;</span> can<span class="string">&#x27;t be established.</span></span><br><span class="line"><span class="string">ECDSA key fingerprint is SHA256:v9LOJv5al8BNRGGZVJeqa2AdV3znIsa6cjyoj9CbWRQ.</span></span><br><span class="line"><span class="string">ECDSA key fingerprint is MD5:bd:51:9d:6f:1f:9c:1f:ad:34:ce:fb:90:4f:27:bc:b1.</span></span><br><span class="line"><span class="string">Are you sure you want to continue connecting (yes/no)? yes</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>此时会有如下提示(SSH首次登陆提示)，输入 yes 。然后按提示输入密码 hadoop，这样就登陆到本机了，类似于下面这样：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Warning: Permanently added <span class="string">&#x27;localhost&#x27;</span> (ECDSA) to the list of known hosts.</span><br><span class="line">hadoop@localhost<span class="string">&#x27;s password:</span></span><br><span class="line"><span class="string">Last login: Tue Dec  7 09:37:37 2021</span></span><br><span class="line"><span class="string">[hadoop@VM-24-13-centos ~]$</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>但这样登陆是需要每次输入密码的，我们需要配置成SSH无密码登陆比较方便。</p>
</li>
<li><p>首先输入 <code>exit</code> 退出刚才的 ssh，就回到了我们原先的终端窗口，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[hadoop@VM-24-13-centos ~]$ <span class="built_in">exit</span></span><br><span class="line"><span class="built_in">logout</span></span><br><span class="line">Connection to localhost closed.</span><br><span class="line">[hadoop@VM-24-13-centos /]$</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>然后利用 ssh-keygen 生成密钥，并将密钥加入到授权中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/.ssh/                     <span class="comment"># 若没有该目录，请先执行一次ssh localhost</span></span><br><span class="line">ssh-keygen -t rsa              <span class="comment"># 会有提示，都按回车就可以</span></span><br><span class="line"><span class="built_in">cat</span> id_rsa.pub &gt;&gt; authorized_keys  <span class="comment"># 加入授权</span></span><br><span class="line"><span class="built_in">chmod</span> 600 ./authorized_keys    <span class="comment"># 修改文件权限</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>~的含义</strong></p>
<p>在 Linux 系统中，~ 代表的是用户的主文件夹，即 “&#x2F;home&#x2F;用户名” 这个目录，如你的用户名为 hadoop，则 ~ 就代表 “&#x2F;home&#x2F;hadoop&#x2F;”。 此外，命令中的 # 后面的文字是注释。</p>
</blockquote>
</li>
<li><p>此时再用 <code>ssh localhost</code> 命令，无需输入密码就可以直接登陆了，如下所示。</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hadoop@VM-24-13-centos .ssh]$ ssh localhost</span><br><span class="line">Last login: Tue Dec  7 09:44:00 2021 from ::1</span><br><span class="line">[hadoop@VM-24-13-centos ~]$</span><br></pre></td></tr></table></figure>

<h3 id="java"><a href="#java" class="headerlink" title="java"></a>java</h3><ul>
<li><p>java之前已经装好了，为1.8</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[hadoop@VM-24-13-centos ~]$ java -version</span><br><span class="line">java version <span class="string">&quot;1.8.0_311&quot;</span></span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_311-b11)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.311-b11, mixed mode)</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="安装hadoop"><a href="#安装hadoop" class="headerlink" title="安装hadoop"></a>安装hadoop</h3><ul>
<li>安装hadoop版本为3.0</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">su root</span><br><span class="line"><span class="built_in">cd</span> /usr/local</span><br><span class="line">wget https://archive.apache.org/dist/hadoop/common/hadoop-3.0.3/hadoop-3.0.3.tar.gz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[hadoop@VM-24-13-centos <span class="built_in">local</span>]$ sudo tar zxvf hadoop-3.0.3.tar.gz</span><br><span class="line"><span class="built_in">cd</span> /usr/local/</span><br><span class="line">sudo <span class="built_in">mv</span> ./hadoop-3.0.3/ ./hadoop            <span class="comment"># 将文件夹名改为hadoop</span></span><br><span class="line">sudo <span class="built_in">chown</span> -R hadoop:hadoop ./hadoop        <span class="comment"># 修改文件权限</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>Hadoop 解压后即可使用。输入如下命令来检查 Hadoop 是否可用，成功则会显示 Hadoop 版本信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/hadoop</span><br><span class="line">./bin/hadoop version</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[hadoop@VM-24-13-centos hadoop]$ ./bin/hadoop version</span><br><span class="line">Hadoop 3.0.3</span><br><span class="line">Source code repository https://yjzhangal@git-wip-us.apache.org/repos/asf/hadoop.git -r 37fd7d752db73d984dc31e0cdfd590d252f5e075</span><br><span class="line">Compiled by yzhang on 2018-05-31T17:12Z</span><br><span class="line">Compiled with protoc 2.5.0</span><br><span class="line">From <span class="built_in">source</span> with checksum 736cdcefa911261ad56d2d120bf1fa</span><br><span class="line">This <span class="built_in">command</span> was run using /usr/local/hadoop/share/hadoop/common/hadoop-common-3.0.3.jar</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Hadoop单机配置-非分布式"><a href="#Hadoop单机配置-非分布式" class="headerlink" title="Hadoop单机配置(非分布式)"></a>Hadoop单机配置(非分布式)</h2><ul>
<li>Hadoop 默认模式为非分布式模式，无需进行其他配置即可运行。非分布式即单 Java 进程，方便进行调试。</li>
<li><strong>这里比较奇怪，安装原文中教程，示例已经验证通过了，当搭建了伪分布式配置时，第二天运行这里的实例，没有成功？然后把实例修改后，发现居然和伪分布式配置代码差不多？暂不做深究了</strong></li>
</ul>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><ul>
<li><p>现在我们可以执行例子来感受下 Hadoop 的运行。Hadoop 附带了丰富的例子（运行 <code>./bin/hadoop jar ./share/hadoop/mapreduce/hadoop-mapreduce-examples-3.0.3.jar</code> 可以看到所有例子），包括 wordcount、terasort、join、grep 等。</p>
</li>
<li><p>在此我们选择运行 wordcount例子，我们将 input 文件夹中的所有文件作为输入，最后输出结果到 output 文件夹中。</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/hadoop</span><br><span class="line">mkdri iniput1</span><br><span class="line"><span class="built_in">cp</span> ./etc/hadoop/*.xml ./input1</span><br><span class="line"><span class="comment"># 在HDFS创建一个目录</span></span><br><span class="line">hdfs dfs -<span class="built_in">mkdir</span> /usr/local/hadoop/input</span><br><span class="line"><span class="comment">#  将配置文件作为输入文件上传到刚创建的HDFS目录中</span></span><br><span class="line">hdfs dfs -put ./input1/* /usr/local/hadoop/input</span><br><span class="line"></span><br><span class="line">hadoop jar ./share/hadoop/mapreduce/hadoop-mapreduce-examples-*.jar wordcount /usr/local/hadoop/input /usr/local/hadoop/output </span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看运行结果列表</span></span><br><span class="line">[hadoop@VM-24-13-centos hadoop]$ hdfs dfs -<span class="built_in">ls</span> /usr/local/hadoop/output/*</span><br><span class="line"></span><br><span class="line">-rw-r--r--   1 hadoop supergroup          0 2021-12-10 16:48 /usr/local/hadoop/output/_SUCCESS</span><br><span class="line">-rw-r--r--   1 hadoop supergroup       9405 2021-12-10 16:48 /usr/local/hadoop/output/part-r-00000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用cat查运行数据</span></span><br><span class="line">[hadoop@VM-24-13-centos hadoop]$ hdfs dfs -<span class="built_in">cat</span> /usr/local/hadoop/output/part-r-00000</span><br><span class="line">...</span><br><span class="line">datanodes       1</span><br><span class="line">decryptEncryptedKey     1</span><br><span class="line">default 13</span><br><span class="line">default_priority=&#123;priority&#125;]    1</span><br><span class="line">defined.        4</span><br><span class="line">delete-key      1</span><br><span class="line">dfsadmin        1</span><br><span class="line">different   </span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>注意</strong>，Hadoop 默认不会覆盖结果文件，因此再次运行上面实例会提示出错，需要先将 <code>./output</code> 删除。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@VM-24-13-centos hadoop]$ hdfs dfs -<span class="built_in">rm</span> -r /usr/local/hadoop/output</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Hadoop伪分布式配置"><a href="#Hadoop伪分布式配置" class="headerlink" title="Hadoop伪分布式配置"></a>Hadoop伪分布式配置</h2><ul>
<li>Hadoop 可以在单节点上以伪分布式的方式运行，Hadoop 进程以分离的 Java 进程来运行，<strong>节点既作为 NameNode 也作为 DataNode，同时读取的是 HDFS 中的文件</strong>。</li>
</ul>
<h3 id="设置环境变量"><a href="#设置环境变量" class="headerlink" title="设置环境变量"></a>设置环境变量</h3><ul>
<li>在设置 Hadoop 伪分布式配置前，我们还需要设置 HADOOP 环境变量，执行如下命令在 ~&#x2F;.bashrc 中设置：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vi ~/.bashrc</span><br><span class="line"></span><br><span class="line"># Hadoop Environment Variables</span><br><span class="line">export HADOOP_HOME=/usr/local/hadoop # hadoop的安装路径</span><br><span class="line">export HADOOP_INSTALL=$HADOOP_HOME</span><br><span class="line">export HADOOP_MAPRED_HOME=$HADOOP_HOME # 设置MAPRED环境变量</span><br><span class="line">export HADOOP_COMMON_HOME=$HADOOP_HOME # 设置COMMON环境变量</span><br><span class="line">export HADOOP_HDFS_HOME=$HADOOP_HOME # HDFS的环境变量</span><br><span class="line">export YARN_HOME=$HADOOP_HOME # YARN的环境变量</span><br><span class="line">export JAVA_HOME=/usr/local/jdk1.8.0_311 # 设置jdk的安装目录（用which java查看到）</span><br><span class="line">export HADOOP_COMMON_LIB_NATIVE_DIR=$HADOOP_HOME/lib/native</span><br><span class="line">export PATH=$PATH:$HADOOP_HOME/sbin:$HADOOP_HOME/bin</span><br></pre></td></tr></table></figure>

<ul>
<li><p>生效环境变量</p>
<p> <code>source ~/.bashrc</code></p>
</li>
<li><p>修改Hadoop-env.sh中的java_home，不然在启动集群（伪集群）时出现报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /usr/local/hadoop/etc/hadoop/hadoop-env.sh</span><br><span class="line"></span><br><span class="line"># 设置如下</span><br><span class="line">export JAVA_HOME=/usr/local/jdk1.8.0_311</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><ul>
<li><p>Hadoop 的配置文件位于 <code>/usr/local/hadoop/etc/hadoop/</code> 中，伪分布式需要修改2个配置文件 <strong>core-site.xml</strong> 和 <strong>hdfs-site.xml</strong></p>
</li>
<li><p>Hadoop的配置文件是 xml 格式，每个配置以声明 property 的 name 和 value 的方式来实现。</p>
</li>
<li><p>修改配置文件 <strong>core-site.xml</strong> </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /usr/local/hadoop/etc/hadoop/core-site.xml </span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.tmp.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>file:/usr/local/hadoop/tmp<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>Abase for other temporary directories.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"># 设置HDFS的默认名称，在使用命令调用时，可以用此名称</span><br><span class="line"> <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>fs.defaultFS<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://localhost:9000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>同样的，修改配置文件 <strong>hdfs-site.xml</strong>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.replication<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>设置blocks副本数<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.name.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>file:/usr/local/hadoop/tmp/dfs/name<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">description</span>&gt;</span>设置存放NameNode的数据存储目录<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.datanode.data.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>file:/usr/local/hadoop/tmp/dfs/data<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">description</span>&gt;</span>设置存放DataNode的数据存储目录<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置完成后，执行 NameNode 的格式化:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/hdfs namenode -format</span><br></pre></td></tr></table></figure>
</li>
<li><p>接着开启 <code>NaneNode</code> 和 <code>DataNode</code> 守护进程，<code>./sbin/start-dfs.sh</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@VM-24-13-centos hadoop]$ ./sbin/start-dfs.sh</span><br><span class="line">Starting namenodes on [localhost]</span><br><span class="line">Starting datanodes</span><br><span class="line">Starting secondary namenodes [VM-24-13-centos]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动完成后，可以通过命令 <code>jps</code> 来判断是否成功启动，若成功启动则会列出如下进程: <code>NameNode</code>、<code>DataNode</code>和<code>SecondaryNameNode</code>（如果 SecondaryNameNode 没有启动，请运行 sbin&#x2F;stop-dfs.sh 关闭进程，然后再次尝试启动尝试）。如果没有 NameNode 或 DataNode ，那就是配置不成功，请仔细检查之前步骤，或通过查看启动日志排查原因。</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[hadoop@VM-24-13-centos hadoop]$ jps</span><br><span class="line">12433 Jps</span><br><span class="line">11741 DataNode</span><br><span class="line">11597 NameNode</span><br><span class="line">11934 SecondaryNameNode</span><br><span class="line"><span class="comment"># HDFS功能：NameNode，SecondaryNameNode，DataNode已经启动</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>通过查看启动日志分析启动失败原因</strong></p>
<p>有时 Hadoop 无法正确启动，如 NameNode 进程没有顺利启动，这时可以查看启动日志来排查原因，注意几点：</p>
<ul>
<li>启动时会提示形如 “dblab: starting namenode, logging to &#x2F;usr&#x2F;local&#x2F;hadoop&#x2F;logs&#x2F;hadoop-hadoop-namenode-dblab.out”，其中 dblab 对应你的主机名，但启动的日志信息是记录在 &#x2F;usr&#x2F;local&#x2F;hadoop&#x2F;logs&#x2F;hadoop-hadoop-namenode-dblab.log 中，所以应该查看这个后缀为 <strong>.log</strong> 的文件；</li>
<li>每一次的启动日志都是追加在日志文件之后，所以得拉到最后面看，看下记录的时间就知道了。</li>
<li>一般出错的提示在最后面，也就是写着 Fatal、Error 或者 Java Exception 的地方。</li>
<li>可以在网上搜索一下出错信息，看能否找到一些相关的解决方法。</li>
</ul>
</blockquote>
<h3 id="实例-1"><a href="#实例-1" class="headerlink" title="实例"></a>实例</h3><ul>
<li><p>上面的单机模式，grep 例子读取的是本地数据，伪分布式读取的则是 HDFS 上的数据。要使用 HDFS，首先需要在 HDFS 中创建用户目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@VM-24-13-centos hadoop]$ ./bin/hdfs dfs -<span class="built_in">mkdir</span> -p /user/hadoop</span><br><span class="line">2021-12-07 16:25:32,492 WARN util.NativeCodeLoader: Unable to load native-hadoop library <span class="keyword">for</span> your platform... using builtin-java classes <span class="built_in">where</span> applicable</span><br></pre></td></tr></table></figure>
</li>
<li><p>接着将·<code>./etc/hadoop</code>中的 xml 文件作为输入文件复制到分布式文件系统中，即将<code> /usr/local/hadoop/etc/hadoop</code> 复制到分布式文件系统中的<code>/user/hadoop/input</code>中。我们使用的是 hadoop 用户，并且已创建相应的用户目录<code> /user/hadoop</code> ，因此在命令中就可以使用相对路径如 input，其对应的绝对路径就是<code> /user/hadoop/input</code></p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./bin/hdfs dfs -<span class="built_in">mkdir</span> input</span><br><span class="line">./bin/hdfs dfs -put ./etc/hadoop/*.xml input</span><br></pre></td></tr></table></figure>

<ul>
<li><p>复制完成后，可以通过如下命令查看 HDFS 中的文件列表：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@VM-24-13-centos hadoop]$ ./bin/hdfs dfs -<span class="built_in">ls</span> input</span><br><span class="line"></span><br><span class="line">Found 9 items</span><br><span class="line">-rw-r--r--   1 hadoop supergroup       7861 2021-12-07 16:28 input/capacity-scheduler.xml</span><br><span class="line">-rw-r--r--   1 hadoop supergroup       1071 2021-12-07 16:28 input/core-site.xml</span><br><span class="line">-rw-r--r--   1 hadoop supergroup      10206 2021-12-07 16:28 input/hadoop-policy.xml</span><br><span class="line">-rw-r--r--   1 hadoop supergroup       1339 2021-12-07 16:28 input/hdfs-site.xml</span><br><span class="line">-rw-r--r--   1 hadoop supergroup        620 2021-12-07 16:28 input/httpfs-site.xml</span><br><span class="line">-rw-r--r--   1 hadoop supergroup       3518 2021-12-07 16:28 input/kms-acls.xml</span><br><span class="line">-rw-r--r--   1 hadoop supergroup        682 2021-12-07 16:28 input/kms-site.xml</span><br><span class="line">-rw-r--r--   1 hadoop supergroup        758 2021-12-07 16:28 input/mapred-site.xml</span><br><span class="line">-rw-r--r--   1 hadoop supergroup        690 2021-12-07 16:28 input/yarn-site.xml</span><br></pre></td></tr></table></figure>
</li>
<li><p>伪分布式运行 MapReduce 作业的方式跟单机模式相同，区别在于伪分布式读取的是HDFS中的文件（可以将单机步骤中创建的本地 input 文件夹，输出结果 output 文件夹都删掉来验证这一点）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@VM-24-13-centos hadoop]$ ./bin/hadoop jar ./share/hadoop/mapreduce/hadoop-mapreduce-examples-*.jar  wordcount input output </span><br><span class="line">....</span><br><span class="line">2021-12-07 16:30:56,021 INFO mapreduce.Job: Job job_local897809468_0002 completed successfully</span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>查看运行结果的命令（查看的是位于 HDFS 中的输出结果）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@VM-24-13-centos hadoop]$ ./bin/hdfs dfs -<span class="built_in">ls</span> output/*</span><br><span class="line"></span><br><span class="line">-rw-r--r--   1 hadoop supergroup          0 2021-12-10 17:58 output/_SUCCESS</span><br><span class="line">-rw-r--r--   1 hadoop supergroup       9405 2021-12-10 17:58 output/part-r-00000</span><br><span class="line"></span><br><span class="line">[hadoop@VM-24-13-centos hadoop]$ ./bin/hdfs dfs -<span class="built_in">cat</span> output/part-r-00000</span><br><span class="line">....</span><br><span class="line"></span><br></pre></td></tr></table></figure>


</li>
<li><p>我们也可以将运行结果取回到本地：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -r ./output    <span class="comment"># 先删除本地的 output 文件夹（如果存在）</span></span><br><span class="line">./bin/hdfs dfs -get output ./output     <span class="comment"># 将 HDFS 上的 output 文件夹拷贝到本机</span></span><br><span class="line">[hadoop@VM-24-13-centos hadoop]$ <span class="built_in">cat</span> ./output/*</span><br><span class="line">.....</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>Hadoop 运行程序时，输出目录不能存在，否则会提示错误 <code>org.apache.hadoop.mapred.FileAlreadyExistsException: Output directory hdfs://localhost:9000/user/hadoop/output already exists</code>，因此若要再次执行，需要执行如下命令删除 output 文件夹:</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/hdfs dfs -rm -r output    # 删除 output 文件夹</span><br></pre></td></tr></table></figure>

<ul>
<li>为防止覆盖结果，程序指定的输出目录（如 output）不能存在，否则会提示错误，运行前需要先删除输出目录。在实际开发应用程序时，可考虑在程序中加上如下代码，能在每次运行时自动删除输出目录，避免繁琐的命令行操作，可以采用类似于下面java代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Configuration</span> <span class="variable">conf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>();</span><br><span class="line"><span class="type">Job</span> <span class="variable">job</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Job</span>(conf);</span><br><span class="line"> </span><br><span class="line"><span class="comment">/* 删除输出目录 */</span></span><br><span class="line"><span class="type">Path</span> <span class="variable">outputPath</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Path</span>(args[<span class="number">1</span>]);</span><br><span class="line">outputPath.getFileSystem(conf).delete(outputPath, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>若要关闭 Hadoop，则运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./sbin/stop-dfs.sh</span><br></pre></td></tr></table></figure>
</li>
<li><p>下次启动 hadoop 时，无需进行 NameNode 的初始化，只需要运行 <code>./sbin/start-dfs.sh</code> 就可以！</p>
</li>
</ul>
<h2 id="完全分布式"><a href="#完全分布式" class="headerlink" title="完全分布式"></a>完全分布式</h2><p>后续打算采用本地三台虚拟机的模式搭建完全分布式。</p>
<p>请注意分布式运行中的这几个结点的区别：</p>
<ul>
<li>从分布式存储的角度来说，集群中的结点由一个NameNode和若干个DataNode组成,另有一个SecondaryNameNode作为NameNode的备份。</li>
<li>从分布式应用的角度来说，集群中的结点由一个JobTracker和若干个TaskTracker组成，JobTracker负责任务的调度，TaskTracker负责并行执行任务。TaskTracker必须运行在DataNode上，这样便于数据的本地计算。JobTracker和NameNode则无须在同一台机器上。一个机器上，既当namenode，又当datanode,或者说 既 是jobtracker,又是tasktracker。没有所谓的在多台机器上进行真正的分布式计算，故称为”伪分布式”。</li>
<li>真正的分布式，由3个及以上的实体机或者虚拟机组件的机群。</li>
<li>来自<a target="_blank" rel="noopener" href="https://www.cnblogs.com/liango/p/7116620.html">这里</a></li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><p><a target="_blank" rel="noopener" href="http://dblab.xmu.edu.cn/blog/install-hadoop-in-centos/">Hadoop安装教程_伪分布式配置_CentOS6.4&#x2F;Hadoop2.6.0</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/43cfffe7090d">ubuntn-Hadoop 单台Cluster的安装</a></p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://louis-me.github.io/aposts/8ae2490c/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="一个正经的测试工程师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="施坤的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/aposts/8ae2490c/" class="post-title-link" itemprop="url">第二章 数据仓的设计与构建</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-06 16:32:38" itemprop="dateCreated datePublished" datetime="2021-12-06T16:32:38+08:00">2021-12-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-25 11:20:56" itemprop="dateModified" datetime="2022-02-25T11:20:56+08:00">2022-02-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">大数据</span></a>
                </span>
            </span>

          
            <span id="/aposts/8ae2490c/" class="post-meta-item leancloud_visitors" data-flag-title="第二章 数据仓的设计与构建" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/aposts/8ae2490c/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/aposts/8ae2490c/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="什么是数据仓"><a href="#什么是数据仓" class="headerlink" title="什么是数据仓"></a>什么是数据仓</h2><ul>
<li><p>是BI（商业智能）、报表和数据挖掘等应用的基础</p>
</li>
<li><p>大量的数据集合，4个特点主要包括：<strong>面向主题的、集成的、相对稳定的、反应历史变化的</strong></p>
</li>
<li><p>数据仓至少需要具备<strong>数据获取、数据存储、数据访问</strong>3个核心功能，这3个功能的实现过程是数据源到最终决策应用的流转过程。下图为数据流转图：</p>
</li>
</ul>
<p><img src="/aposts/8ae2490c/image-20211201171618652.png" alt="image-20211201171618652"></p>
<ul>
<li><p>数据获取和数据存储这两个功能主要由ETL工具支撑。ETL是指从<strong>数据源提前，经过清洗、转换</strong>等过程，并最终存储到目标数据仓库的过程。如下图所示，ETL过程3个步骤</p>
<p><img src="/aposts/8ae2490c/image-20211201172008951.png" alt="image-20211201172008951"></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/337994072">为什么要用ETL</a></p>
</li>
</ul>
<h2 id="数据仓库、集市、数据湖、中台区别"><a href="#数据仓库、集市、数据湖、中台区别" class="headerlink" title="数据仓库、集市、数据湖、中台区别"></a>数据仓库、集市、数据湖、中台区别</h2><h3 id="数据集市"><a href="#数据集市" class="headerlink" title="数据集市"></a>数据集市</h3><ul>
<li><p>数据仓库面向企业全局业务，而数据集市面向部门级业务</p>
<p><img src="/aposts/8ae2490c/image-20211206151311207.png" alt="image-20211206151311207"></p>
</li>
</ul>
<h3 id="数据湖"><a href="#数据湖" class="headerlink" title="数据湖"></a>数据湖</h3><ul>
<li><p>数据存储结构：数据仓主要存储和处理历史数据的机构化数据，而数据湖能存储结构和非结构化所有格式的数据</p>
</li>
<li><p>数据转换处理：数据仓库需要对源数据进行清洗、转换等预处理，以和定义好的数据模型相吻合；而数据湖是从源数据导入，无数据流失，随去随用，只有在使用的时候对数据转换等处理</p>
</li>
<li><p>数据场景：数据仓通常充当商业智能系统、数据仪表盘等可视化报表服务的数据源角色，支持历史分析；数据湖可以作为数据仓库或数据集市的数据源，更适合进行数据的挖掘、探索和预测，</p>
</li>
</ul>
<h3 id="数据中台"><a href="#数据中台" class="headerlink" title="数据中台"></a>数据中台</h3><ul>
<li>由阿里巴巴提出，就是用大数据技术统一处理数据，然后提供API给外部使用，数据中台保护数据仓库和其他服务器中间件</li>
</ul>
<h2 id="数据仓库的设计"><a href="#数据仓库的设计" class="headerlink" title="数据仓库的设计"></a>数据仓库的设计</h2><h3 id="架构分层设计"><a href="#架构分层设计" class="headerlink" title="架构分层设计"></a><span id="架构分层设计">架构分层设计</span></h3><ul>
<li>数据仓库通常可分为数据接入层、数据明细层、数据汇总层、数据集市层、数据应用层、临时层和公共维度层。其中数据明细层和数据汇总层又合称为数据仓库层。</li>
</ul>
<p><img src="/aposts/8ae2490c/image-20211206154539189.png" alt="image-20211206154539189"></p>
<h4 id="数据接入层ODS"><a href="#数据接入层ODS" class="headerlink" title="数据接入层ODS"></a>数据接入层ODS</h4><ul>
<li>（Operational Data Store，ODS），也称数据贴源层，通常从业务数据库直接导入，为了考虑后续可能需要追溯数据问题，因此对于这一层就不建议做过多的数据清洗工作，原封不动地接入原始数据即可，至于数据的去噪、去重、异常值处理等过程可以放在后面的DWD层来做</li>
</ul>
<h4 id="数据明细层DWD"><a href="#数据明细层DWD" class="headerlink" title="数据明细层DWD"></a>数据明细层DWD</h4><ul>
<li>(Data Warehouse Detail，DWD) ，这层和 ODS 层保持一样的数据结构，只不过在从 ODS 里抽取到 DWD 的时候这个过程叫 ETL，后面我们会再讲 ETL，在抽取时对数据进行清洗加工，提供一定的数据质量保证，提供更干净的数据。</li>
</ul>
<h4 id="数据汇总层DWS"><a href="#数据汇总层DWS" class="headerlink" title="数据汇总层DWS"></a>数据汇总层DWS</h4><ul>
<li>（Data Warehouse Summary, DWS），对各个表进行JOIN操作，产生业务所需要的完整数据。该层主要存放明细事实宽表、聚合试试宽表等。</li>
</ul>
<h4 id="数据集市层DWM"><a href="#数据集市层DWM" class="headerlink" title="数据集市层DWM"></a>数据集市层DWM</h4><ul>
<li>也叫数据中间件，(Data Warehouse Middle,DWM)，该层是在DWD层的数据基础上，对数据做一些轻微的聚合操作，生成一些列的中间结果表，提升公共指标的复用性，减少重复加工的工作。</li>
<li>简答来说，对通用的核心维度进行聚合操作，算出相应的统计指标</li>
<li>从广度来说，它包含了所有的业务数据</li>
</ul>
<h4 id="数据应用层"><a href="#数据应用层" class="headerlink" title="数据应用层"></a>数据应用层</h4><ul>
<li>该层中，数据高度汇总，数据粒度较大，但不一定涵盖所有业务数据，也可能只是数据集市层数据的一个子集。</li>
<li>该层主要是提供给数据产品和数据分析使用的数据，一般会存放在ES、Redis、PostgreSql等系统中供线上系统使用；也可能存放在hive或者Druid中，供数据分析和数据挖掘使用，比如常用的数据报表就是存在这里的</li>
</ul>
<h4 id="临时层TMP"><a href="#临时层TMP" class="headerlink" title="临时层TMP"></a>临时层TMP</h4><ul>
<li>临时存放一些中间数据计算结果</li>
</ul>
<h4 id="公共维度层"><a href="#公共维度层" class="headerlink" title="公共维度层"></a>公共维度层</h4><ul>
<li>主要负责一些一致性维度建设，如地点区域表、时间维度表等，数据仓库的各层均可使用此层</li>
</ul>
<h3 id="数据仓库建模方法"><a href="#数据仓库建模方法" class="headerlink" title="数据仓库建模方法"></a><span id="数据仓库建模方法">数据仓库建模方法</span></h3><ul>
<li>主要有范式建模、维度建模、实体建模</li>
</ul>
<h4 id="范式建模"><a href="#范式建模" class="headerlink" title="范式建模"></a>范式建模</h4><p>是数据仓库逻辑模型设计的基本理论，在数据仓库的模型设计中，一般采用第三范式。一个符合第三范式的关系必须具有以下三个条件:</p>
<ul>
<li>每个属性的值唯一,不具有多义性;</li>
<li>每个非主属性必须完全依赖于整个主键,而非主键的一部分;</li>
<li>每个非主属性不能依赖于其他关系中的属性,因为这样的话,这种属性应该归到其他关系中去</li>
</ul>
<h4 id="维度建模"><a href="#维度建模" class="headerlink" title="维度建模"></a>维度建模</h4><ul>
<li><p>是经典的面向分析的数据仓库建模方法。对数据进行分析时使用的度量。例如：抽取近10年的信用卡数据，分析年申请趋势</p>
</li>
<li><p>经常出现实体表、维度表和事实表等</p>
<ul>
<li>实体表，用于存放商品的属性信息</li>
<li>维度表，按照某个分析维度来组织的事实描述，如分析某商品近半年来每月下单量，则表中一定存在时间字段属性。</li>
<li>事实表，<strong>是维度表各个维度的交点</strong>，如某商品在某地某月的销售额</li>
</ul>
</li>
<li><p>在维度建模的基础上又分为三种模型：星型模型、雪花模型、星座模型。</p>
</li>
</ul>
<h5 id="星型模式"><a href="#星型模式" class="headerlink" title="星型模式"></a>星型模式</h5><p><img src="/aposts/8ae2490c/image-20211206163244801.png" alt="image-20211206163244801"></p>
<h5 id="雪花模式"><a href="#雪花模式" class="headerlink" title="雪花模式"></a>雪花模式</h5><p><img src="/aposts/8ae2490c/image-20211206163338893.png" alt="image-20211206163338893"></p>
<ul>
<li>星型模型和雪花模型实例</li>
</ul>
<p><img src="/aposts/8ae2490c/image-20211206163931436.png" alt="image-20211206163931436"></p>
<h5 id="星座模式"><a href="#星座模式" class="headerlink" title="星座模式"></a>星座模式</h5><p>星座模式是星型模式延伸而来，星型模式是基于一张事实表的，而星座模式是基于多张事实表的，而且共享维度信息。</p>
<p><img src="/aposts/8ae2490c/image-20211206163425140.png" alt="image-20211206163425140"></p>
<ul>
<li>星座模型与前两种情况的区别是事实表的数量,星座模型是基于多个事实表。</li>
<li>基本上是很多数据仓库的常态,因为很多数据仓库都是多个事实表的。所以星座不星座只反映是否有多个事实表,他们之间<br>是否共享一些维度表。所以星座模型并不和前两个模型冲突。</li>
</ul>
<h5 id="模型的选择"><a href="#模型的选择" class="headerlink" title="模型的选择"></a>模型的选择</h5><ul>
<li>首先就是星座不星座这个只跟数据和需求有关系,跟殳计没关系,不用选择。星型还是雪花,取决于性能优先,还是灵活更优先。</li>
<li>目前实际企业开发中,不会绝对选择一种,根据情况灵活组合,甚至并存(一层维度和多层维度都保存)</li>
<li>但是整体来看,更倾向于维度更少的星型模型。尤其是hadoop体系,减少Join就是减少 Shuffle,性能差距很大。(关系型数据可以依靠强大的主键索引)</li>
</ul>
<h4 id="实体建模"><a href="#实体建模" class="headerlink" title="实体建模"></a>实体建模</h4><p>在数据仓建模中不常见，一般适用与业务建模和领域概念建模阶段</p>
<h2 id="数据仓库构建"><a href="#数据仓库构建" class="headerlink" title="数据仓库构建"></a>数据仓库构建</h2><h3 id="数据仓库的构建方法"><a href="#数据仓库的构建方法" class="headerlink" title="数据仓库的构建方法"></a>数据仓库的构建方法</h3><ul>
<li>构建方法主要包括自顶向下和自底向上</li>
</ul>
<h4 id="自顶向下实现"><a href="#自顶向下实现" class="headerlink" title="自顶向下实现"></a>自顶向下实现</h4><ul>
<li>自顶向下的实现需要在项目开始时完成更多计划和设计工作，这就需要涉及参与数据仓库实现的每个工作组、部门或业务线中的人员。要使 用的数据源、安全性、数据结构、数据质量、数据标准和整个数据模型的有关决策一般需要在真正的实现开始之前就完成。</li>
<li>此构建方法，实施周期长，难道略大</li>
</ul>
<h4 id="自底向上实现"><a href="#自底向上实现" class="headerlink" title="自底向上实现"></a>自底向上实现</h4><ul>
<li>自底向上的实现包含数据仓库的规划和设计，无需等待安置好更大业务范围的数据仓库设计。这并不意味着不会开发更大业务范围的数据仓 库设计；随着初始数据仓库实现的扩展，将逐渐增加对它的构建。现在，该方法得到了比自顶向下方法更广泛的接受，因为数据仓库的直接结果可以实现， 并可以用作扩展更大业务范围实现的证明。</li>
</ul>
<h4 id="两者结合"><a href="#两者结合" class="headerlink" title="两者结合"></a>两者结合</h4><ul>
<li>两者结合的折中实现：每种实现方法都有利弊。在许多情况下，最好的方法可能是某两种的组合。该方法的关键之一就是确定业务范围的架构需要用于支持 集成的计划和设计的程度，因为数据仓库是用自底向上的方法进行构建。在使用自底向上或阶段性数据仓库项目模型来构建业务范围架构中的一系列数据集 市时，您可以一个接一个地集成不同业务主题领域中的数据集市，从而形成设计良好的业务数据仓库。这样的方法可以极好地适用于业务。在这种方法中， 可以把数据集市理解为整个数据仓库系统的逻辑子集，换句话说数据仓库就是一致化了的数据集市的集合。</li>
</ul>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>无论采用哪种模式，数据仓库构建过程，都可以参考下图介绍的5个步骤。基于BI报表、数据挖掘等应用要求，可参考<a href="#%E6%9E%B6%E6%9E%84%E5%88%86%E5%B1%82%E8%AE%BE%E8%AE%A1">架构分层设计</a>数据仓库结构进行适当的分层设计，并根据业务要求选择合适的建模方法，可参考<a href="#%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%E5%BB%BA%E6%A8%A1%E6%96%B9%E6%B3%95">数据仓库建模方法</a></p>
<p><img src="/aposts/8ae2490c/image-20211206171202539.png" alt="image-20211206171202539"></p>
<h3 id="数据仓库实例"><a href="#数据仓库实例" class="headerlink" title="数据仓库实例"></a>数据仓库实例</h3><ul>
<li><a target="_blank" rel="noopener" href="http://dblab.xmu.edu.cn/blog/959/">大数据案例-步骤一:本地数据集上传到数据仓库Hive</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://louis-me.github.io/aposts/ae5c089/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="一个正经的测试工程师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="施坤的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/aposts/ae5c089/" class="post-title-link" itemprop="url">pandas处理excel</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-03 17:37:40" itemprop="dateCreated datePublished" datetime="2021-12-03T17:37:40+08:00">2021-12-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-25 11:20:56" itemprop="dateModified" datetime="2022-02-25T11:20:56+08:00">2022-02-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
                </span>
            </span>

          
            <span id="/aposts/ae5c089/" class="post-meta-item leancloud_visitors" data-flag-title="pandas处理excel" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/aposts/ae5c089/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/aposts/ae5c089/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><ul>
<li><p>现有一excel如下，需要把日期和金额合并成一行</p>
<p><img src="/aposts/ae5c089/image-20211203173955957.png" alt="image-20211203173955957"></p>
</li>
<li><p>最终需要实现效果如下：</p>
<p><img src="/aposts/ae5c089/image-20211203174051646.png" alt="image-20211203174051646"></p>
</li>
</ul>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OperateExcel</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, file_path</span>):</span><br><span class="line">        self.file_path = file_path</span><br><span class="line">        <span class="comment"># 注意header参数，取值为前面两行</span></span><br><span class="line">        self.df = pd.read_excel(file_path, sheet_name=<span class="string">&quot;日记帐&quot;</span>, header=[<span class="number">0</span>, <span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_head</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        头部处理，格式：</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        [year, headers]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        year为年，如2021年</span></span><br><span class="line"><span class="string">        headers=[]，把所有头部值存到[]中，日期	凭证编号	车牌号	拿货吨位	卖出吨位	摘要	收入	支出	余额</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        headers = []</span><br><span class="line">        <span class="comment"># 取头部数据</span></span><br><span class="line">        head = self.df.head(<span class="number">0</span>)</span><br><span class="line">        year = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> items <span class="keyword">in</span> head:</span><br><span class="line">            <span class="comment"># ------ 处理日期,取年</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> items:</span><br><span class="line">                <span class="keyword">if</span> i.find(<span class="string">&quot;年&quot;</span>) != -<span class="number">1</span>:</span><br><span class="line">                    year = i</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="comment"># ------- 处理其他头部</span></span><br><span class="line">            <span class="keyword">if</span> items[<span class="number">1</span>].replace(<span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>).find(<span class="string">&quot;Unnamed&quot;</span>) != -<span class="number">1</span>:</span><br><span class="line">                headers.append(items[<span class="number">0</span>].replace(<span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">            <span class="comment"># ---- 金额后的头部，只取收入、支出、余额；</span></span><br><span class="line">            <span class="keyword">if</span> items[<span class="number">0</span>].replace(<span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>).find(<span class="string">&quot;金额&quot;</span>) != -<span class="number">1</span>:</span><br><span class="line">                headers.append(items[<span class="number">1</span>].replace(<span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line"></span><br><span class="line">        headers.insert(<span class="number">0</span>, <span class="string">&quot;日期&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> year, headers</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_data</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">         处理数据</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">         [file_name, data]</span></span><br><span class="line"><span class="string">         file_name表示将要保持的名字</span></span><br><span class="line"><span class="string">         data 表示处理好的数据，给pd.DataFrame使用，格式 &#123;&quot;金额&quot;:[1,2,3],&quot;收入&quot;:[]&#125;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        g_head = self.get_head()</span><br><span class="line">        headers = g_head[<span class="number">1</span>]</span><br><span class="line">        year = g_head[<span class="number">0</span>]</span><br><span class="line">        month = <span class="string">&quot;&quot;</span></span><br><span class="line">        data = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> headers:</span><br><span class="line">            data[i] = []</span><br><span class="line">        <span class="keyword">for</span> items <span class="keyword">in</span> self.df.values:</span><br><span class="line">            <span class="comment"># 合计不取数据；第一个单元格为空值说明此行为无效数据，也不取值</span></span><br><span class="line">            <span class="keyword">if</span> items[<span class="number">0</span>] == <span class="string">&#x27;合计&#x27;</span> <span class="keyword">or</span> math.isnan(items[<span class="number">0</span>]):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="comment"># 处理日期值为：2021年1月1日</span></span><br><span class="line">            month = <span class="built_in">str</span>(items[<span class="number">0</span>]) + <span class="string">&quot;月&quot;</span></span><br><span class="line">            m_date = year + month + <span class="built_in">str</span>(<span class="built_in">int</span>(items[<span class="number">1</span>])) + <span class="string">&quot;日&quot;</span></span><br><span class="line">            data[<span class="string">&quot;日期&quot;</span>].append(m_date)</span><br><span class="line">            <span class="comment"># 凭证编号</span></span><br><span class="line">            num = <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">str</span>(items[<span class="number">2</span>]) != <span class="string">&quot;nan&quot;</span>:</span><br><span class="line">                num = items[<span class="number">2</span>]</span><br><span class="line">            data[<span class="string">&quot;凭证编号&quot;</span>].append(num)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 车牌号</span></span><br><span class="line">            car_num = <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">str</span>(items[<span class="number">3</span>]) != <span class="string">&quot;nan&quot;</span>:</span><br><span class="line">                car_num = items[<span class="number">3</span>]</span><br><span class="line">            data[<span class="string">&quot;车牌号&quot;</span>].append(car_num)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 拿货吨位</span></span><br><span class="line">            take_tonnage = <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">str</span>(items[<span class="number">4</span>]) != <span class="string">&quot;nan&quot;</span>:</span><br><span class="line">                take_tonnage = items[<span class="number">4</span>]</span><br><span class="line">            data[<span class="string">&quot;拿货吨位&quot;</span>].append(take_tonnage)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 卖出吨位</span></span><br><span class="line">            sell_tonnage = <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">str</span>(items[<span class="number">5</span>]) != <span class="string">&quot;nan&quot;</span>:</span><br><span class="line">                sell_tonnage = items[<span class="number">5</span>]</span><br><span class="line">            data[<span class="string">&quot;卖出吨位&quot;</span>].append(sell_tonnage)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 摘要</span></span><br><span class="line">            summary = <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">str</span>(items[<span class="number">6</span>]) != <span class="string">&quot;nan&quot;</span>:</span><br><span class="line">                summary = items[<span class="number">6</span>]</span><br><span class="line">            data[<span class="string">&quot;摘要&quot;</span>].append(summary)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 收入</span></span><br><span class="line">            revenue = <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">str</span>(items[<span class="number">7</span>]) != <span class="string">&quot;nan&quot;</span>:</span><br><span class="line">                revenue = items[<span class="number">7</span>]</span><br><span class="line">            data[<span class="string">&quot;收入&quot;</span>].append(revenue)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 支出</span></span><br><span class="line">            spend = <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">str</span>(items[<span class="number">8</span>]) != <span class="string">&quot;nan&quot;</span>:</span><br><span class="line">                spend = items[<span class="number">8</span>]</span><br><span class="line">            data[<span class="string">&quot;支出&quot;</span>].append(spend)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 余额</span></span><br><span class="line">            balance = <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">str</span>(items[<span class="number">9</span>]) != <span class="string">&quot;nan&quot;</span>:</span><br><span class="line">                balance = items[<span class="number">9</span>]</span><br><span class="line">            data[<span class="string">&quot;余额&quot;</span>].append(balance)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 生成的文件名</span></span><br><span class="line">        file_name = year + month + <span class="string">&quot;.xlsx&quot;</span></span><br><span class="line">        <span class="keyword">return</span> file_name, data</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">sum_data</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">       新增统计处理的数据，最终给pd.DataFrame使用</span></span><br><span class="line"><span class="string">       :param data: list|表示处理好的数据，给pd.DataFrame使用，格式 &#123;&quot;金额&quot;:[1,2,3],&quot;收入&quot;:[]&#125;</span></span><br><span class="line"><span class="string">       :return: list</span></span><br><span class="line"><span class="string">       &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">            <span class="comment"># 插入一行空行</span></span><br><span class="line">            data[i].append(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 手动合计拿货吨位、卖出吨位、收入、支出、余额</span></span><br><span class="line">        data[<span class="string">&quot;日期&quot;</span>].append(<span class="string">&quot;合计&quot;</span>)</span><br><span class="line">        <span class="comment"># data[&quot;拿货吨位&quot;].append(sum(map(float,data[&quot;拿货吨位&quot;])))</span></span><br><span class="line">        data[<span class="string">&quot;拿货吨位&quot;</span>].append(<span class="built_in">sum</span>(data[<span class="string">&quot;拿货吨位&quot;</span>]))</span><br><span class="line">        data[<span class="string">&quot;卖出吨位&quot;</span>].append(<span class="built_in">sum</span>(data[<span class="string">&quot;卖出吨位&quot;</span>]))</span><br><span class="line">        data[<span class="string">&quot;收入&quot;</span>].append(<span class="built_in">sum</span>(data[<span class="string">&quot;收入&quot;</span>]))</span><br><span class="line">        data[<span class="string">&quot;支出&quot;</span>].append(<span class="built_in">sum</span>(data[<span class="string">&quot;支出&quot;</span>]))</span><br><span class="line">        data[<span class="string">&quot;余额&quot;</span>].append(<span class="built_in">sum</span>(data[<span class="string">&quot;余额&quot;</span>]))</span><br><span class="line">        <span class="comment"># 对手动合计拿货吨位、卖出吨位、收入、支出、余额、日期之外的合计行，写入空值</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">            <span class="keyword">if</span> i <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">&quot;日期&quot;</span>, <span class="string">&quot;拿货吨位&quot;</span>, <span class="string">&quot;卖出吨位&quot;</span>, <span class="string">&quot;收入&quot;</span>, <span class="string">&quot;支出&quot;</span>, <span class="string">&quot;余额&quot;</span>]:</span><br><span class="line">                data[i].append(<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 如果数据为0，填入到excel中不美观，因此改为”“，默认填进去就是不可见</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> data:</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data[j])):</span><br><span class="line">                <span class="keyword">if</span> data[j][k] == <span class="number">0</span>:</span><br><span class="line">                    data[j][k] = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_excel</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        重新生成excel</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        g_data = self.get_data()</span><br><span class="line">        <span class="comment"># 得到要保存的文件名</span></span><br><span class="line">        file_name = g_data[<span class="number">0</span>]</span><br><span class="line">        <span class="comment"># 得到处理好的数据，不包括统计</span></span><br><span class="line">        l_data = g_data[<span class="number">1</span>]</span><br><span class="line">        <span class="comment"># 得到处理好的数据，包括统计</span></span><br><span class="line">        s_data = self.sum_data(l_data)</span><br><span class="line">        info_marks = pd.DataFrame(s_data)</span><br><span class="line">        writer = pd.ExcelWriter(file_name)</span><br><span class="line">        info_marks.to_excel(writer, index=<span class="literal">False</span>)</span><br><span class="line">        writer.save()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;生成excel成功，文件名为：%s&#x27;</span> % file_name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    file_path = <span class="string">&#x27;XXXX.xls&#x27;</span></span><br><span class="line">    o_excel = OperateExcel(file_path)</span><br><span class="line">    o_excel.generate_excel()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>取头部要取两行</li>
<li>注意nan的处理</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/11/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/page/13/">13</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" href="/page/13/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">


    <div class="sidebar-inner">



      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt=""
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description">一个正经的测试工程师</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">167</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">68</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Louis-me" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Louis-me" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:shikun.job@foxmail.com" title="E-Mail → mailto:shikun.job@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>
  <!-- 标签云 -->

<script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script>
<script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script>
<div class="widget-wrap">
    <!--<h3 class="widget-title">Tag Cloud</h3> -->
    <div id="myCanvasContainer" class="widget tagcloud">
        <canvas width="250" height="250" id="resCanvas" style="width=100%">
            <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AWVS/" rel="tag">AWVS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/" rel="tag">Android</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Burp-Site/" rel="tag">Burp Site</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DVWA/" rel="tag">DVWA</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dependency-Check/" rel="tag">Dependency-Check</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/H5/" rel="tag">H5</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hadoop/" rel="tag">Hadoop</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hibernate/" rel="tag">Hibernate</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hive/" rel="tag">Hive</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jenkins/" rel="tag">Jenkins</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Metasploit/" rel="tag">Metasploit</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MyBatis/" rel="tag">MyBatis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nessus/" rel="tag">Nessus</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sonic/" rel="tag">Sonic</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/airtest/" rel="tag">airtest</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/" rel="tag">android</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/" rel="tag">android性能测试</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/app%E5%AE%89%E5%85%A8%E6%B5%8B%E8%AF%95/" rel="tag">app安全测试</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/aritest/" rel="tag">aritest</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/centos/" rel="tag">centos</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/chrome/" rel="tag">chrome</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/datax/" rel="tag">datax</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/django/" rel="tag">django</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/drozer/" rel="tag">drozer</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fisco-bcos/" rel="tag">fisco-bcos</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flink/" rel="tag">flink</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gin/" rel="tag">gin</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/" rel="tag">go</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go-zero/" rel="tag">go-zero</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hive/" rel="tag">hive</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/httprunner/" rel="tag">httprunner</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a><span class="tag-list-count">22</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jmeter/" rel="tag">jmeter</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kafka/" rel="tag">kafka</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kail/" rel="tag">kail</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leetcode/" rel="tag">leetcode</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leetcode-%E6%95%B0%E7%BB%84/" rel="tag">leetcode-数组</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mitmproxy/" rel="tag">mitmproxy</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mongodb/" rel="tag">mongodb</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/monkey/" rel="tag">monkey</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/orm/" rel="tag">orm</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pandas/" rel="tag">pandas</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pc%E8%87%AA%E5%8A%A8%E5%8C%96/" rel="tag">pc自动化</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/playwright/" rel="tag">playwright</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pytest/" rel="tag">pytest</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a><span class="tag-list-count">23</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/selenium/" rel="tag">selenium</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/" rel="tag">spring</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/springboot/" rel="tag">springboot</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sqlite/" rel="tag">sqlite</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sqlmap/" rel="tag">sqlmap</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tkinter/" rel="tag">tkinter</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue/" rel="tag">vue</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue3/" rel="tag">vue3</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8/" rel="tag">云服务器</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/" rel="tag">区块链</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" rel="tag">大数据</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AE%89%E5%85%A8%E6%B5%8B%E8%AF%95/" rel="tag">安全测试</a><span class="tag-list-count">29</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/" rel="tag">性能测试</a><span class="tag-list-count">17</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%88%AC%E8%99%AB/" rel="tag">爬虫</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag">环境搭建</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/" rel="tag">自动化测试</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%8B%B1%E8%AF%AD%E5%AD%A6%E4%B9%A0/" rel="tag">英语学习</a><span class="tag-list-count">1</span></li></ul>
        </canvas>
    </div>
</div>

</div>
<!-- 标签云 -->
    </div>

  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  <a href="https://beian.miit.gov.cn/" target="_blank">湘ICP备2022002212号-1</a><br />
  <!--
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder"></span>
  -->
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>


        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script src='../../../js/src/av-min.js'></script>
<script src='../../../js/src/Valine.min.js'></script>

<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : true,
      notify     : false,
      appId      : 'mhSm1aOQmnVeiAUJxrsKIFg5-gzGzoHsz',
      appKey     : 'kW6GQVoeJac7wDgKvy9vXhn6',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

  
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
